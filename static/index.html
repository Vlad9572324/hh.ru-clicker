<!DOCTYPE html>
<html lang="ru" id="html-root">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HH Bot Dashboard</title>
<style>
:root {
  --bg: #0d1117;
  --bg-card: #161b22;
  --bg-card2: #1c2128;
  --border: #30363d;
  --green: #3fb950;
  --cyan: #39d0d8;
  --red: #f85149;
  --yellow: #d29922;
  --magenta: #d2a8ff;
  --blue: #79c0ff;
  --dim: #8b949e;
  --text: #e6edf3;
  --tab-active: #21262d;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'JetBrains Mono', 'Consolas', 'Courier New', monospace;
  font-size: 13px;
  min-height: 100vh;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
#header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}
#header h1 { font-size: 15px; font-weight: 700; color: var(--cyan); }
#conn-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--red); transition: background 0.3s;
}
#conn-dot.connected { background: var(--green); }
#uptime { color: var(--dim); font-size: 12px; margin-left: auto; }
#global-sent { color: var(--green); font-weight: 700; }
#global-found { color: var(--cyan); }
#storage-total { color: var(--blue); }
#pause-btn {
  padding: 4px 14px;
  border: 1px solid var(--border);
  background: var(--bg-card2);
  color: var(--text);
  cursor: pointer;
  border-radius: 4px;
  font-family: inherit;
  font-size: 12px;
}
#pause-btn:hover { border-color: var(--yellow); color: var(--yellow); }
#pause-btn.paused { border-color: var(--red); color: var(--red); }

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
#tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  background: var(--bg-card);
  padding: 0 16px;
  gap: 2px;
}
.tab {
  padding: 8px 16px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  color: var(--dim);
  font-size: 12px;
  white-space: nowrap;
  transition: color 0.2s;
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }

/* ‚îÄ‚îÄ Tab panels ‚îÄ‚îÄ */
.panel { display: none; padding: 16px; }
.panel.active { display: block; }

/* ‚îÄ‚îÄ Main tab layout ‚îÄ‚îÄ */
#main-layout {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 12px;
}
#accounts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 12px;
}
#sidebar { display: flex; flex-direction: column; gap: 12px; }

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
}
.card-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ‚îÄ‚îÄ Account card ‚îÄ‚îÄ */
.acc-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
  transition: border-color 0.2s;
}
.acc-card.color-cyan  { border-left: 3px solid var(--cyan); }
.acc-card.color-magenta { border-left: 3px solid var(--magenta); }
.acc-card.color-green  { border-left: 3px solid var(--green); }
.acc-card.color-yellow { border-left: 3px solid var(--yellow); }

.acc-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
.acc-name { font-weight: 700; font-size: 14px; }
.acc-status-badge {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 20px;
  border: 1px solid;
  margin-left: auto;
}
.status-idle { color: var(--dim); border-color: var(--dim); }
.status-collecting { color: var(--cyan); border-color: var(--cyan); }
.status-applying { color: var(--green); border-color: var(--green); }
.status-limit { color: var(--red); border-color: var(--red); }
.status-waiting { color: var(--yellow); border-color: var(--yellow); }
.status-checking { color: var(--cyan); border-color: var(--cyan); }

.acc-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  margin-bottom: 10px;
}
.stat-box {
  background: var(--bg-card2);
  border-radius: 4px;
  padding: 6px;
  text-align: center;
}
.stat-val { font-size: 18px; font-weight: 700; }
.stat-lbl { font-size: 10px; color: var(--dim); }

.acc-vacancy {
  background: var(--bg-card2);
  border-radius: 4px;
  padding: 8px;
  margin-bottom: 8px;
  min-height: 46px;
}
.acc-vacancy-title { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.acc-vacancy-company { font-size: 11px; color: var(--dim); }

.progress-bar-wrap {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 8px;
}
.progress-bar-fill {
  height: 100%;
  background: var(--green);
  border-radius: 2px;
  transition: width 0.3s;
}

.acc-meta {
  display: flex;
  gap: 10px;
  font-size: 11px;
  color: var(--dim);
  margin-bottom: 6px;
}
.acc-hh-stats {
  font-size: 11px;
  background: var(--bg-card2);
  border-radius: 4px;
  padding: 6px 8px;
  margin-bottom: 6px;
}
.acc-history { font-size: 11px; color: var(--dim); }
.acc-event-log {
  margin-top: 8px;
  border-top: 1px solid var(--border);
  padding-top: 6px;
  max-height: 130px;
  overflow-y: auto;
}
.acc-elog-entry {
  display: flex;
  align-items: flex-start;
  gap: 5px;
  font-size: 11px;
  line-height: 1.45;
  padding: 2px 0;
  border-bottom: 1px solid rgba(48,54,61,0.5);
}
.acc-elog-entry:last-child { border-bottom: none; }
.acc-elog-time { color: var(--dim); flex-shrink: 0; min-width: 38px; }
.acc-elog-icon { flex-shrink: 0; }
.acc-elog-body { flex: 1; overflow: hidden; }
.acc-elog-title { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.acc-elog-extra { color: var(--dim); font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.acc-skip-tests {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--dim);
  cursor: pointer;
  user-select: none;
  margin-top: 6px;
}
.acc-skip-tests input[type=checkbox] { accent-color: var(--yellow); cursor: pointer; }
.acc-skip-tests.active { color: var(--yellow); }
.acc-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}
.acc-letter-wrap {
  margin-top: 8px;
  border-top: 1px solid var(--border);
  padding-top: 6px;
}
.acc-letter-wrap summary {
  cursor: pointer;
  font-size: 11px;
  color: var(--dim);
  user-select: none;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 4px;
}
.acc-letter-wrap summary::-webkit-details-marker { display: none; }
.acc-letter-wrap[open] summary { color: var(--cyan); }
.acc-letter-body { padding-top: 8px; }
.btn-sm {
  padding: 3px 10px;
  border: 1px solid var(--border);
  background: var(--bg-card2);
  color: var(--text);
  cursor: pointer;
  border-radius: 4px;
  font-family: inherit;
  font-size: 11px;
}
.btn-sm:hover { border-color: var(--cyan); color: var(--cyan); }
.btn-sm.paused { border-color: var(--red); color: var(--red); }

/* ‚îÄ‚îÄ Global stats card ‚îÄ‚îÄ */
.global-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px; }
.global-row .lbl { color: var(--dim); }

/* ‚îÄ‚îÄ Recent responses ‚îÄ‚îÄ */
.resp-item {
  display: flex;
  gap: 6px;
  align-items: flex-start;
  padding: 5px 0;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
}
.resp-item:last-child { border-bottom: none; }
.resp-time { color: var(--dim); flex-shrink: 0; }
.resp-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.resp-company { color: var(--dim); font-size: 10px; }

/* ‚îÄ‚îÄ Log panel ‚îÄ‚îÄ */
#log-panel { max-height: calc(100vh - 160px); overflow-y: auto; }
#log-list { display: flex; flex-direction: column; gap: 2px; }
.log-item {
  display: flex;
  gap: 8px;
  padding: 3px 0;
  border-bottom: 1px solid #1a2030;
  font-size: 12px;
  align-items: baseline;
}
.log-time { color: var(--dim); flex-shrink: 0; font-size: 11px; }
.log-acc { flex-shrink: 0; font-size: 11px; min-width: 60px; }
.log-msg { flex: 1; word-break: break-word; }
.log-info { color: var(--text); }
.log-success { color: var(--green); }
.log-warning { color: var(--yellow); }
.log-error { color: var(--red); }

/* ‚îÄ‚îÄ Applied / Tests panels ‚îÄ‚îÄ */
#applied-panel, #tests-panel {
  max-height: calc(100vh - 210px);
  overflow-y: auto;
}
.applied-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.applied-filters {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.applied-table tr.row-no-title td { color: var(--dim); }
.applied-table tr.row-no-title td a { color: #4a7fa8; }
.applied-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.applied-table th {
  text-align: left;
  padding: 6px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--dim);
  font-weight: 600;
  background: var(--bg-card);
  position: sticky;
  top: 0;
}
.applied-table td {
  padding: 5px 10px;
  border-bottom: 1px solid #1a2030;
  vertical-align: top;
}
.applied-table tr:hover td { background: var(--bg-card2); }
.applied-table a { color: var(--cyan); text-decoration: none; }
.applied-table a:hover { text-decoration: underline; }

/* ‚îÄ‚îÄ LLM Log Tab ‚îÄ‚îÄ */
#panel-llm.active { padding: 16px; display: block !important; }
.llm-msg-cell { max-width: 260px; white-space: pre-wrap; word-break: break-word; font-size:11px; color: var(--dim); }
.llm-reply-cell { max-width: 280px; white-space: pre-wrap; word-break: break-word; font-size:11px; color: var(--text); }
.llm-sent-badge { font-size:11px; color: var(--green); font-weight:600; }
.llm-draft-badge { font-size:11px; color: var(--yellow); font-weight:600; }
.llm-toggle-btn { font-size:10px; padding:1px 6px; border-radius:3px; border:1px solid currentColor; cursor:pointer; background:transparent; }
.llm-toggle-btn.llm-on { color:var(--cyan); }
.llm-toggle-btn.llm-off { color:var(--dim); }
/* ‚îÄ‚îÄ LLM Profile Rows ‚îÄ‚îÄ */
.llm-profile-row { background:var(--bg-card); border:1px solid var(--border); border-radius:6px; padding:10px 12px; display:flex; flex-direction:column; gap:6px; }
.llm-profile-row.disabled { opacity:0.5; }
.llm-profile-row-header { display:flex; gap:8px; align-items:center; }
.llm-profile-fields { display:grid; grid-template-columns:1fr 1fr; gap:6px; }

/* ‚îÄ‚îÄ HH Status panel ‚îÄ‚îÄ */
#hh-panel { max-height: calc(100vh - 160px); overflow-y: auto; overflow-x: hidden; }
.hh-account-block { overflow: hidden; }
.hh-account-block {
  background: var(--bg-card);
  border-radius: 6px;
  padding: 14px;
  margin-bottom: 12px;
}
.hh-account-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.hh-counters {
  display: flex;
  gap: 16px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.hh-counter { text-align: center; }
.hh-counter-val { font-size: 28px; font-weight: 700; }
.hh-counter-lbl { font-size: 11px; color: var(--dim); }
.hh-interview-item {
  padding: 6px 0;
  border-bottom: 1px solid #1a2030;
  font-size: 12px;
  line-height: 1.5;
  overflow-wrap: break-word;
  word-break: break-word;
  white-space: normal;
}
.hh-interview-date { color: var(--dim); font-size: 11px; margin-right: 6px; }
.hh-interview-text { }
a.hh-interview-text { color: var(--cyan); text-decoration: none; }
a.hh-interview-text:hover { text-decoration: underline; }
.hh-offer-item {
  padding: 5px 0;
  border-bottom: 1px solid #1a2030;
  font-size: 12px;
}
.hh-offer-name { color: var(--cyan); font-weight: 600; }
.hh-offer-vacs { color: var(--dim); font-size: 11px; }

/* ‚îÄ‚îÄ Settings panel ‚îÄ‚îÄ */
#settings-panel .settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  max-width: 900px;
}
.setting-row {
  background: var(--bg-card);
  border-radius: 6px;
  padding: 14px;
}
.setting-label { font-size: 12px; margin-bottom: 6px; display: flex; justify-content: space-between; }
.setting-label span { color: var(--cyan); font-weight: 700; font-size: 14px; }
.setting-desc { font-size: 11px; color: var(--dim); margin-bottom: 10px; }
input[type=range] {
  width: 100%;
  accent-color: var(--cyan);
  cursor: pointer;
}
#settings-apply {
  margin-top: 16px;
  padding: 8px 24px;
  background: var(--cyan);
  color: #000;
  border: none;
  border-radius: 4px;
  font-family: inherit;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
}
#settings-apply:hover { opacity: 0.85; }
#settings-status { margin-top: 8px; font-size: 12px; color: var(--green); }

/* ‚îÄ‚îÄ Views tab ‚îÄ‚îÄ */
.views-stat-card {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 14px 20px;
  min-width: 130px;
  text-align: center;
  border: 1px solid var(--border);
}
.views-stat-val { font-size: 26px; font-weight: 700; }
.views-stat-lbl { font-size: 11px; color: var(--dim); margin-top: 2px; }
.views-acc-block { margin-bottom: 24px; }
.views-acc-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; display:flex; align-items:center; gap:12px; }
.views-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.views-table th { text-align: left; color: var(--dim); padding: 6px 10px; border-bottom: 1px solid var(--border); font-weight: 400; }
.views-table td { padding: 6px 10px; border-bottom: 1px solid var(--border); }
.views-table tr:hover td { background: var(--bg-card); }
.views-table a { color: var(--cyan); text-decoration: none; }
.views-table a:hover { text-decoration: underline; }
.acc-resume-stats { font-size: 11px; color: var(--dim); margin-top: 6px; display:flex; flex-wrap:wrap; gap:8px; }
.acc-resume-stat { background: var(--bg); border-radius: 4px; padding: 3px 8px; }
.acc-touch-timer { font-size: 11px; padding: 3px 8px; border-radius: 4px; }
.touch-toggle { display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; font-size:12px; padding:3px 8px; border-radius:6px; border:1px solid var(--border); background:var(--bg); transition:border-color 0.2s; }
.touch-toggle:hover { border-color: var(--dim); }
.touch-toggle.on { border-color: var(--green); color: var(--green); }
.touch-toggle.off { border-color: var(--border); color: var(--dim); }
.touch-toggle .tgl-dot { width:22px; height:12px; border-radius:6px; background:#444c56; display:inline-block; position:relative; transition:background 0.2s; flex-shrink:0; }
.touch-toggle.on .tgl-dot { background: var(--green); }
.touch-toggle .tgl-dot::after { content:''; position:absolute; width:8px; height:8px; border-radius:50%; background:#fff; top:2px; left:2px; transition:left 0.2s; }
.touch-toggle.on .tgl-dot::after { left:12px; }

/* ‚îÄ‚îÄ Apply tab ‚îÄ‚îÄ */
#panel-apply.active { padding: 20px; display: flex !important; flex-direction: column; gap: 20px; }
.session-block {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.session-summary {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  color: var(--cyan);
  user-select: none;
  list-style: none;
}
.session-summary::-webkit-details-marker { display: none; }
.session-body {
  padding: 0 16px 16px;
  border-top: 1px solid var(--border);
}
.session-active-list { display: flex; flex-direction: column; gap: 8px; }
.session-card {
  background: var(--bg-card);
  border: 1px solid var(--yellow);
  border-radius: 8px;
  padding: 12px 16px;
  display: flex; flex-direction: column; gap: 8px;
}
.session-card-header { display: flex; align-items: center; gap: 8px; }
.session-item {
  display: flex; align-items: center; gap: 10px;
  padding: 6px 0; border-bottom: 1px solid var(--border);
  font-size: 12px;
}
.session-item:last-child { border-bottom: none; }
.apply-form {
  max-width: 720px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.apply-row { display: flex; flex-direction: column; gap: 6px; }
.apply-label { font-size: 12px; color: var(--dim); }
.apply-input {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  padding: 10px 12px;
  width: 100%;
  box-sizing: border-box;
}
.apply-input:focus { outline: none; border-color: var(--cyan); }
select.apply-input { cursor: pointer; }
textarea.apply-input { min-height: 120px; resize: vertical; }
.apply-btn {
  padding: 10px 28px;
  background: var(--cyan);
  color: #000;
  border: none;
  border-radius: 6px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  align-self: flex-start;
}
.apply-btn:hover { opacity: 0.85; }
.apply-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.apply-btn-secondary {
  padding: 10px 28px;
  background: transparent;
  color: var(--cyan);
  border: 1px solid var(--cyan);
  border-radius: 6px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
}
.apply-btn-secondary:hover { background: var(--cyan); color: #000; }
.apply-result {
  padding: 14px 16px;
  border-radius: 8px;
  font-size: 13px;
  border: 1px solid var(--border);
}
.apply-result.ok   { border-color: var(--green); background: rgba(63,185,80,.08); }
.apply-result.err  { border-color: var(--red);   background: rgba(248,81,73,.08); }
.apply-result.warn { border-color: var(--yellow); background: rgba(210,153,34,.08); }
.apply-result.info { border-color: var(--cyan);  background: rgba(88,166,255,.08); }
.apply-q-list { display: flex; flex-direction: column; gap: 14px; margin-top: 4px; }
.apply-q-item {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 14px;
  border: 1px solid var(--border);
}
.apply-q-text { font-size: 13px; margin-bottom: 10px; line-height: 1.5; }
.apply-q-num  { font-size: 11px; color: var(--dim); margin-bottom: 6px; }
.apply-radio-opts { display: flex; gap: 10px; flex-wrap: wrap; }
.apply-radio-opt { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; }
.apply-radio-opt input { accent-color: var(--cyan); cursor: pointer; }
textarea.apply-q-answer {
  width: 100%;
  min-height: 70px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-family: inherit;
  font-size: 12px;
  padding: 8px 10px;
  box-sizing: border-box;
  resize: vertical;
}
textarea.apply-q-answer:focus { outline: none; border-color: var(--cyan); }
.apply-vacancy-info {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 14px;
  border-left: 3px solid var(--cyan);
  font-size: 13px;
}
.apply-vacancy-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
.apply-divider { border: none; border-top: 1px solid var(--border); margin: 8px 0; }
.apply-btn-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

/* ‚îÄ‚îÄ Progress bar on card ‚îÄ‚îÄ */
.acc-progress { height: 3px; background: var(--border); border-radius: 2px; margin: 4px 0 2px; }
.acc-progress-fill { height: 100%; background: var(--cyan); border-radius: 2px; width: 0%; transition: width 0.4s; }
.acc-progress-fill.applying { background: var(--green); }
.acc-progress-fill.limit { background: var(--red); }

/* ‚îÄ‚îÄ Expired cookies badge ‚îÄ‚îÄ */
.cookies-expired-badge {
  display: inline-block;
  background: var(--yellow); color: #000;
  padding: 2px 7px; border-radius: 4px;
  font-size: 11px; font-weight: 700;
  margin: 3px 0 2px; animation: pulse 1.5s ease-in-out infinite;
}

/* ‚îÄ‚îÄ Compact card mode ‚îÄ‚îÄ */
.compact-btn {
  background: none; border: none; color: var(--dim); cursor: pointer;
  font-size: 12px; padding: 0 4px; line-height: 1; flex-shrink: 0;
}
.compact-btn:hover { color: var(--text); }
.acc-card.compact .acc-event-log,
.acc-card.compact .acc-skip-tests,
.acc-card.compact .acc-letter-wrap,
.acc-card.compact .acc-url-wrap,
.acc-card.compact .acc-resume-stats,
.acc-card.compact .acc-history { display: none !important; }
.acc-card.compact .acc-actions { flex-wrap: wrap; gap: 4px; }

/* ‚îÄ‚îÄ Dark confirm dialog ‚îÄ‚îÄ */
.confirm-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.65);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999; animation: fadeIn 0.15s;
}
.confirm-box {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 8px; padding: 24px 28px; max-width: 400px; width: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.confirm-box p { margin-bottom: 18px; line-height: 1.5; }
.confirm-btns { display: flex; gap: 10px; justify-content: flex-end; }
.confirm-ok { background: var(--red); color: #fff; border: none; padding: 7px 20px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 13px; }
.confirm-ok:hover { opacity: 0.85; }
.confirm-cancel { background: var(--bg-card2); color: var(--text); border: 1px solid var(--border); padding: 7px 20px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 13px; }
.confirm-cancel:hover { border-color: var(--text); }
@keyframes fadeIn { from { opacity:0 } to { opacity:1 } }

/* ‚îÄ‚îÄ Log filters ‚îÄ‚îÄ */
#log-filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; padding: 8px 16px; border-bottom: 1px solid var(--border); background: var(--bg-card); }
.log-level-btn { padding: 2px 10px; border-radius: 12px; border: 1px solid var(--border); background: none; color: var(--dim); font-family: inherit; font-size: 11px; cursor: pointer; }
.log-level-btn.active { border-color: var(--cyan); color: var(--cyan); }
.log-level-btn.active.err { border-color: var(--red); color: var(--red); }
.log-level-btn.active.ok  { border-color: var(--green); color: var(--green); }
.log-level-btn.active.warn { border-color: var(--yellow); color: var(--yellow); }

/* ‚îÄ‚îÄ Sortable table headers ‚îÄ‚îÄ */
.sort-th { cursor: pointer; user-select: none; white-space: nowrap; }
.sort-th:hover { color: var(--cyan); }
.sort-th .sort-arrow { font-size: 10px; margin-left: 3px; opacity: 0.5; }
.sort-th.sorted .sort-arrow { opacity: 1; color: var(--cyan); }

/* ‚îÄ‚îÄ Keyboard shortcut help ‚îÄ‚îÄ */
.shortcuts-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: flex; align-items: center; justify-content: center; z-index: 9999;
}
.shortcuts-box {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 8px; padding: 24px 32px; min-width: 320px;
}
.shortcuts-box h3 { margin-bottom: 14px; color: var(--cyan); }
.shortcuts-box table { border-collapse: collapse; width: 100%; }
.shortcuts-box td { padding: 4px 10px; font-size: 12px; }
.shortcuts-box td:first-child { color: var(--yellow); font-weight: 700; min-width: 60px; }
.shortcuts-box td:last-child { color: var(--dim); }

/* ‚îÄ‚îÄ Questionnaire / Settings sections ‚îÄ‚îÄ */
.q-section {
  max-width: 900px;
  margin-top: 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  border-left-width: 4px;
  background: var(--bg-card);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.q-section[open] { box-shadow: 0 2px 12px rgba(0,0,0,0.3); }

/* Priority colors */
.prio-critical { border-left-color: var(--red); }
.prio-critical > summary { background: rgba(248,81,73,0.06); }
.prio-high     { border-left-color: var(--yellow); }
.prio-high     > summary { background: rgba(210,153,34,0.06); }
.prio-medium   { border-left-color: var(--cyan); }
.prio-medium   > summary { background: rgba(57,208,216,0.06); }
.prio-low      { border-left-color: var(--green); }
.prio-low      > summary { background: rgba(63,185,80,0.06); }
.prio-optional { border-left-color: #444c56; }
.prio-optional > summary { background: rgba(139,148,158,0.05); }

/* Collapsible summary header */
.q-section > summary.q-section-title {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  cursor: pointer;
  user-select: none;
  list-style: none;
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  border-bottom: 1px solid transparent;
  border-radius: 8px;
  transition: background 0.15s;
}
.q-section[open] > summary.q-section-title {
  border-bottom-color: var(--border);
  border-radius: 8px 8px 0 0;
}
.q-section > summary.q-section-title::-webkit-details-marker { display: none; }
.q-section > summary.q-section-title::before {
  content: '‚ñ∂';
  font-size: 9px;
  color: var(--dim);
  transition: transform 0.2s;
  flex-shrink: 0;
}
.q-section[open] > summary.q-section-title::before { transform: rotate(90deg); }

/* Priority badge inside summary */
.prio-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 1px 7px;
  border-radius: 10px;
  margin-left: auto;
  white-space: nowrap;
  flex-shrink: 0;
}
.prio-critical .prio-badge { background: rgba(248,81,73,0.2); color: var(--red); }
.prio-high     .prio-badge { background: rgba(210,153,34,0.2); color: var(--yellow); }
.prio-medium   .prio-badge { background: rgba(57,208,216,0.2); color: var(--cyan); }
.prio-low      .prio-badge { background: rgba(63,185,80,0.2); color: var(--green); }
.prio-optional .prio-badge { background: rgba(139,148,158,0.12); color: var(--dim); }

/* Section body padding */
.q-section-body { padding: 16px; }

/* Legacy non-details q-section-title fallback */
.q-section-title-plain { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--cyan); }
.q-templates { display: flex; flex-direction: column; gap: 10px; }
.q-template-row {
  background: var(--bg-card);
  border-radius: 6px;
  padding: 12px;
  border: 1px solid var(--border);
}
.q-template-row label { font-size: 11px; color: var(--dim); display: block; margin-bottom: 4px; }
.q-keywords-input, .q-answer-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-family: inherit;
  font-size: 12px;
  padding: 6px 8px;
  box-sizing: border-box;
  resize: vertical;
}
.q-keywords-input { margin-bottom: 6px; }
.q-answer-input { min-height: 60px; }
.q-default-row { background: var(--bg-card); border-radius: 6px; padding: 12px; margin-top: 12px; }
.q-btn-row { display: flex; gap: 8px; margin-top: 12px; }
.q-btn {
  padding: 6px 16px; background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text); font-family: inherit; font-size: 12px; cursor: pointer;
}
.q-btn:hover { border-color: var(--cyan); color: var(--cyan); }
.q-btn-save {
  padding: 8px 24px; background: var(--cyan); color: #000;
  border: none; border-radius: 4px; font-family: inherit; font-size: 13px;
  font-weight: 700; cursor: pointer;
}
.q-btn-save:hover { opacity: 0.85; }
.q-status { margin-top: 8px; font-size: 12px; color: var(--green); }
.q-del { float: right; background: none; border: none; color: var(--dim); cursor: pointer; font-size: 14px; }
.q-del:hover { color: var(--red); }

/* ‚îÄ‚îÄ Color helpers ‚îÄ‚îÄ */
.c-green { color: var(--green); }
.c-red { color: var(--red); }
.c-yellow { color: var(--yellow); }
.c-cyan { color: var(--cyan); }
.c-magenta { color: var(--magenta); }
.c-blue { color: var(--blue); }
.c-dim { color: var(--dim); }

/* ‚îÄ‚îÄ Refresh btn ‚îÄ‚îÄ */
.btn-refresh {
  padding: 4px 12px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--dim);
  cursor: pointer;
  border-radius: 4px;
  font-family: inherit;
  font-size: 11px;
}
.btn-refresh:hover { color: var(--cyan); border-color: var(--cyan); }

/* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--dim); }
</style>
</head>
<body>

<!-- Header -->
<div id="header">
  <div id="conn-dot" title="WebSocket connection"></div>
  <h1>ü§ñ HH Bot Dashboard</h1>
  <div style="color:var(--dim);font-size:11px">
    üîç <span id="global-found">0</span> <span data-i18n="hdr_found">–Ω–∞–π–¥–µ–Ω–æ</span> &nbsp;
    ‚úÖ <span id="global-sent">0</span> <span data-i18n="hdr_replies">–æ—Ç–∫–ª–∏–∫–æ–≤</span> &nbsp;
    üíæ <span id="storage-total">0</span> <span data-i18n="hdr_in_db">–≤ –±–∞–∑–µ</span> &nbsp;
    üß™ <span id="storage-tests">0</span> <span data-i18n="hdr_tests">—Ç–µ—Å—Ç–æ–≤</span>
  </div>
  <div id="hdr-resume-stats" style="color:var(--dim);font-size:11px;display:none">
    üëÅÔ∏è <span id="hdr-views-new" class="c-cyan">0</span> <span data-i18n="hdr_new_views">–Ω–æ–≤—ã—Ö –ø—Ä–æ—Å–º.</span> &nbsp;
    üì¨ <span id="hdr-inv-new" class="c-green">0</span> <span data-i18n="hdr_new_inv">–Ω–æ–≤—ã—Ö –ø—Ä–∏–≥–ª–∞—à.</span> &nbsp;
    üîé <span id="hdr-shows" style="color:var(--dim)">0</span> <span data-i18n="hdr_shows">–ø–æ–∫–∞–∑–æ–≤</span>
  </div>
  <div id="uptime">‚è± 00:00</div>
  <div id="dbg-err" style="display:none;color:#f85149;font-size:11px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
  <button id="lang-btn" onclick="toggleLang()" style="padding:4px 10px;border:1px solid var(--border);background:var(--bg-card2);color:var(--dim);cursor:pointer;border-radius:4px;font-family:inherit;font-size:11px" title="Switch language">RU</button>
  <button id="pause-btn" onclick="sendCmd({type:'pause_toggle'})">‚è∏ –ü–∞—É–∑–∞</button>
</div>

<!-- Tabs -->
<div id="tabs">
  <div class="tab active" data-tab="main" data-i18n="tab_main">üìä –ì–ª–∞–≤–Ω–∞—è</div>
  <div class="tab" data-tab="log" data-i18n="tab_log">üìú –õ–æ–≥</div>
  <div class="tab" data-tab="applied" data-i18n="tab_applied">‚úÖ –û—Ç–∫–ª–∏–∫–∏</div>
  <div class="tab" data-tab="tests" data-i18n="tab_tests">üß™ –¢–µ—Å—Ç—ã</div>
  <div class="tab" data-tab="db" data-i18n="tab_db">üìÇ –ë–∞–∑–∞</div>
  <div class="tab" data-tab="hh" data-i18n="tab_hh">üéØ HH –°—Ç–∞—Ç—É—Å</div>
  <div class="tab" data-tab="views" data-i18n="tab_views">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
  <div class="tab" data-tab="apply" data-i18n="tab_apply">üöÄ –û—Ç–∫–ª–∏–∫</div>
  <div class="tab" data-tab="llm" data-i18n="tab_llm">ü§ñ LLM –û—Ç–≤–µ—Ç—ã</div>
  <div class="tab" data-tab="settings" data-i18n="tab_settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>

<!-- Main Tab -->
<div id="panel-main" class="panel active">
  <div id="main-layout">
    <div id="accounts-grid"></div>
    <div id="sidebar">
      <!-- Global stats -->
      <div class="card" id="global-stats-card">
        <div class="card-title" data-i18n="gs_session">üìä –°–µ—Å—Å–∏—è</div>
        <div id="global-stats-body"></div>
      </div>
      <!-- Recent responses -->
      <div class="card" style="flex:1;overflow:hidden">
        <div class="card-title" data-i18n="sidebar_recent">üì¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∏</div>
        <div id="recent-list" style="overflow-y:auto;max-height:320px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Log Tab -->
<div id="panel-log" class="panel" style="padding:0">
  <div id="log-filters">
    <input id="log-search" class="apply-input" type="text" placeholder="üîç –ü–æ–∏—Å–∫..." data-i18n-ph="log_search_ph" style="width:200px;font-size:11px;padding:3px 8px" oninput="renderLog(State.lastSnapshot)">
    <select id="log-acc-filter" class="apply-input" style="font-size:11px;padding:3px 6px" onchange="renderLog(State.lastSnapshot)">
      <option value="" data-i18n="log_all_accs">–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</option>
    </select>
    <button class="log-level-btn active" data-level="" onclick="logSetLevel(this,'')" data-i18n="log_all">–í—Å–µ</button>
    <button class="log-level-btn ok"   data-level="success" onclick="logSetLevel(this,'success')">‚úÖ</button>
    <button class="log-level-btn warn" data-level="warning" onclick="logSetLevel(this,'warning')">‚ö†Ô∏è</button>
    <button class="log-level-btn err"  data-level="error"   onclick="logSetLevel(this,'error')">‚ùå</button>
    <button class="log-level-btn"      data-level="info"    onclick="logSetLevel(this,'info')">‚ÑπÔ∏è</button>
    <span id="log-count" style="font-size:11px;color:var(--dim);margin-left:auto"></span>
  </div>
  <div id="log-panel" style="padding:16px">
    <div id="log-list"></div>
  </div>
</div>

<!-- Applied Tab -->
<div id="panel-applied" class="panel">
  <div class="applied-header">
    <div style="font-size:14px;font-weight:700"><span data-i18n="applied_title">‚úÖ –û—Ç–∫–ª–∏–∫–∏</span> <span id="applied-count" class="c-green"></span></div>
    <div style="display:flex;gap:6px">
      <button class="btn-refresh" onclick="exportAppliedCSV()">‚¨áÔ∏è CSV</button>
      <button class="btn-refresh" onclick="loadApplied(true)">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>
  <div class="applied-filters">
    <input id="applied-search" class="apply-input" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é / –∫–æ–º–ø–∞–Ω–∏–∏..."
      data-i18n-ph="applied_search_ph" style="flex:1;min-width:180px" oninput="appliedRender()">
    <select id="applied-acc-filter" class="apply-input" style="min-width:140px" onchange="appliedRender()">
      <option value="" data-i18n="applied_all_accs">–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</option>
    </select>
    <label style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--dim);cursor:pointer;user-select:none">
      <input type="checkbox" id="applied-hide-empty" onchange="appliedRender()" style="accent-color:var(--cyan)">
      <span data-i18n="applied_only_named">–¢–æ–ª—å–∫–æ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º</span>
    </label>
  </div>
  <div id="applied-panel">
    <table class="applied-table">
      <thead><tr>
        <th class="sort-th" onclick="appliedSort('at')" data-i18n="col_date">–î–∞—Ç–∞ <span class="sort-arrow">‚Üï</span></th>
        <th class="sort-th" onclick="appliedSort('account')" data-i18n="col_account">–ê–∫–∫–∞—É–Ω—Ç <span class="sort-arrow">‚Üï</span></th>
        <th class="sort-th" onclick="appliedSort('title')" data-i18n="col_vacancy">–í–∞–∫–∞–Ω—Å–∏—è <span class="sort-arrow">‚Üï</span></th>
        <th class="sort-th" onclick="appliedSort('company')" data-i18n="col_company">–ö–æ–º–ø–∞–Ω–∏—è <span class="sort-arrow">‚Üï</span></th>
        <th class="sort-th" onclick="appliedSort('salary_from')" data-i18n="col_salary">–ó–∞—Ä–ø–ª–∞—Ç–∞ <span class="sort-arrow">‚Üï</span></th>
      </tr></thead>
      <tbody id="applied-tbody"></tbody>
    </table>
    <div id="applied-loadmore" style="display:none;text-align:center;padding:12px">
      <button class="btn-refresh" onclick="appliedShowMore()" data-i18n="btn_show_more">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
      <span id="applied-shown" class="c-dim" style="font-size:11px;margin-left:8px"></span>
    </div>
  </div>
</div>

<!-- Tests Tab -->
<div id="panel-tests" class="panel">
  <div class="applied-header">
    <div style="font-size:14px;font-weight:700"><span data-i18n="tests_title">üß™ –í–∞–∫–∞–Ω—Å–∏–∏ —Å —Ç–µ—Å—Ç–∞–º–∏</span> <span id="tests-count" class="c-magenta"></span></div>
    <button class="btn-refresh" onclick="loadTests()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
  <div id="tests-panel">
    <table class="applied-table">
      <thead><tr>
        <th data-i18n="col_date">–î–∞—Ç–∞</th>
        <th data-i18n="col_vacancy">–í–∞–∫–∞–Ω—Å–∏—è</th>
        <th data-i18n="col_company">–ö–æ–º–ø–∞–Ω–∏—è</th>
        <th data-i18n="col_account">–ê–∫–∫–∞—É–Ω—Ç</th>
        <th data-i18n="col_applied_yn">–û—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å</th>
        <th data-i18n="col_link">–°—Å—ã–ª–∫–∞</th>
      </tr></thead>
      <tbody id="tests-tbody"></tbody>
    </table>
  </div>
</div>

<!-- DB Tab -->
<div id="panel-db" class="panel">
  <div class="applied-header">
    <div style="font-size:14px;font-weight:700"><span data-i18n="db_title">üìÇ –ë–∞–∑–∞ –≤–∞–∫–∞–Ω—Å–∏–π</span> <span id="db-count" class="c-dim"></span></div>
    <div style="display:flex;gap:6px">
      <button class="btn-refresh" onclick="exportDbCSV()">‚¨áÔ∏è CSV</button>
      <button class="btn-refresh" onclick="loadDB(true)">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>
  <div class="applied-filters">
    <input id="db-search" class="apply-input" type="text" placeholder="üîç –ù–∞–∑–≤–∞–Ω–∏–µ / –∫–æ–º–ø–∞–Ω–∏—è / ID..."
      data-i18n-ph="db_search_ph" style="flex:1;min-width:180px" oninput="dbRender()">
    <select id="db-status-filter" class="apply-input" style="min-width:160px" onchange="dbRender()">
      <option value="" data-i18n="db_all_statuses">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="sent" data-i18n="db_status_sent">‚úÖ –û—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å</option>
      <option value="test_passed" data-i18n="db_status_test_passed">üìù –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω</option>
      <option value="test_pending" data-i18n="db_status_test_pending">üß™ –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω</option>
    </select>
    <select id="db-acc-filter" class="apply-input" style="min-width:140px" onchange="dbRender()">
      <option value="" data-i18n="db_all_accs">–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</option>
    </select>
  </div>
  <div id="db-panel" style="max-height:calc(100vh - 220px);overflow-y:auto">
    <table class="applied-table">
      <thead><tr>
        <th class="sort-th" onclick="dbSort('status')" data-i18n="col_status">–°—Ç–∞—Ç—É—Å <span class="sort-arrow">‚Üï</span></th>
        <th class="sort-th" onclick="dbSort('at')" data-i18n="col_date">–î–∞—Ç–∞ <span class="sort-arrow">‚Üï</span></th>
        <th class="sort-th" onclick="dbSort('title')" data-i18n="col_vacancy">–í–∞–∫–∞–Ω—Å–∏—è <span class="sort-arrow">‚Üï</span></th>
        <th class="sort-th" onclick="dbSort('company')" data-i18n="col_company">–ö–æ–º–ø–∞–Ω–∏—è <span class="sort-arrow">‚Üï</span></th>
        <th data-i18n="col_accounts">–ê–∫–∫–∞—É–Ω—Ç—ã</th>
        <th style="width:36px"></th>
      </tr></thead>
      <tbody id="db-tbody"></tbody>
    </table>
    <div id="db-loadmore" style="display:none;text-align:center;padding:12px">
      <button class="btn-refresh" onclick="dbShowMore()" data-i18n="btn_show_more">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
      <span id="db-shown" class="c-dim" style="font-size:11px;margin-left:8px"></span>
    </div>
  </div>
</div>

<!-- HH Status Tab -->
<div id="panel-hh" class="panel">
  <div id="hh-panel">
    <div id="hh-content"></div>
  </div>
</div>

<!-- Views Tab -->
<div id="panel-views" class="panel">
  <div id="views-panel">
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px" id="views-stats-row"></div>
    <div id="views-accounts"></div>
  </div>
</div>

<!-- Apply Tab -->
<div id="panel-apply" class="panel">

  <div class="apply-form">
    <div style="font-size:15px;font-weight:700" data-i18n="apply_title">üöÄ –†—É—á–Ω–æ–π –æ—Ç–∫–ª–∏–∫</div>
    <div style="font-size:12px;color:var(--dim)" data-i18n="apply_desc">–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID –≤–∞–∫–∞–Ω—Å–∏–∏ ‚Äî –±–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç, –Ω—É–∂–µ–Ω –ª–∏ –æ–ø—Ä–æ—Å, –ø–æ–∫–∞–∂–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç–∫–ª–∏–∫.</div>

    <div class="apply-row">
      <div class="apply-label" data-i18n="apply_label_acc">–ê–∫–∫–∞—É–Ω—Ç</div>
      <select id="apply-account" class="apply-input" onchange="applyFillLetter(this.value)"></select>
    </div>

    <div class="apply-row">
      <div class="apply-label" data-i18n="apply_label_vacancy">–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é –∏–ª–∏ ID</div>
      <input id="apply-vacancy" class="apply-input" type="text"
        placeholder="https://hh.ru/vacancy/130334718 –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ 130334718" data-i18n-ph="apply_vacancy_ph">
    </div>

    <div class="apply-row">
      <div class="apply-label" data-i18n="apply_label_tpl">–®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="apply-letter-tpl" class="apply-input" style="flex:1"
          onchange="applyPickTemplate(this.value)">
          <option value="" data-i18n="apply_tpl_ph">‚Äî –≤—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω ‚Äî</option>
        </select>
        <button class="apply-btn-secondary" onclick="document.getElementById('apply-letter').value=''"
          style="white-space:nowrap;padding:6px 10px" data-i18n="apply_btn_clear">‚úï –û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
    <div class="apply-row">
      <div class="apply-label" data-i18n="apply_label_letter">–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ</div>
      <textarea id="apply-letter" class="apply-input" rows="5"
        placeholder="–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" data-i18n-ph="apply_letter_ph"></textarea>
    </div>

    <div>
      <button class="apply-btn" onclick="applyCheck()" data-i18n="apply_btn_check">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å / –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button>
    </div>

    <div id="apply-result" style="display:none"></div>
    <div id="apply-questionnaire" style="display:none"></div>
  </div>
</div>

<!-- LLM Replies Tab -->
<div id="panel-llm" class="panel" style="padding:16px">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">
    <div style="font-size:15px;font-weight:700">ü§ñ LLM –ê–≤—Ç–æ-–æ—Ç–≤–µ—Ç—ã</div>
    <button id="llm-global-toggle-btn" onclick="llmGlobalToggle(this)"
      style="padding:4px 14px;border-radius:4px;border:1px solid var(--dim);background:transparent;cursor:pointer;font-size:12px;color:var(--dim)">
      ‚è∏ –í–´–ö–õ
    </button>
    <select id="llm-log-acc-filter" class="apply-input" style="font-size:11px;padding:3px 6px" onchange="llmInterviewsLoad()">
      <option value="">–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</option>
    </select>
    <select id="llm-log-sent-filter" class="apply-input" style="font-size:11px;padding:3px 6px" onchange="llmInterviewsLoad()">
      <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="pending_reply">‚è≥ –ñ–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞</option>
      <option value="draft">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</option>
      <option value="replied">‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
      <option value="no_reply_needed">‚Äî –û—Ç–≤–µ—Ç –Ω–µ –Ω—É–∂–µ–Ω</option>
      <option value="chat_closed">üîí –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç</option>
    </select>
    <button class="btn-sm" onclick="llmInterviewsLoad()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button class="btn-sm" onclick="llmRunNow(this)" style="background:var(--cyan);color:#000;border-color:var(--cyan)">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å</button>
    <button class="btn-sm" onclick="llmResetReplied(this)" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ¬´—É–∂–µ –æ—Ç–≤–µ—á–∞–ª–∏¬ª ‚Äî –±–æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ —á–∞—Ç—ã">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <span id="llm-log-count" style="font-size:11px;color:var(--dim);margin-left:auto"></span>
  </div>
  <!-- Per-account LLM toggles -->
  <div id="llm-acc-toggles" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px"></div>

  <!-- Per-account stats -->
  <div id="llm-acc-stats" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px"></div>

  <!-- LLM debug log -->
  <details id="llm-debug-details" style="margin-bottom:14px" open>
    <summary style="cursor:pointer;font-size:12px;color:var(--dim);user-select:none;padding:4px 0;list-style:none">
      ‚ñ∂ üîç –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –ª–æ–≥ LLM <span id="llm-debug-count" style="font-size:11px"></span>
    </summary>
    <div id="llm-debug-log" style="margin-top:6px;max-height:240px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-size:11px;font-family:monospace;display:flex;flex-direction:column;gap:2px">
      <span style="color:var(--dim)">–û–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 300–º—Å...</span>
    </div>
  </details>

  <!-- Interviews DB table -->
  <div style="overflow-x:auto">
    <table class="applied-table" id="llm-interviews-table" style="display:none">
      <thead>
        <tr>
          <th style="width:95px">–û–±–Ω–∞—Ä—É–∂–µ–Ω</th>
          <th style="width:75px">–ê–∫–∫–∞—É–Ω—Ç</th>
          <th style="width:130px">–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å</th>
          <th style="width:180px">–í–∞–∫–∞–Ω—Å–∏—è</th>
          <th>–°–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è</th>
          <th>–û—Ç–≤–µ—Ç LLM</th>
          <th style="width:90px">–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody id="llm-interviews-body"></tbody>
    </table>
    <div id="llm-interviews-empty" style="color:var(--dim);font-size:12px;display:none">
      –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –æ–ø—Ä–æ—Å–∞ HH-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (~15 –º–∏–Ω).
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div id="panel-settings" class="panel">
  <div id="settings-panel">
    <details class="q-section prio-medium">
      <summary class="q-section-title" data-i18n="settings_title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞<span class="prio-badge">–ù—É–∂–Ω–æ</span></summary>
      <div class="q-section-body">
        <div class="settings-grid" id="settings-grid"></div>
        <button id="settings-apply" onclick="applySettings()" data-i18n="btn_apply_settings">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <div id="settings-status"></div>
      </div>
    </details>

    <!-- Account cookies update -->
    <details class="q-section prio-high" open>
      <summary class="q-section-title" data-i18n="sec_cookies">üîë –û–±–Ω–æ–≤–∏—Ç—å –∫—É–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤<span class="prio-badge">–í–∞–∂–Ω–æ</span></summary>
      <div class="q-section-body">
      <div style="font-size:11px;color:var(--dim);margin-bottom:12px;line-height:1.7">
        –í—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π <b>cURL</b> –∏–ª–∏ —Å—Ç—Ä–æ–∫—É <b>cookie: hhtoken=‚Ä¶</b> ‚Äî –∫—É–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è —Å—Ä–∞–∑—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.<br>
        –ü–æ–ª—É—á–∏—Ç—å: <b>F12 ‚Üí Network ‚Üí –ª—é–±–æ–π –∑–∞–ø—Ä–æ—Å –∫ hh.ru ‚Üí –ø—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ ‚Üí Copy as cURL</b>
      </div>
      <div id="acc-cookies-list"></div>
      </div>
    </details>

    <!-- URL pool -->
    <details class="q-section prio-medium">
      <summary class="q-section-title" data-i18n="sec_url_pool">üîó –ü—É–ª –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤<span class="prio-badge">–ù—É–∂–Ω–æ</span></summary>
      <div class="q-section-body">
      <div style="font-size:11px;color:var(--dim);margin-bottom:12px">
        –î–æ–±–∞–≤—å—Ç–µ URL-–∞–¥—Ä–µ—Å–∞ –ø–æ–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∫–∞–∫ —á–µ–∫–±–æ–∫—Å—ã –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.
        –ü–æ–ª–µ <b>—Å—Ç—Ä.</b> –∑–∞–¥–∞—ë—Ç –≥–ª—É–±–∏–Ω—É –ø–æ–∏—Å–∫–∞ (–∫–æ–ª-–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü) –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞; –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ª–∞–π–¥–µ—Ä–∞ –≤—ã—à–µ.
      </div>
      <div id="url-pool-rows"></div>
      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <button class="btn-sm" onclick="urlPoolAddRow()" data-i18n="btn_add_url">Ôºã –î–æ–±–∞–≤–∏—Ç—å URL</button>
        <button class="btn-sm" onclick="urlPoolSave(this)" data-i18n="btn_save_pool">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—É–ª</button>
        <span id="url-pool-st" style="font-size:11px;color:var(--dim)"></span>
      </div>
      </div>
    </details>

    <!-- Letter templates -->
    <details class="q-section prio-low">
      <summary class="q-section-title" data-i18n="sec_letters">‚úâÔ∏è –®–∞–±–ª–æ–Ω—ã –ø–∏—Å–µ–º<span class="prio-badge">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</span></summary>
      <div class="q-section-body">
      <div style="font-size:11px;color:var(--dim);margin-bottom:12px" data-i18n="sec_letters_desc">
        –°–æ–∑–¥–∞–π—Ç–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ –Ω–∞ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞.
      </div>
      <div class="q-templates" id="lt-templates-list"></div>
      <div class="q-btn-row">
        <button class="q-btn" onclick="ltAddTemplate()" data-i18n="btn_add_template">Ôºã –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
        <button class="q-btn-save" onclick="ltSave()" data-i18n="btn_save_templates">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã</button>
      </div>
      <div class="q-status" id="lt-status"></div>
      </div>
    </details>

    <!-- Questionnaire templates -->
    <details class="q-section prio-low">
      <summary class="q-section-title" data-i18n="sec_questionnaire">üìù –®–∞–±–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ–ø—Ä–æ—Å—ã<span class="prio-badge">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</span></summary>
      <div class="q-section-body">
      <div style="font-size:11px;color:var(--dim);margin-bottom:10px" data-i18n="sec_questionnaire_desc">
        –ö–æ–≥–¥–∞ –≤–∞–∫–∞–Ω—Å–∏—è —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ä–æ—Å ‚Äî –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç –µ–≥–æ.
        –î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ —É–∫–∞–∂–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) –∏ –æ—Ç–≤–µ—Ç.
        –ü–µ—Ä–≤—ã–π —Å–æ–≤–ø–∞–≤—à–∏–π —à–∞–±–ª–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –ü–æ—Å–ª–µ–¥–Ω–∏–π ‚Äî –æ—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
      </div>
      <div style="margin-bottom:14px;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px">
        <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--cyan)">üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–µ—Å–µ—Ç—ã</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
          <button class="btn-sm" style="color:var(--green);border-color:var(--green)" onclick="qLoadPreset('universal')">üåê –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π</button>
          <button class="btn-sm" onclick="qLoadPreset('sales')">üíº –ü—Ä–æ–¥–∞–∂–∏ / –ö–¶</button>
          <button class="btn-sm" onclick="qLoadPreset('office')">üè¢ –û—Ñ–∏—Å / –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
          <button class="btn-sm" onclick="qLoadPreset('remote')">üè† –£–¥–∞–ª—ë–Ω–∫–∞ / IT</button>
        </div>
        <div style="font-size:11px;color:var(--dim)">‚ö†Ô∏è –ó–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ —à–∞–±–ª–æ–Ω—ã. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –ø–æ–¥ —Å–µ–±—è –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.</div>
      </div>
      <div class="q-templates" id="q-templates-list"></div>
      <div class="q-default-row">
        <label data-i18n="q_default_label">–û—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –Ω–µ –ø–æ–¥–æ—à—ë–ª)</label>
        <textarea id="q-default-answer" class="q-answer-input" rows="2"
          placeholder="–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏." data-i18n-ph="q_default_ph"></textarea>
      </div>
      <div class="q-btn-row">
        <button class="q-btn" onclick="qAddTemplate()" data-i18n="btn_add_template">Ôºã –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
        <button class="q-btn-save" onclick="qSave()" data-i18n="btn_save_templates">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã</button>
      </div>
      <div class="q-status" id="q-status"></div>
      </div>
    </details>

    <!-- LLM auto-reply -->
    <details class="q-section prio-low" id="llm-section">
      <summary class="q-section-title">ü§ñ LLM –ê–≤—Ç–æ-–æ—Ç–≤–µ—Ç—ã<span class="prio-badge">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</span></summary>
      <div class="q-section-body">
      <div style="font-size:11px;color:var(--dim);margin-bottom:12px;line-height:1.7">
        –ë–æ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π –≤ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞—Ö —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º <b>–ò–Ω—Ç–µ—Ä–≤—å—é</b>.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API (GPT-4o-mini, DeepSeek –∏ –¥—Ä.)
      </div>
      <div style="font-size:11px;color:var(--cyan);margin-bottom:10px">
        üí° –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç—ã ‚Äî –∫–Ω–æ–ø–∫–∞ –≤–æ –≤–∫–ª–∞–¥–∫–µ <b>ü§ñ LLM –û—Ç–≤–µ—Ç—ã</b>
      </div>
      <div style="display:flex;gap:14px;margin-bottom:8px;align-items:center;flex-wrap:wrap">
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
          <input type="checkbox" id="llm-auto-send" style="accent-color:var(--green)" checked>
          –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∏–Ω–∞—á–µ —Ç–æ–ª—å–∫–æ –≤ –ª–æ–≥)
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
          <input type="checkbox" id="llm-use-cover-letter" style="accent-color:var(--yellow)" checked>
          –£—á–∏—Ç—ã–≤–∞—Ç—å —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
          <input type="checkbox" id="llm-use-resume" style="accent-color:var(--cyan)" checked>
          –£—á–∏—Ç—ã–≤–∞—Ç—å —Ä–µ–∑—é–º–µ
        </label>
      </div>
      <div style="margin-bottom:12px">
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
          <input type="checkbox" id="llm-fill-questionnaire" style="accent-color:var(--purple,#c084fc)"
                 onchange="send({type:'set_config',key:'llm_fill_questionnaire',value:this.checked})">
          üìù –ó–∞–ø–æ–ª–Ω—è—Ç—å –æ–ø—Ä–æ—Å–Ω–∏–∫–∏ –Ω–µ–π—Ä–æ–Ω–∫–æ–π (textarea + radio + checkbox –ø—Ä–∏ –æ—Ç–∫–ª–∏–∫–∞—Ö)
        </label>
        <div style="font-size:11px;color:var(--dim);margin-top:4px;margin-left:22px">
          –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî LLM —Å–∞–º –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—Ç–∫–ª–∏–∫–µ. –®–∞–±–ª–æ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç.
        </div>
      </div>
      <div style="margin-bottom:12px">
        <div style="font-size:11px;color:var(--dim);margin-bottom:6px">
          –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—é–º–µ ‚Äî —É–±–µ–¥–∏—Å—å —á—Ç–æ –ø–∞—Ä—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="llm-resume-acc-sel" class="apply-input" style="font-size:11px;padding:3px 6px"></select>
          <button class="btn-sm" onclick="llmPreviewResume(this)">üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—é–º–µ</button>
          <span id="llm-resume-status" style="font-size:11px;color:var(--dim)"></span>
        </div>
        <pre id="llm-resume-preview" style="display:none;margin-top:8px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;font-size:11px;white-space:pre-wrap;max-height:220px;overflow-y:auto;color:var(--fg)"></pre>
      </div>
      <div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-size:12px;font-weight:600">üîë API –ø—Ä–æ—Ñ–∏–ª–∏</div>
          <div style="display:flex;gap:8px;align-items:center">
            <label style="font-size:11px;color:var(--dim)">–†–µ–∂–∏–º:</label>
            <select id="llm-profile-mode" class="apply-input" style="font-size:11px;padding:2px 6px">
              <option value="fallback">‚¨áÔ∏è –†–µ–∑–µ—Ä–≤ (–ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π)</option>
              <option value="roundrobin">üîÅ –ü–æ –æ—á–µ—Ä–µ–¥–∏</option>
            </select>
          </div>
        </div>
        <div style="font-size:10px;color:var(--dim);margin-bottom:8px">–ö–ª—é—á–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏.</div>
        <div id="llm-profiles-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px"></div>
        <button class="btn-sm" onclick="llmProfileAdd()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
      <div style="margin-bottom:8px">
        <div style="font-size:11px;color:var(--dim);margin-bottom:3px">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</div>
        <textarea id="llm-system-prompt" class="apply-input" rows="4" style="font-size:11px"></textarea>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn-sm" onclick="llmSave(this)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <span id="llm-status" style="font-size:11px;color:var(--dim)"></span>
      </div>
      </div>
    </details>

    <!-- Browser sessions -->
    <details class="q-section prio-critical" open>
      <summary class="q-section-title" data-i18n="sec_sessions">üåê –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Å–µ—Å—Å–∏–∏<span class="prio-badge">–ö—Ä–∏—Ç–∏—á–Ω–æ</span></summary>
      <div class="q-section-body">
      <div id="sess-list" style="margin-bottom:12px"></div>
      <details class="session-block" id="session-block">
        <summary class="session-summary" data-i18n="sess_add">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞</summary>
        <div class="session-body">

          <!-- Mode toggle -->
          <div style="display:flex;gap:0;margin-bottom:14px;border:1px solid var(--border);border-radius:5px;overflow:hidden;width:fit-content">
            <button id="sess-mode-curl" onclick="sessSetMode('curl')"
              style="padding:5px 14px;font-size:11px;background:var(--cyan);color:#000;border:none;cursor:pointer;font-family:inherit" data-i18n="sess_mode_curl">cURL / —Å—Ç—Ä–æ–∫–∞</button>
            <button id="sess-mode-manual" onclick="sessSetMode('manual')"
              style="padding:5px 14px;font-size:11px;background:transparent;color:var(--dim);border:none;cursor:pointer;font-family:inherit" data-i18n="sess_mode_manual">–í—Ä—É—á–Ω—É—é</button>
          </div>

          <!-- Mode: cURL -->
          <div id="sess-panel-curl">
            <div style="font-size:12px;color:var(--dim);margin-bottom:10px;line-height:1.8">
              <b data-i18n="sess_curl_desc">–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± ‚Äî Copy as cURL:</b><br>
              1. –û—Ç–∫—Ä–æ–π—Ç–µ <b>hh.ru</b>, –≤–æ–π–¥–∏—Ç–µ –≤ –Ω—É–∂–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç<br>
              2. <b>F12</b> ‚Üí –≤–∫–ª–∞–¥–∫–∞ <b>Network</b> ‚Üí –ª—é–±–æ–π –∑–∞–ø—Ä–æ—Å –∫ hh.ru<br>
              3. –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å–µ ‚Üí <b style="color:var(--cyan)">Copy ‚Üí Copy as cURL</b><br>
              4. –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–µ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî –±–æ—Ç —Å–∞–º –≤—ã—Ç–∞—â–∏—Ç cookies
            </div>
            <textarea id="session-cookies" class="apply-input" rows="4"
              placeholder="curl 'https://hh.ru/...' -H 'cookie: hhtoken=...' ...&#10;&#10;‚Äî –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫—É cookies: hhtoken=xxx; _xsrf=yyy; ..."></textarea>
          </div>

          <!-- Mode: manual keys -->
          <div id="sess-panel-manual" style="display:none">
            <div style="font-size:12px;color:var(--dim);margin-bottom:10px;line-height:1.8">
              –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–µ–π –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞:<br>
              <b>F12 ‚Üí Application ‚Üí Cookies ‚Üí https://hh.ru</b>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <div class="apply-label" style="margin-bottom:3px">hhtoken <span style="color:var(--red)">*</span></div>
                <input id="ck-hhtoken" class="apply-input" type="text" placeholder="Fq8hA...">
              </div>
              <div>
                <div class="apply-label" style="margin-bottom:3px">_xsrf <span style="color:var(--red)">*</span></div>
                <input id="ck-xsrf" class="apply-input" type="text" placeholder="9788d9...">
              </div>
              <div>
                <div class="apply-label" style="margin-bottom:3px">hhul</div>
                <input id="ck-hhul" class="apply-input" type="text" placeholder="747afc...">
              </div>
              <div>
                <div class="apply-label" style="margin-bottom:3px">crypted_id</div>
                <input id="ck-crypted-id" class="apply-input" type="text" placeholder="464B61...">
              </div>
            </div>
          </div>

          <!-- Common fields -->
          <div style="margin-top:10px">
            <div class="apply-label" style="margin-bottom:4px" data-i18n="sess_name_label">–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</div>
            <input id="session-name" class="apply-input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ä–∏—è" data-i18n-ph="sess_name_ph">
          </div>
          <div style="margin-top:10px">
            <div class="apply-label" style="margin-bottom:4px" data-i18n="sess_letter_label">–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
            <textarea id="session-letter" class="apply-input" rows="4"
              placeholder="–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–∑ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–ª–∏ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—ã–º"></textarea>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button class="apply-btn" onclick="sessionAdd()" data-i18n="btn_connect">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
            <span id="session-status" style="font-size:12px;color:var(--dim)"></span>
          </div>
        </div>
      </details>

      <!-- JSON Editor -->
      <div class="q-section-title-plain" style="margin-top:18px">üìã JSON-—Ä–µ–¥–∞–∫—Ç–æ—Ä</div>
      <div style="font-size:11px;color:var(--dim);margin-bottom:10px">
        –ü—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤. –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
      </div>
      <details class="session-block" id="json-config-details">
        <summary class="session-summary">‚öôÔ∏è config.json</summary>
        <div class="session-body">
          <textarea id="json-config-ta" class="apply-input" rows="16"
            style="font-family:monospace;font-size:11px;white-space:pre" spellcheck="false"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button class="btn-sm" onclick="jsonConfigLoad(this)">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn-sm" onclick="jsonConfigTemplate()">üìã –®–∞–±–ª–æ–Ω</button>
            <button class="btn-sm" style="color:var(--green);border-color:var(--green)"
              onclick="jsonConfigSave(this)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <span id="json-config-st" style="font-size:11px;color:var(--dim)"></span>
          </div>
        </div>
      </details>
      <details class="session-block" id="json-accounts-details" style="margin-top:8px">
        <summary class="session-summary">üë§ accounts.json</summary>
        <div class="session-body">
          <textarea id="json-accounts-ta" class="apply-input" rows="16"
            style="font-family:monospace;font-size:11px;white-space:pre" spellcheck="false"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button class="btn-sm" onclick="jsonAccountsLoad(this)">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn-sm" onclick="jsonAccountsTemplate()">üìã –®–∞–±–ª–æ–Ω</button>
            <button class="btn-sm" style="color:var(--green);border-color:var(--green)"
              onclick="jsonAccountsSave(this)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <span id="json-accounts-st" style="font-size:11px;color:var(--dim)"></span>
          </div>
        </div>
      </details>
      </div>
    </details>
  </div>
</div>

<script>
// ‚îÄ‚îÄ i18n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lang = localStorage.getItem('hh-lang') || 'ru';

const T = {
  ru: {
    // Tabs
    tab_main: 'üìä –ì–ª–∞–≤–Ω–∞—è',
    tab_log: 'üìú –õ–æ–≥',
    tab_applied: '‚úÖ –û—Ç–∫–ª–∏–∫–∏',
    tab_tests: 'üß™ –¢–µ—Å—Ç—ã',
    tab_db: 'üìÇ –ë–∞–∑–∞',
    tab_hh: 'üéØ HH –°—Ç–∞—Ç—É—Å',
    tab_views: 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã',
    tab_apply: 'üöÄ –û—Ç–∫–ª–∏–∫',
    tab_settings: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    // Header
    hdr_found: '–Ω–∞–π–¥–µ–Ω–æ',
    hdr_replies: '–æ—Ç–∫–ª–∏–∫–æ–≤',
    hdr_in_db: '–≤ –±–∞–∑–µ',
    hdr_tests: '—Ç–µ—Å—Ç–æ–≤',
    hdr_new_views: '–Ω–æ–≤—ã—Ö –ø—Ä–æ—Å–º.',
    hdr_new_inv: '–Ω–æ–≤—ã—Ö –ø—Ä–∏–≥–ª–∞—à.',
    hdr_shows: '–ø–æ–∫–∞–∑–æ–≤',
    btn_pause: '‚è∏ –ü–∞—É–∑–∞',
    btn_resume: '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (–≤—Å–µ)',
    // Status badges
    status_idle: '–û–ñ–ò–î–ê–ù–ò–ï',
    status_collecting: '–°–ë–û–† –í–ê–ö–ê–ù–°–ò–ô',
    status_applying: '–û–¢–ü–†–ê–í–ö–ê –û–¢–ö–õ–ò–ö–û–í',
    status_limit: '–õ–ò–ú–ò–¢',
    status_waiting: '–ü–ê–£–ó–ê',
    status_checking: '–ü–†–û–í–ï–†–ö–ê –õ–ò–ú–ò–¢–ê',
    status_inactive: '–ù–ï–ê–ö–¢–ò–í–ù–ê',
    status_all_paused: '‚è∏ –í–°–ï –ù–ê –ü–ê–£–ó–ï',
    status_acc_paused: '‚è∏ –ù–ê –ü–ê–£–ó–ï',
    // Card labels
    stat_replies: '–û—Ç–∫–ª–∏–∫–∏',
    stat_tests: '–¢–µ—Å—Ç—ã',
    stat_surveys: 'üìù –û–ø—Ä–æ—Å—ã',
    stat_already: '–£–∂–µ',
    stat_errors: '–û—à–∏–±–∫–∏',
    stat_salary: 'üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞',
    stat_interviews: 'üéØ –ò–Ω—Ç–µ—Ä–≤—å—é',
    stat_new_inv: 'üì¨ –ù–æ–≤—ã–µ',
    card_waiting: '–û–∂–∏–¥–∞–Ω–∏–µ...',
    card_hh_loading: '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é HH –¥–∞–Ω–Ω—ã–µ...',
    card_sending: '–û—Ç–ø—Ä–∞–≤–∫–∞...',
    btn_acc_pause: '‚è∏ –ü–∞—É–∑–∞ –∞–∫–∫–∞—É–Ω—Ç–∞',
    btn_acc_resume: '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
    btn_acc_global_pause: '‚è∏ –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞',
    btn_resume_touch: 'üì§ –ü–æ–¥–Ω—è—Ç—å —Ä–µ–∑—é–º–µ',
    btn_clear_discards: 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∏—Å–∫–∞—Ä–¥—ã',
    btn_launch: '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å',
    btn_delete: '‚úï –£–¥–∞–ª–∏—Ç—å',
    card_apply_tests: '–û—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏ —Å —Ç–µ—Å—Ç–æ–º',
    letter_section: '‚úâÔ∏è –ü–∏—Å—å–º–æ',
    url_section: 'üîó URL –ø–æ–∏—Å–∫–∞',
    btn_save: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    btn_apply_url: 'üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å',
    cookies_expired_badge: '‚ö†Ô∏è –ö—É–∫–∏ –ø—Ä–æ—Ç—É—Ö–ª–∏! –û–±–Ω–æ–≤–∏—Ç–µ –∫—É–∫–∏',
    errs_in_row: '–æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥',
    // Global stats
    gs_session: 'üìä –°–µ—Å—Å–∏—è',
    gs_found: 'üîç –ù–∞–π–¥–µ–Ω–æ',
    gs_applied: '‚úÖ –û—Ç–∫–ª–∏–∫–∏',
    gs_tests: 'üß™ –¢–µ—Å—Ç—ã',
    gs_errors: '‚ùå –û—à–∏–±–∫–∏',
    gs_in_db: 'üíæ –í –±–∞–∑–µ',
    gs_in_db_tests: 'üß™ –¢–µ—Å—Ç.',
    sidebar_recent: 'üì¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–∏',
    recent_empty: '–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–∫–ª–∏–∫–æ–≤...',
    no_accounts: '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ‚öôÔ∏è',
    // Resume stats
    rs_views: '–ø—Ä–æ—Å–º. (7–¥)',
    rs_shows: '–ø–æ–∫–∞–∑–æ–≤',
    rs_inv: '–ø—Ä–∏–≥–ª–∞—à.',
    rs_raise_in: '–ø–æ–¥–Ω—è—Ç—å —á–µ—Ä–µ–∑',
    rs_raises_avail: '–ø–æ–¥–Ω—è—Ç–∏–π –¥–æ—Å—Ç—É–ø–Ω–æ',
    // Log tab
    log_search_ph: 'üîç –ü–æ–∏—Å–∫...',
    log_all_accs: '–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã',
    log_all: '–í—Å–µ',
    // Applied tab
    applied_title: '‚úÖ –û—Ç–∫–ª–∏–∫–∏',
    applied_search_ph: 'üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é / –∫–æ–º–ø–∞–Ω–∏–∏...',
    applied_all_accs: '–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã',
    applied_only_named: '–¢–æ–ª—å–∫–æ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º',
    col_date: '–î–∞—Ç–∞',
    col_account: '–ê–∫–∫–∞—É–Ω—Ç',
    col_vacancy: '–í–∞–∫–∞–Ω—Å–∏—è',
    col_company: '–ö–æ–º–ø–∞–Ω–∏—è',
    col_salary: '–ó–∞—Ä–ø–ª–∞—Ç–∞',
    btn_show_more: '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë',
    shown_of: '–ø–æ–∫–∞–∑–∞–Ω–æ',
    shown_of2: '–∏–∑',
    // Tests tab
    tests_title: 'üß™ –í–∞–∫–∞–Ω—Å–∏–∏ —Å —Ç–µ—Å—Ç–∞–º–∏',
    col_applied_yn: '–û—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å',
    col_link: '–°—Å—ã–ª–∫–∞',
    // DB tab
    db_title: 'üìÇ –ë–∞–∑–∞ –≤–∞–∫–∞–Ω—Å–∏–π',
    db_search_ph: 'üîç –ù–∞–∑–≤–∞–Ω–∏–µ / –∫–æ–º–ø–∞–Ω–∏—è / ID...',
    db_all_statuses: '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã',
    db_status_sent: '‚úÖ –û—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å',
    db_status_test_passed: 'üìù –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω',
    db_status_test_pending: 'üß™ –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω',
    db_all_accs: '–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã',
    col_status: '–°—Ç–∞—Ç—É—Å',
    col_accounts: '–ê–∫–∫–∞—É–Ω—Ç—ã',
    // HH Status
    hh_interviews: '–ò–Ω—Ç–µ—Ä–≤—å—é',
    hh_viewed: '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
    hh_discards: '–û—Ç–∫–∞–∑—ã',
    hh_not_viewed: '–ù–µ –ø—Ä–æ—Å–º.',
    hh_updated: '–û–±–Ω–æ–≤–ª–µ–Ω–æ:',
    hh_inv_list: 'üìã –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é:',
    hh_offers: 'üè¢ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:',
    hh_no_data: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
    hh_loading: '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ HH...',
    // Views tab
    views_7d: '–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Ä–µ–∑—é–º–µ (7–¥)',
    views_new: '–ù–æ–≤—ã—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤',
    views_shows: '–ü–æ–∫–∞–∑–æ–≤ –≤ –ø–æ–∏—Å–∫–µ',
    views_invitations: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π (7–¥)',
    views_inv_new: '–ù–æ–≤—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π',
    views_loading: '–ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤...',
    btn_load_history: '‚Üª –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é',
    views_no_data: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–æ–±–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω)',
    col_employer: '–ö–æ–º–ø–∞–Ω–∏—è',
    // Apply tab
    apply_title: 'üöÄ –†—É—á–Ω–æ–π –æ—Ç–∫–ª–∏–∫',
    apply_desc: '–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID –≤–∞–∫–∞–Ω—Å–∏–∏ ‚Äî –±–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç, –Ω—É–∂–µ–Ω –ª–∏ –æ–ø—Ä–æ—Å, –ø–æ–∫–∞–∂–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç–∫–ª–∏–∫.',
    apply_label_acc: '–ê–∫–∫–∞—É–Ω—Ç',
    apply_label_vacancy: '–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é –∏–ª–∏ ID',
    apply_vacancy_ph: 'https://hh.ru/vacancy/130334718 –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ 130334718',
    apply_label_tpl: '–®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞',
    apply_tpl_ph: '‚Äî –≤—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω ‚Äî',
    apply_btn_clear: '‚úï –û—á–∏—Å—Ç–∏—Ç—å',
    apply_label_letter: '–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ',
    apply_letter_ph: '–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
    apply_btn_check: 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å / –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è',
    // Settings tab
    settings_title: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞',
    btn_apply_settings: '‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å',
    settings_applied: '‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã',
    // Settings param labels
    lbl_pages_per_url: '–°—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ URL',
    hint_pages_per_url: '–°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞',
    lbl_response_delay: '–ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–∫–ª–∏–∫–∞ (—Å)',
    hint_response_delay: '–ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–∞—á–∫–∞–º–∏ –æ—Ç–∫–ª–∏–∫–æ–≤ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö',
    lbl_pause_between_cycles: '–ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏ (—Å)',
    hint_pause_between_cycles: '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π',
    lbl_batch_responses: '–†–∞–∑–º–µ—Ä –ø–∞—á–∫–∏ –æ—Ç–∫–ª–∏–∫–æ–≤',
    hint_batch_responses: '–°–∫–æ–ª—å–∫–æ –æ—Ç–∫–ª–∏–∫–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ',
    lbl_limit_check_interval: '–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ (–º)',
    hint_limit_check_interval: '–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–±—Ä–æ—Å –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –æ—Ç–∫–ª–∏–∫–æ–≤',
    lbl_min_salary: '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)',
    hint_min_salary: '–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏ —Å –∑–∞—Ä–ø–ª–∞—Ç–æ–π –Ω–∏–∂–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π (0 = –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞)',
    lbl_auto_pause_errors: '–ê–≤—Ç–æ-–ø–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö',
    hint_auto_pause_errors: '–ê–≤—Ç–æ-–ø–∞—É–∑–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ—Å–ª–µ N –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ (0 = –≤—ã–∫–ª—é—á–µ–Ω–æ)',
    // Settings sections
    sec_main_accounts: 'üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã',
    sec_main_accounts_desc: '–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ data/accounts.json.',
    sec_url_pool: 'üîó –ü—É–ª –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤',
    sec_url_pool_desc: '–î–æ–±–∞–≤—å—Ç–µ URL-–∞–¥—Ä–µ—Å–∞ –ø–æ–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∫–∞–∫ —á–µ–∫–±–æ–∫—Å—ã –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.',
    sec_letters: '‚úâÔ∏è –®–∞–±–ª–æ–Ω—ã –ø–∏—Å–µ–º',
    sec_letters_desc: '–°–æ–∑–¥–∞–π—Ç–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ –Ω–∞ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞.',
    sec_questionnaire: 'üìù –®–∞–±–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ–ø—Ä–æ—Å—ã',
    sec_questionnaire_desc: '–ö–æ–≥–¥–∞ –≤–∞–∫–∞–Ω—Å–∏—è —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ä–æ—Å ‚Äî –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç –µ–≥–æ.',
    sec_cookies: 'üîë –û–±–Ω–æ–≤–∏—Ç—å –∫—É–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤',
    sec_sessions: 'üåê –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Å–µ—Å—Å–∏–∏',
    // Account form
    acc_field_name: '–ò–º—è (–ø–æ–ª–Ω–æ–µ)',
    acc_field_short: '–ö–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è',
    acc_field_color: '–¶–≤–µ—Ç',
    acc_ph_name: '–ò–≤–∞–Ω (–æ—Å–Ω–æ–≤–Ω–æ–π)',
    acc_ph_short: '–æ—Å–Ω–æ–≤–Ω–æ–π',
    acc_cookies_label: 'Cookies (cURL –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞)',
    btn_add: '‚úÖ –î–æ–±–∞–≤–∏—Ç—å',
    btn_add_account: 'Ôºã –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç',
    btn_add_url: 'Ôºã –î–æ–±–∞–≤–∏—Ç—å URL',
    btn_save_pool: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—É–ª',
    btn_add_template: 'Ôºã –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω',
    btn_save_templates: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã',
    // Questionnaire
    q_keywords_ph: '–æ–ø—ã—Ç, —Ä–∞–±–æ—Ç–∞, QA',
    q_keywords_label: '–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)',
    q_answer_label: '–û—Ç–≤–µ—Ç',
    q_default_label: '–û—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –Ω–µ –ø–æ–¥–æ—à—ë–ª)',
    q_default_ph: '–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.',
    // Cookies section
    ck_desc: '–í—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π cURL –∏–ª–∏ —Å—Ç—Ä–æ–∫—É cookie: hhtoken=‚Ä¶',
    btn_update_cookies: 'üîë –û–±–Ω–æ–≤–∏—Ç—å –∫—É–∫–∏',
    // Sessions
    sess_add: '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞',
    sess_mode_curl: 'cURL / —Å—Ç—Ä–æ–∫–∞',
    sess_mode_manual: '–í—Ä—É—á–Ω—É—é',
    sess_curl_desc: '–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± ‚Äî Copy as cURL',
    sess_name_label: '–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
    sess_name_ph: '–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ä–∏—è',
    sess_letter_label: '–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
    btn_connect: 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ—Å—Å–∏—é',
    sess_active: 'üü¢ –∞–∫—Ç–∏–≤–Ω–∞',
    sess_inactive: '‚≠ï –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞',
    // Confirm dialogs
    confirm_delete: '–£–¥–∞–ª–∏—Ç—å',
    confirm_cancel: '–û—Ç–º–µ–Ω–∞',
    // Shortcuts
    shortcuts_title: '‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏',
    shortcuts_tabs: '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∫–ª–∞–¥–∫—É',
    shortcuts_pause: '–ü–∞—É–∑–∞ / –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—Å–µ',
    shortcuts_help: '–≠—Ç–æ –æ–∫–Ω–æ',
    shortcuts_esc: '–ó–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ',
    btn_close: '–ó–∞–∫—Ä—ã—Ç—å',
    // Notifications
    notif_new_inv: 'üì¨ –ù–æ–≤–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ ‚Äî ',
    notif_inv_count_pre: '–¢–µ–ø–µ—Ä—å',
    notif_inv_count_mid: '–∏–Ω—Ç–µ—Ä–≤—å—é (+',
    notif_limit: 'üö´ –õ–∏–º–∏—Ç ‚Äî ',
    notif_limit_body: '–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –æ—Ç–∫–ª–∏–∫–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω',
    notif_cookies: '‚ö†Ô∏è –ö—É–∫–∏ –ø—Ä–æ—Ç—É—Ö–ª–∏ ‚Äî ',
    notif_cookies_body: '–û–±–Ω–æ–≤–∏—Ç–µ –∫—É–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞–∫–∫–∞—É–Ω—Ç–∞',
    // Page titles
    title_limit: 'üö´ –õ–ò–ú–ò–¢ | HH Bot',
    title_paused: '‚è∏ –ü–∞—É–∑–∞ | HH Bot',
    // Confirm dialog texts
    confirm_del_acc_pre: '–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç',
    confirm_del_acc_body: '–í–æ—Ä–∫–µ—Ä –±—É–¥–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.',
    confirm_del_db_pre: '–£–¥–∞–ª–∏—Ç—å',
    confirm_del_db_mid: '–∏–∑ –±–∞–∑—ã?',
    confirm_del_db_body: '–ë–æ—Ç —Å–º–æ–∂–µ—Ç –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ.',
    confirm_del_sess: '–£–¥–∞–ª–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—É—é —Å–µ—Å—Å–∏—é?',
  },
  en: {
    // Tabs
    tab_main: 'üìä Main',
    tab_log: 'üìú Log',
    tab_applied: '‚úÖ Applied',
    tab_tests: 'üß™ Tests',
    tab_db: 'üìÇ Database',
    tab_hh: 'üéØ HH Status',
    tab_views: 'üëÅÔ∏è Views',
    tab_apply: 'üöÄ Apply',
    tab_settings: '‚öôÔ∏è Settings',
    // Header
    hdr_found: 'found',
    hdr_replies: 'applied',
    hdr_in_db: 'in DB',
    hdr_tests: 'tests',
    hdr_new_views: 'new views',
    hdr_new_inv: 'new invitations',
    hdr_shows: 'shows',
    btn_pause: '‚è∏ Pause',
    btn_resume: '‚ñ∂ Resume (all)',
    // Status badges
    status_idle: 'IDLE',
    status_collecting: 'COLLECTING',
    status_applying: 'APPLYING',
    status_limit: 'LIMIT',
    status_waiting: 'PAUSED',
    status_checking: 'CHECKING LIMIT',
    status_inactive: 'INACTIVE',
    status_all_paused: '‚è∏ ALL PAUSED',
    status_acc_paused: '‚è∏ PAUSED',
    // Card labels
    stat_replies: 'Replies',
    stat_tests: 'Tests',
    stat_surveys: 'üìù Surveys',
    stat_already: 'Already',
    stat_errors: 'Errors',
    stat_salary: 'üí∞ Salary',
    stat_interviews: 'üéØ Interviews',
    stat_new_inv: 'üì¨ New inv.',
    card_waiting: 'Waiting...',
    card_hh_loading: '‚è≥ Loading HH data...',
    card_sending: 'Sending...',
    btn_acc_pause: '‚è∏ Pause account',
    btn_acc_resume: '‚ñ∂ Resume',
    btn_acc_global_pause: '‚è∏ Global pause',
    btn_resume_touch: 'üì§ Raise resume',
    btn_clear_discards: 'üóëÔ∏è Clear discards',
    btn_launch: '‚ñ∂ Launch',
    btn_delete: '‚úï Delete',
    card_apply_tests: 'Apply to vacancies with test',
    letter_section: '‚úâÔ∏è Letter',
    url_section: 'üîó Search URLs',
    btn_save: 'üíæ Save',
    btn_apply_url: 'üíæ Apply',
    cookies_expired_badge: '‚ö†Ô∏è Cookies expired! Update cookies',
    errs_in_row: 'errors in a row',
    // Global stats
    gs_session: 'üìä Session',
    gs_found: 'üîç Found',
    gs_applied: '‚úÖ Applied',
    gs_tests: 'üß™ Tests',
    gs_errors: '‚ùå Errors',
    gs_in_db: 'üíæ In DB',
    gs_in_db_tests: 'üß™ Tests',
    sidebar_recent: 'üì¨ Recent Replies',
    recent_empty: 'Waiting for replies...',
    no_accounts: 'No accounts. Add an account in Settings',
    // Resume stats
    rs_views: 'views (7d)',
    rs_shows: 'shows',
    rs_inv: 'invitations',
    rs_raise_in: 'raise in',
    rs_raises_avail: 'raises available',
    // Log tab
    log_search_ph: 'üîç Search...',
    log_all_accs: 'All accounts',
    log_all: 'All',
    // Applied tab
    applied_title: '‚úÖ Applied',
    applied_search_ph: 'üîç Search by title / company...',
    applied_all_accs: 'All accounts',
    applied_only_named: 'Only with title',
    col_date: 'Date',
    col_account: 'Account',
    col_vacancy: 'Vacancy',
    col_company: 'Company',
    col_salary: 'Salary',
    btn_show_more: 'Show more',
    shown_of: 'showing',
    shown_of2: 'of',
    // Tests tab
    tests_title: 'üß™ Vacancies with tests',
    col_applied_yn: 'Applied',
    col_link: 'Link',
    // DB tab
    db_title: 'üìÇ Vacancy Database',
    db_search_ph: 'üîç Title / company / ID...',
    db_all_statuses: 'All statuses',
    db_status_sent: '‚úÖ Applied',
    db_status_test_passed: 'üìù Test passed',
    db_status_test_pending: 'üß™ Test pending',
    db_all_accs: 'All accounts',
    col_status: 'Status',
    col_accounts: 'Accounts',
    // HH Status
    hh_interviews: 'Interviews',
    hh_viewed: 'Viewed',
    hh_discards: 'Discards',
    hh_not_viewed: 'Not viewed',
    hh_updated: 'Updated:',
    hh_inv_list: 'üìã Interview invitations:',
    hh_offers: 'üè¢ Possible offers:',
    hh_no_data: 'No data',
    hh_loading: '‚è≥ Loading HH data...',
    // Views tab
    views_7d: 'Resume views (7d)',
    views_new: 'New views',
    views_shows: 'Search shows',
    views_invitations: 'Invitations (7d)',
    views_inv_new: 'New invitations',
    views_loading: 'Loading view history...',
    btn_load_history: '‚Üª Load history',
    views_no_data: 'No data (refresh in 15 min)',
    col_employer: 'Company',
    // Apply tab
    apply_title: 'üöÄ Manual Apply',
    apply_desc: 'Enter vacancy URL or ID ‚Äî the bot will check if a survey is required, show questions, and submit the reply.',
    apply_label_acc: 'Account',
    apply_label_vacancy: 'Vacancy URL or ID',
    apply_vacancy_ph: 'https://hh.ru/vacancy/130334718 or just 130334718',
    apply_label_tpl: 'Letter template',
    apply_tpl_ph: '‚Äî select template ‚Äî',
    apply_btn_clear: '‚úï Clear',
    apply_label_letter: 'Cover letter',
    apply_letter_ph: 'Cover letter (optional)',
    apply_btn_check: 'üîç Check / Apply',
    // Settings tab
    settings_title: '‚öôÔ∏è Bot Settings',
    btn_apply_settings: '‚úÖ Apply',
    settings_applied: '‚úÖ Settings applied',
    // Settings param labels
    lbl_pages_per_url: 'Pages per URL',
    hint_pages_per_url: 'How many result pages to load per search query',
    lbl_response_delay: 'Reply delay (s)',
    hint_response_delay: 'Pause between reply batches in seconds',
    lbl_pause_between_cycles: 'Pause between cycles (s)',
    hint_pause_between_cycles: 'Wait after completing a full vacancy processing cycle',
    lbl_batch_responses: 'Reply batch size',
    hint_batch_responses: 'How many replies to send in parallel',
    lbl_limit_check_interval: 'Limit check interval (m)',
    hint_limit_check_interval: 'How often to check daily reply limit reset',
    lbl_min_salary: 'Minimum salary (‚ÇΩ)',
    hint_min_salary: 'Skip vacancies with salary below specified (0 = no filter)',
    lbl_auto_pause_errors: 'Auto-pause on errors',
    hint_auto_pause_errors: 'Auto-pause account after N consecutive errors (0 = disabled)',
    // Settings sections
    sec_main_accounts: 'üë§ Main Accounts',
    sec_main_accounts_desc: 'Add and edit main accounts. Changes are saved to data/accounts.json.',
    sec_url_pool: 'üîó Search URL Pool',
    sec_url_pool_desc: 'Add search URLs ‚Äî they will appear as checkboxes on each account card.',
    sec_letters: '‚úâÔ∏è Letter Templates',
    sec_letters_desc: 'Create named templates ‚Äî they will appear in the dropdown on each account card.',
    sec_questionnaire: 'üìù Questionnaire Templates',
    sec_questionnaire_desc: 'When a vacancy requires a survey ‚Äî the bot will fill it automatically.',
    sec_cookies: 'üîë Update Account Cookies',
    sec_sessions: 'üåê Browser Sessions',
    // Account form
    acc_field_name: 'Full name',
    acc_field_short: 'Short name',
    acc_field_color: 'Color',
    acc_ph_name: 'Ivan (main)',
    acc_ph_short: 'main',
    acc_cookies_label: 'Cookies (cURL or string)',
    btn_add: '‚úÖ Add',
    btn_add_account: 'Ôºã Add account',
    btn_add_url: 'Ôºã Add URL',
    btn_save_pool: 'üíæ Save pool',
    btn_add_template: 'Ôºã Add template',
    btn_save_templates: 'üíæ Save templates',
    // Questionnaire
    q_keywords_ph: 'experience, work, QA',
    q_keywords_label: 'Keywords (comma-separated)',
    q_answer_label: 'Answer',
    q_default_label: 'Default answer (if no template matched)',
    q_default_ph: 'I\'d be happy to share more details at the interview.',
    // Cookies section
    ck_desc: 'Paste new cURL or cookie string: hhtoken=‚Ä¶',
    btn_update_cookies: 'üîë Update cookies',
    // Sessions
    sess_add: '‚ûï Add browser session',
    sess_mode_curl: 'cURL / string',
    sess_mode_manual: 'Manual',
    sess_curl_desc: 'Easiest way ‚Äî Copy as cURL',
    sess_name_label: 'Name (optional)',
    sess_name_ph: 'e.g.: Maria',
    sess_letter_label: 'Cover letter (optional)',
    btn_connect: 'üîó Connect session',
    sess_active: 'üü¢ active',
    sess_inactive: '‚≠ï inactive',
    // Confirm dialogs
    confirm_delete: 'Delete',
    confirm_cancel: 'Cancel',
    // Shortcuts
    shortcuts_title: '‚å®Ô∏è Keyboard Shortcuts',
    shortcuts_tabs: 'Switch tab',
    shortcuts_pause: 'Pause / resume all',
    shortcuts_help: 'This window',
    shortcuts_esc: 'Close this window',
    btn_close: 'Close',
    // Notifications
    notif_new_inv: 'üì¨ New invitation ‚Äî ',
    notif_inv_count_pre: 'Now',
    notif_inv_count_mid: 'interviews (+',
    notif_limit: 'üö´ Limit ‚Äî ',
    notif_limit_body: 'Daily reply limit reached',
    notif_cookies: '‚ö†Ô∏è Cookies expired ‚Äî ',
    notif_cookies_body: 'Update cookies in account settings',
    // Page titles
    title_limit: 'üö´ LIMIT | HH Bot',
    title_paused: '‚è∏ Paused | HH Bot',
    // Confirm dialog texts
    confirm_del_acc_pre: 'Delete account',
    confirm_del_acc_body: 'Worker will be stopped.',
    confirm_del_db_pre: 'Delete',
    confirm_del_db_mid: 'from DB?',
    confirm_del_db_body: 'Bot will be able to apply again.',
    confirm_del_sess: 'Delete browser session?',
  }
};

function t(key) {
  return (T[lang]?.[key]) ?? (T.ru[key]) ?? key;
}

function applyI18n() {
  document.documentElement.lang = lang;
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    const val = t(key);
    // For th elements with sort arrows, preserve the arrow span
    const arrow = el.querySelector('.sort-arrow');
    if (arrow) {
      // Replace text before the arrow span
      const nodes = Array.from(el.childNodes);
      const textNode = nodes.find(n => n.nodeType === Node.TEXT_NODE);
      if (textNode) textNode.textContent = val + ' ';
      else el.insertBefore(document.createTextNode(val + ' '), el.firstChild);
    } else {
      el.textContent = val;
    }
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    el.placeholder = t(el.dataset.i18nPh);
  });
  // Rebuild settings labels/hints
  document.querySelectorAll('[data-setting-label]').forEach(el => {
    const key = el.dataset.settingLabel;
    const def = SETTINGS_DEF.find(s => s.key === key);
    if (def) {
      const span = el.querySelector('span');
      el.textContent = t(def.labelKey) + ' ';
      if (span) el.appendChild(span);
    }
  });
  document.querySelectorAll('[data-setting-desc]').forEach(el => {
    const key = el.dataset.settingDesc;
    const def = SETTINGS_DEF.find(s => s.key === key);
    if (def) el.textContent = t(def.descKey);
  });
  if (State && State.lastSnapshot) {
    try { renderAll(State.lastSnapshot); } catch(e) {}
  }
}

function toggleLang() {
  lang = lang === 'ru' ? 'en' : 'ru';
  localStorage.setItem('hh-lang', lang);
  document.getElementById('lang-btn').textContent = lang.toUpperCase();
  applyI18n();
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const State = {
  ws: null,
  lastSnapshot: null,
  currentTab: 'main',
  reconnectDelay: 1000,
  reconnectTimer: null,
  logNodeCount: 0,
  MAX_LOG_NODES: 100,
  prevInterviews: {},      // {acc_idx: count} ‚Äî –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  prevLimitState: {},      // {acc_idx: bool}
  prevCookiesExpired: {},  // {acc_idx: bool}
  compactCards: new Set(), // idx –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
  logLevel: '',          // —Ñ–∏–ª—å—Ç—Ä —É—Ä–æ–≤–Ω—è –ª–æ–≥–∞
};
const AppliedSort = { field: 'at', dir: -1 };  // -1=desc 1=asc
const DBSort      = { field: 'at', dir: -1 };

// Settings config definition
const SETTINGS_DEF = [
  { key: 'pages_per_url',        labelKey: 'lbl_pages_per_url',        descKey: 'hint_pages_per_url',        min: 5,  max: 100, step: 5  },
  { key: 'response_delay',       labelKey: 'lbl_response_delay',       descKey: 'hint_response_delay',       min: 0,  max: 30,  step: 1  },
  { key: 'pause_between_cycles', labelKey: 'lbl_pause_between_cycles', descKey: 'hint_pause_between_cycles', min: 15, max: 600, step: 15 },
  { key: 'batch_responses',      labelKey: 'lbl_batch_responses',      descKey: 'hint_batch_responses',      min: 1,  max: 10,  step: 1  },
  { key: 'limit_check_interval', labelKey: 'lbl_limit_check_interval', descKey: 'hint_limit_check_interval', min: 5,  max: 120, step: 5  },
  { key: 'min_salary',           labelKey: 'lbl_min_salary',           descKey: 'hint_min_salary',           min: 0,  max: 300000, step: 10000 },
  { key: 'auto_pause_errors',    labelKey: 'lbl_auto_pause_errors',    descKey: 'hint_auto_pause_errors',    min: 0,  max: 20,  step: 1  },
];

// Build settings UI once
function buildSettings() {
  const grid = document.getElementById('settings-grid');
  grid.innerHTML = '';
  SETTINGS_DEF.forEach(s => {
    const row = document.createElement('div');
    row.className = 'setting-row';
    row.dataset.settingKey = s.key;
    row.innerHTML = `
      <div class="setting-label" data-setting-label="${s.key}">${t(s.labelKey)} <span id="sv-${s.key}">‚Äî</span></div>
      <div class="setting-desc" data-setting-desc="${s.key}">${t(s.descKey)}</div>
      <input type="range" id="sr-${s.key}" min="${s.min}" max="${s.max}" step="${s.step}" value="${s.min}"
        oninput="document.getElementById('sv-${s.key}').textContent=this.value">
    `;
    grid.appendChild(row);
  });
}

// ‚îÄ‚îÄ Letter templates (Settings) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ltRenderTemplates(templates) {
  const list = document.getElementById('lt-templates-list');
  if (!list) return;
  list.innerHTML = '';
  (templates || []).forEach((t, i) => {
    const row = document.createElement('div');
    row.className = 'q-template-row';
    row.dataset.idx = i;
    row.innerHTML =
      `<button class="q-del-btn" onclick="ltDelTemplate(${i})">‚úï</button>` +
      `<div style="flex:1">` +
        `<input class="q-keywords-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–∞–ø—Ä: IT, –ê–Ω–∞–ª–∏—Ç–∏–∫)" value="${esc(t.name||'')}">` +
        `<textarea class="q-answer-input" rows="3" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞...">${esc(t.text||'')}</textarea>` +
      `</div>`;
    list.appendChild(row);
  });
}

function ltAddTemplate() {
  const list = document.getElementById('lt-templates-list');
  if (!list) return;
  const i = list.children.length;
  const row = document.createElement('div');
  row.className = 'q-template-row';
  row.dataset.idx = i;
  row.innerHTML =
    `<button class="q-del-btn" onclick="ltDelTemplate(${i})">‚úï</button>` +
    `<div style="flex:1">` +
      `<input class="q-keywords-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞">` +
      `<textarea class="q-answer-input" rows="3" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞..."></textarea>` +
    `</div>`;
  list.appendChild(row);
}

function ltDelTemplate(idx) {
  const list = document.getElementById('lt-templates-list');
  if (!list) return;
  const rows = list.querySelectorAll('.q-template-row');
  if (rows[idx]) rows[idx].remove();
  // Re-index delete buttons
  list.querySelectorAll('.q-template-row').forEach((r, i) => {
    r.dataset.idx = i;
    const btn = r.querySelector('.q-del-btn');
    if (btn) btn.onclick = () => ltDelTemplate(i);
  });
}

function ltReadTemplates() {
  const list = document.getElementById('lt-templates-list');
  if (!list) return [];
  return Array.from(list.querySelectorAll('.q-template-row')).map(r => ({
    name: (r.querySelector('.q-keywords-input')?.value || '').trim(),
    text: (r.querySelector('.q-answer-input')?.value || '').trim(),
  })).filter(t => t.name || t.text);
}

function ltSave() {
  const templates = ltReadTemplates();
  sendCmd({ type: 'set_letter_templates', templates });
  const st = document.getElementById('lt-status');
  if (st) { st.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(() => { st.textContent = ''; }, 3000); }
}

function ltSyncFromSnapshot(snap) {
  const templates = snap?.config?.letter_templates || [];
  ltRenderTemplates(templates);
}

// ‚îÄ‚îÄ LLM multi-profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _llmDetectTimers = {};

function llmProfileAdd(profile) {
  const p = profile || {name: '', api_key: '', base_url: '', model: '', enabled: true};
  const list = document.getElementById('llm-profiles-list');
  const idx = list.children.length;
  const row = document.createElement('div');
  row.className = 'llm-profile-row' + (p.enabled === false ? ' disabled' : '');
  row.dataset.idx = idx;
  row.innerHTML = `
    <div class="llm-profile-row-header">
      <input class="apply-input lp-name" style="font-size:11px;flex:1" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: DeepSeek)" value="${esc(p.name||'')}">
      <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;white-space:nowrap">
        <input type="checkbox" class="lp-enabled" ${p.enabled !== false ? 'checked' : ''} style="accent-color:var(--cyan)"> –í–∫–ª
      </label>
      <button class="btn-sm" style="color:var(--red);border-color:var(--red);padding:1px 8px" onclick="this.closest('.llm-profile-row').remove();llmProfileReindex()">‚úï</button>
    </div>
    <div class="llm-profile-fields">
      <div>
        <div style="font-size:10px;color:var(--dim);margin-bottom:2px">API Key</div>
        <input class="apply-input lp-key" type="password" style="font-size:11px" placeholder="sk-..." value="${esc(p.api_key||'')}" oninput="llmProfileDetectDebounce(this)">
      </div>
      <div>
        <div style="font-size:10px;color:var(--dim);margin-bottom:2px">–ú–æ–¥–µ–ª—å</div>
        <input class="apply-input lp-model" style="font-size:11px" placeholder="gpt-4o-mini" value="${esc(p.model||'')}">
      </div>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <div style="flex:1">
        <div style="font-size:10px;color:var(--dim);margin-bottom:2px">Base URL</div>
        <input class="apply-input lp-url" style="font-size:11px" placeholder="https://api.openai.com/v1" value="${esc(p.base_url||'')}">
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;padding-top:14px">
        <button class="btn-sm" onclick="llmProfileDetect(this.closest('.llm-profile-row'))" title="–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª–∏">üîç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
        <span class="lp-status" style="font-size:10px;color:var(--dim)"></span>
      </div>
    </div>
  `;
  list.appendChild(row);
}

function llmProfileReindex() {
  document.querySelectorAll('#llm-profiles-list .llm-profile-row').forEach((row, i) => { row.dataset.idx = i; });
}

function llmProfileDetectDebounce(keyInput) {
  const row = keyInput.closest('.llm-profile-row');
  const idx = row.dataset.idx;
  clearTimeout(_llmDetectTimers[idx]);
  _llmDetectTimers[idx] = setTimeout(() => llmProfileDetect(row), 900);
}

async function llmProfileDetect(row) {
  const keyEl = row.querySelector('.lp-key');
  const urlEl = row.querySelector('.lp-url');
  const modelEl = row.querySelector('.lp-model');
  const st = row.querySelector('.lp-status');
  const key = keyEl?.value.trim() || '';
  if (!key || key.length < 8) return;
  if (st) { st.textContent = '‚è≥...'; st.style.color = 'var(--dim)'; }
  try {
    const res = await fetch('/api/llm_detect', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({api_key: key, base_url: urlEl?.value.trim() || ''})
    });
    const data = await res.json();
    if (!data.ok) {
      if (st) { st.textContent = '‚ùå ' + (data.error||'').slice(0,40); st.style.color = 'var(--red)'; }
      return;
    }
    if (data.base_url && urlEl && !urlEl.value.trim()) urlEl.value = data.base_url;
    if (data.models?.length) {
      if (modelEl && !modelEl.value.trim()) modelEl.value = data.models[0];
      if (st) { st.textContent = `‚úÖ ${data.models.length} –º–æ–¥–µ–ª–µ–π`; st.style.color = 'var(--green)'; }
      llmShowModelPicker(row, data.base_url, data.models);
    } else {
      if (st) { st.textContent = '‚ö†Ô∏è –ù–µ—Ç –º–æ–¥–µ–ª–µ–π'; st.style.color = 'var(--yellow)'; }
    }
  } catch(e) {
    if (st) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  }
}

function llmShowModelPicker(row, base_url, models) {
  row.querySelector('.lp-model-picker')?.remove();
  const modelEl = row.querySelector('.lp-model');
  const picker = document.createElement('select');
  picker.className = 'apply-input lp-model-picker';
  picker.style.cssText = 'font-size:11px;margin-top:4px;width:100%';
  picker.innerHTML = '<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö ‚Äî</option>' +
    models.map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join('');
  picker.onchange = () => {
    if (picker.value) { modelEl.value = picker.value; picker.remove(); }
  };
  modelEl.parentElement.appendChild(picker);
}

function llmProfilesRead() {
  const rows = document.querySelectorAll('#llm-profiles-list .llm-profile-row');
  return [...rows].map(row => ({
    name: row.querySelector('.lp-name')?.value.trim() || '',
    api_key: row.querySelector('.lp-key')?.value.trim() || '',
    base_url: row.querySelector('.lp-url')?.value.trim() || '',
    model: row.querySelector('.lp-model')?.value.trim() || '',
    enabled: row.querySelector('.lp-enabled')?.checked ?? true,
  }));
}

async function llmSave(btn) {
  const st = document.getElementById('llm-status');
  if (btn) btn.disabled = true;
  if (st) st.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é...';
  try {
    const profiles = llmProfilesRead();
    const mode = document.getElementById('llm-profile-mode')?.value || 'fallback';
    // Save profiles separately
    await fetch('/api/llm_profiles', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({profiles, mode})
    });
    // Save other settings via llm_config
    const res = await fetch('/api/llm_config', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        system_prompt: document.getElementById('llm-system-prompt')?.value || '',
        enabled: document.getElementById('llm-enabled')?.checked || false,
        auto_send: document.getElementById('llm-auto-send')?.checked || false,
        use_cover_letter: document.getElementById('llm-use-cover-letter')?.checked ?? true,
        use_resume: document.getElementById('llm-use-resume')?.checked ?? true,
        api_key: profiles[0]?.api_key || '',
        base_url: profiles[0]?.base_url || '',
        model: profiles[0]?.model || '',
      })
    });
    const data = await res.json();
    if (st) { st.textContent = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (${profiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π)`; st.style.color = 'var(--green)'; }
  } catch(e) {
    if (st) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  } finally {
    if (btn) btn.disabled = false;
    setTimeout(() => { if (st) { st.textContent = ''; st.style.color = ''; } }, 4000);
  }
}

async function llmGlobalToggle(btn) {
  if (btn) btn.disabled = true;
  try {
    const res = await fetch('/api/llm_toggle', {method: 'POST'});
    const data = await res.json();
    _llmUpdateToggleBtn(data.llm_enabled);
  } catch(e) {}
  finally { if (btn) btn.disabled = false; }
}

function _llmUpdateToggleBtn(enabled) {
  const btn = document.getElementById('llm-global-toggle-btn');
  if (!btn) return;
  if (enabled) {
    btn.textContent = '‚ñ∂Ô∏è –í–ö–õ';
    btn.style.color = 'var(--green)';
    btn.style.borderColor = 'var(--green)';
  } else {
    btn.textContent = '‚è∏ –í–´–ö–õ';
    btn.style.color = 'var(--dim)';
    btn.style.borderColor = 'var(--dim)';
  }
}

function syncLlmSettings(snap) {
  const cfg = snap?.config || {};
  const as = document.getElementById('llm-auto-send');
  const cl = document.getElementById('llm-use-cover-letter');
  const ur = document.getElementById('llm-use-resume');
  const fq = document.getElementById('llm-fill-questionnaire');
  const modeEl = document.getElementById('llm-profile-mode');
  if (as && cfg.llm_auto_send !== undefined) as.checked = cfg.llm_auto_send;
  if (cl && cfg.llm_use_cover_letter !== undefined) cl.checked = cfg.llm_use_cover_letter;
  if (ur && cfg.llm_use_resume !== undefined) ur.checked = cfg.llm_use_resume;
  if (fq && cfg.llm_fill_questionnaire !== undefined) fq.checked = cfg.llm_fill_questionnaire;
  if (modeEl && cfg.llm_profile_mode) modeEl.value = cfg.llm_profile_mode;
  // Update the global toggle button
  if (cfg.llm_enabled !== undefined) _llmUpdateToggleBtn(cfg.llm_enabled);
  // Render profiles only if list is empty to avoid wiping user edits
  const list = document.getElementById('llm-profiles-list');
  if (list && list.children.length === 0 && cfg.llm_profiles?.length) {
    cfg.llm_profiles.forEach(p => llmProfileAdd(p));
  }
  // Populate account selector for resume preview
  const sel = document.getElementById('llm-resume-acc-sel');
  if (sel && snap?.accounts?.length && sel.options.length !== snap.accounts.length) {
    sel.innerHTML = snap.accounts.map(a =>
      `<option value="${a.idx}">${esc(a.short || a.name)}</option>`).join('');
  }
}

// ‚îÄ‚îÄ LLM resume preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function llmPreviewResume(btn) {
  const sel = document.getElementById('llm-resume-acc-sel');
  const pre = document.getElementById('llm-resume-preview');
  const st  = document.getElementById('llm-resume-status');
  const idx = sel?.value;
  if (!idx && idx !== 0) return;
  if (btn) btn.disabled = true;
  if (st) { st.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é‚Ä¶'; st.style.color = 'var(--dim)'; }
  try {
    const res = await fetch(`/api/account/${idx}/resume_text`);
    const data = await res.json();
    if (data.ok && data.text) {
      if (pre) { pre.textContent = data.text; pre.style.display = ''; }
      if (st) { st.textContent = `‚úÖ ${data.length} —Å–∏–º–≤.`; st.style.color = 'var(--green)'; }
    } else {
      if (pre) { pre.style.display = 'none'; }
      if (st) { st.textContent = '‚ö†Ô∏è –†–µ–∑—é–º–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å (–ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç). –ü—Ä–æ–≤–µ—Ä—å –∫—É–∫–∏.'; st.style.color = 'var(--yellow)'; }
    }
  } catch(e) {
    if (st) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  } finally {
    if (btn) btn.disabled = false;
  }
}

// ‚îÄ‚îÄ LLM per-account toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function llmToggleAccount(idx, btn) {
  sendCmd({type: 'account_llm', idx});
}

// ‚îÄ‚îÄ LLM tab: interviews from DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function llmInterviewsLoad() {
  if (_llmLoading) return;   // —É–∂–µ –∏–¥—ë—Ç –∑–∞–ø—Ä–æ—Å ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π
  _llmLoading = true;
  const acc = document.getElementById('llm-log-acc-filter')?.value || '';
  const statusF = document.getElementById('llm-log-sent-filter')?.value || '';
  let url = `/api/interviews?limit=2000${acc ? '&acc=' + encodeURIComponent(acc) : ''}${statusF ? '&status=' + encodeURIComponent(statusF) : ''}`;
  let rows;
  try {
    const res = await fetch(url);
    rows = await res.json();
    _llmLastDbRefresh = Date.now();
  } catch(e) {
    _llmLoading = false;
    return; // –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–ª–∏—Ü—ã
  } finally {
    _llmLoading = false;
  }

  const table = document.getElementById('llm-interviews-table');
  const empty = document.getElementById('llm-interviews-empty');
  const countEl = document.getElementById('llm-log-count');
  const tbody = document.getElementById('llm-interviews-body');
  if (!tbody) return;
  if (countEl) countEl.textContent = rows.length ? `${rows.length} –∑–∞–ø–∏—Å–µ–π` : '';

  if (rows.length === 0) {
    const hasRows = tbody.querySelectorAll('tr').length > 0 &&
                    !tbody.querySelector('tr td[colspan]');
    if (statusF || acc) {
      // –§–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–∞–±–ª–∏—Ü—É –Ω–µ –ø—Ä—è—á–µ–º
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--dim);padding:12px">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É</td></tr>`;
      if (table) table.style.display = '';
      if (empty) empty.style.display = 'none';
    } else if (!hasRows) {
      // –¢–∞–±–ª–∏—Ü–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—É—Å—Ç–∞ –∏ —Ä–∞–Ω—å—à–µ –±—ã–ª–∞ –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
      if (table) table.style.display = 'none';
      if (empty) empty.style.display = '';
    }
    // –ï—Å–ª–∏ hasRows && –Ω–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–∏–∑–±–µ–≥–∞–µ–º –º–∏–≥–∞–Ω–∏—è)
    return;
  }
  if (table) table.style.display = '';
  if (empty) empty.style.display = 'none';

  const statusBadge = s => {
    if (s === 'replied')         return '<span class="llm-sent-badge">‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>';
    if (s === 'draft')           return '<span class="llm-draft-badge">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</span>';
    if (s === 'pending_reply')   return '<span style="color:var(--yellow);font-size:11px">‚è≥ –ñ–¥—ë—Ç</span>';
    if (s === 'chat_closed')     return '<span style="color:var(--dim);font-size:11px">üîí –ó–∞–∫—Ä—ã—Ç</span>';
    return '<span style="color:var(--dim);font-size:11px">‚Äî –Ω–µ—Ç</span>';
  };

  tbody.innerHTML = rows.map(r => {
    const empMsg = esc(r.employer_last_msg || '‚Äî').replace(/\n/g, '<br>');
    const botReply = esc(r.llm_reply || '').replace(/\n/g, '<br>');
    const negLink = r.neg_id
      ? `<a href="https://hh.ru/chat/${r.neg_id}" target="_blank" style="font-size:10px;color:var(--cyan)">üîó</a>` : '';
    const dateStr = (r.last_seen || r.first_seen || '').replace('T', ' ').slice(0, 16);
    return `<tr>
      <td style="font-size:11px;color:var(--dim);white-space:nowrap">${dateStr}</td>
      <td style="font-size:11px;color:${colorVar(r.acc_color||'')}">${esc(r.acc||'')}</td>
      <td style="font-size:11px">${esc(r.employer||'')} ${negLink}</td>
      <td style="font-size:11px;color:var(--dim)">${esc(r.vacancy_title||'')}</td>
      <td class="llm-msg-cell">${empMsg}</td>
      <td class="llm-reply-cell">${botReply}</td>
      <td>${statusBadge(r.status)}</td>
    </tr>`;
  }).join('');

  // Populate account filter from loaded data
  const accSel = document.getElementById('llm-log-acc-filter');
  if (accSel) {
    const known = new Set([...accSel.options].map(o => o.value).filter(Boolean));
    rows.forEach(r => {
      if (r.acc && !known.has(r.acc)) {
        const opt = document.createElement('option');
        opt.value = r.acc; opt.textContent = r.acc;
        accSel.appendChild(opt);
        known.add(r.acc);
      }
    });
  }

  // Per-account stats (always from full unfiltered data ‚Äî re-fetch all)
  llmRenderAccStats();
}

async function llmRenderAccStats() {
  const statsEl = document.getElementById('llm-acc-stats');
  if (!statsEl) return;
  let all;
  try {
    const res = await fetch('/api/interviews?limit=2000');
    all = await res.json();
  } catch(e) { return; }

  // Group by acc
  const byAcc = {};
  all.forEach(r => {
    const a = r.acc || '?';
    if (!byAcc[a]) byAcc[a] = {acc: a, color: r.acc_color || '', pending: 0, draft: 0, replied: 0, total: 0};
    byAcc[a].total++;
    if (r.status === 'pending_reply') byAcc[a].pending++;
    else if (r.status === 'draft')    byAcc[a].draft++;
    else if (r.status === 'replied')  byAcc[a].replied++;
  });

  statsEl.innerHTML = Object.values(byAcc).map(a => `
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:8px 14px;min-width:160px">
      <div style="font-size:12px;font-weight:700;color:${colorVar(a.color)};margin-bottom:6px">${esc(a.acc)}</div>
      <div style="display:flex;gap:10px;font-size:12px">
        <span title="–ñ–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞">‚è≥ <b>${a.pending}</b></span>
        <span title="–ß–µ—Ä–Ω–æ–≤–∏–∫" style="color:var(--yellow)">üìù <b>${a.draft}</b></span>
        <span title="–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" style="color:var(--green)">‚úÖ <b>${a.replied}</b></span>
      </div>
    </div>`).join('');
}

async function llmRunNow(btn) {
  btn.disabled = true; btn.textContent = '‚è≥‚Ä¶';
  try {
    await fetch('/api/llm_run_now', {method:'POST'});
    btn.textContent = '‚úÖ –ó–∞–ø—É—â–µ–Ω–æ';
    setTimeout(() => { btn.textContent = '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å'; btn.disabled = false; }, 3000);
    setTimeout(() => llmInterviewsLoad(), 8000);
  } catch(e) {
    btn.textContent = '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å'; btn.disabled = false;
  }
}

async function llmResetReplied(btn) {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ¬´—É–∂–µ –æ—Ç–≤–µ—á–∞–ª–∏¬ª –¥–ª—è –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤?\n\n–ë–æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ —á–∞—Ç—ã —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ.')) return;
  const orig = btn.textContent;
  btn.disabled = true; btn.textContent = '‚è≥‚Ä¶';
  try {
    const r = await fetch('/api/llm_reset_replied', {method:'POST'});
    const data = await r.json();
    btn.textContent = '‚úÖ –°–±—Ä–æ—à–µ–Ω–æ';
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 4000);
  } catch(e) {
    btn.textContent = orig; btn.disabled = false;
  }
}

// ‚îÄ‚îÄ LLM log tab: debug log from WS snapshot + auto-refresh DB ‚îÄ
let _llmLastDbRefresh = 0;
let _llmDebugHash = '';
let _llmLoading = false;   // guard: only one fetch at a time
function _llmUpdateAccToggles(snap) {
  const container = document.getElementById('llm-acc-toggles');
  if (!container || !snap?.accounts) return;
  const accs = snap.accounts;
  // Add missing buttons
  accs.forEach(acc => {
    let btn = document.getElementById(`llm-acc-btn-${acc.idx}`);
    if (!btn) {
      btn = document.createElement('button');
      btn.id = `llm-acc-btn-${acc.idx}`;
      btn.style.cssText = 'padding:4px 10px;border-radius:4px;border:1px solid;cursor:pointer;font-size:11px;background:transparent;transition:color .15s,border-color .15s';
      btn.setAttribute('data-idx', acc.idx);
      btn.onclick = function() { llmToggleAccount(acc.idx, this); };
      container.appendChild(btn);
    }
    // Update label and color
    const on = acc.llm_enabled !== false;
    btn.textContent = `ü§ñ ${esc(acc.short || acc.name)}`;
    btn.style.color = on ? colorVar(acc.color || 'green') : 'var(--dim)';
    btn.style.borderColor = on ? colorVar(acc.color || 'green') : 'var(--dim)';
    btn.style.opacity = on ? '1' : '0.5';
    btn.title = on ? 'LLM –≤–∫–ª ‚Äî –Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≤—ã–∫–ª—é—á–∏—Ç—å' : 'LLM –≤—ã–∫–ª ‚Äî –Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å';
  });
  // Remove stale buttons
  const idxSet = new Set(accs.map(a => String(a.idx)));
  container.querySelectorAll('[id^="llm-acc-btn-"]').forEach(btn => {
    const i = btn.id.replace('llm-acc-btn-', '');
    if (!idxSet.has(i)) btn.remove();
  });
}

function renderLlmLog(snap) {
  if (!snap) return;

  // Update per-account LLM toggles
  _llmUpdateAccToggles(snap);

  // Auto-refresh interviews table from DB every 30s
  const now = Date.now();
  if (now - _llmLastDbRefresh > 30000) {
    _llmLastDbRefresh = now;
    llmInterviewsLoad();
  }

  // Update debug log from activity log ‚Äî preserve scroll position
  const debugBox = document.getElementById('llm-debug-log');
  const debugCount = document.getElementById('llm-debug-count');
  if (debugBox && snap.log) {
    const debugEntries = snap.log.filter(e => (e.message || '').includes('ü§ñ') || (e.message || '').includes('LLM'));
    // Skip rebuild if content hasn't changed
    const newHash = debugEntries.map(e => e.time + e.message).join('|');
    if (newHash === _llmDebugHash) return;
    _llmDebugHash = newHash;
    if (debugCount) debugCount.textContent = debugEntries.length ? `(${debugEntries.length})` : '';
    // Preserve scroll position
    const wasAtBottom = debugBox.scrollHeight - debugBox.scrollTop <= debugBox.clientHeight + 4;
    const savedTop = debugBox.scrollTop;
    debugBox.innerHTML = debugEntries.length === 0
      ? '<span style="color:var(--dim)">–ù–µ—Ç LLM-–∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–µ. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ ~15 –º–∏–Ω –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ HH-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</span>'
      : debugEntries.map(e => {
          const lvlColor = e.level === 'error' ? 'var(--red)' : e.level === 'warning' ? 'var(--yellow)' : e.level === 'success' ? 'var(--green)' : 'var(--dim)';
          const chatLink = e.neg_id ? `<a href="https://hh.ru/chat/${e.neg_id}" target="_blank" style="color:var(--cyan);text-decoration:none" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">üîó</a> ` : '';
          return `<div style="line-height:1.5"><span style="color:var(--dim)">${esc(e.time||'')}</span> <span style="color:${colorVar(e.color)}">${esc(e.acc||'')}</span> ${chatLink}<span style="color:${lvlColor}">${esc(e.message||'')}</span></div>`;
        }).join('');
    // Restore scroll: if was at bottom stay at bottom, otherwise restore position
    if (wasAtBottom) debugBox.scrollTop = debugBox.scrollHeight;
    else debugBox.scrollTop = savedTop;
  }
}

// ‚îÄ‚îÄ Letter in account cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncLetterSelects(snap) {
  const templates = snap?.config?.letter_templates || [];
  if (!templates.length) return;
  document.querySelectorAll('[id^="acc-letter-tpl-"]').forEach(sel => {
    const idx = sel.id.replace('acc-letter-tpl-', '');
    const ta = document.getElementById('acc-letter-ta-' + idx);
    const curText = ta?.value || '';
    const matched = templates.findIndex(t => t.text === curText);
    // Rebuild only if count differs or first option is wrong
    const needsRebuild = sel.options.length !== templates.length + 2 ||
      (templates.length > 0 && sel.options[1]?.text !== templates[0].name);
    if (!needsRebuild) return;
    sel.innerHTML = '<option value="">‚Äî –ø—É—Å—Ç–æ ‚Äî</option>' +
      templates.map((t, i) => `<option value="${i}"${matched===i?' selected':''}>${esc(t.name)}</option>`).join('') +
      '<option value="__custom__"' + (curText && matched === -1 ? ' selected' : '') + '>‚úèÔ∏è –°–≤–æ—ë</option>';
  });
}

function letterPickTpl(idx) {
  const sel = document.getElementById('acc-letter-tpl-' + idx);
  const ta  = document.getElementById('acc-letter-ta-'  + idx);
  if (!sel || !ta) return;
  const val = sel.value;
  if (val === '' ) { ta.value = ''; return; }
  if (val === '__custom__') { ta.focus(); return; }
  const templates = State.lastSnapshot?.config?.letter_templates || [];
  const tpl = templates[parseInt(val)];
  if (tpl) ta.value = tpl.text;
}

async function letterSave(idx, btn) {
  const ta = document.getElementById('acc-letter-ta-' + idx);
  const st = document.getElementById('acc-letter-st-' + idx);
  if (btn) btn.disabled = true;
  if (st) { st.textContent = '‚è≥...'; st.style.color = 'var(--dim)'; }
  try {
    const res = await fetch(`/api/account/${idx}/set_letter`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ letter: ta?.value || '' })
    });
    const data = await res.json();
    if (data.ok) {
      if (st) { st.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; st.style.color = 'var(--green)'; }
      // Update ApplyLetters cache
      ApplyLetters[idx] = ta?.value || '';
    } else {
      if (st) { st.textContent = '‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'); st.style.color = 'var(--red)'; }
    }
  } catch(e) {
    if (st) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  } finally {
    if (btn) { btn.disabled = false; }
    if (st) setTimeout(() => { if (st.textContent !== '') st.textContent = ''; }, 4000);
  }
}

// ‚îÄ‚îÄ Search URLs section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HH_AREAS = {
  '1':'–ú–æ—Å–∫–≤–∞','2':'–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥','3':'–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥','4':'–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
  '5':'–ö–∞–∑–∞–Ω—å','16':'–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥','54':'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä','88':'–†–æ—Å—Å–∏—è','1001':'–°–ù–ì'
};
const HH_EXP = {
  'noExperience':'–±–µ–∑ –æ–ø—ã—Ç–∞','between1And3':'1‚Äì3 –≥–æ–¥–∞',
  'between3And6':'3‚Äì6 –ª–µ—Ç','moreThan6':'6+ –ª–µ—Ç'
};
const HH_SCHEDULE = {
  'fullDay':'–ø–æ–ª–Ω—ã–π –¥–µ–Ω—å','shift':'—Å–º–µ–Ω–Ω—ã–π','flexible':'–≥–∏–±–∫–∏–π',
  'remote':'—É–¥–∞–ª—ë–Ω–Ω–æ','flyInFlyOut':'–≤–∞—Ö—Ç–∞'
};

function parseUrlFilter(url) {
  try {
    const u = new URL(url.startsWith('http') ? url : 'https://' + url);
    const p = u.searchParams;
    const parts = [];

    const text = p.get('text');
    if (text) parts.push('üîç ' + decodeURIComponent(text.replace(/\+/g,' ')));

    const resume = p.get('resume');
    if (resume && !text) parts.push('üìÑ –ü–æ —Ä–µ–∑—é–º–µ');

    const area = p.get('area');
    if (area) parts.push('üìç ' + (HH_AREAS[area] || '—Ä–µ–≥–∏–æ–Ω ' + area));

    const exp = p.get('experience');
    if (exp) parts.push('‚è± ' + (HH_EXP[exp] || exp));

    const sal = p.get('salary');
    if (sal) parts.push('üí∞ –æ—Ç ' + Number(sal).toLocaleString('ru') + '‚ÇΩ');

    const sched = p.get('schedule');
    if (sched) parts.push(HH_SCHEDULE[sched] || sched);

    const role = p.get('professional_role');
    if (role) parts.push('üëî —Ä–æ–ª—å ' + role);

    const order = p.get('order_by');
    if (order === 'publication_time') parts.push('üïê –ø–æ –¥–∞—Ç–µ');
    else if (order === 'salary_desc') parts.push('üíπ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ‚Üì');

    return parts.length ? parts.join('  ') : 'üîó ' + u.pathname;
  } catch(e) { return url; }
}

// ‚îÄ‚îÄ URL pool (Settings) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPoolRow(item, rowIdx) {
  const url = typeof item === 'string' ? item : (item?.url || '');
  const pages = typeof item === 'object' && item !== null ? (item?.pages ?? '') : '';
  const badge = parseUrlFilter(url);
  return `<div class="url-row" id="pool-row-${rowIdx}">
    <div class="url-badge">${badge}</div>
    <div style="display:flex;gap:4px;align-items:center">
      <input class="apply-input url-input" style="font-size:10px;padding:2px 6px;flex:1"
        value="${esc(url)}" oninput="urlPoolReparse(${rowIdx},this.value)">
      <input type="number" class="apply-input url-pages-input" min="1" max="200"
        style="font-size:10px;padding:2px 4px;width:54px;text-align:center"
        placeholder="—Å—Ç—Ä." title="–ì–ª—É–±–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ (—Å—Ç—Ä–∞–Ω–∏—Ü)" value="${esc(String(pages))}">
      <button class="btn-sm" style="padding:2px 7px;color:var(--red);border-color:var(--red)"
        onclick="urlPoolRemoveRow(${rowIdx})">‚úï</button>
    </div>
  </div>`;
}

function urlPoolReparse(rowIdx, val) {
  const badge = document.querySelector(`#pool-row-${rowIdx} .url-badge`);
  if (badge) badge.textContent = parseUrlFilter(val);
}

function urlPoolRemoveRow(rowIdx) {
  const row = document.getElementById(`pool-row-${rowIdx}`);
  if (row) row.remove();
  document.getElementById('url-pool-rows')?.querySelectorAll('.url-row').forEach((r, i) => {
    r.id = `pool-row-${i}`;
    const inp = r.querySelector('.url-input');
    if (inp) inp.oninput = function() { urlPoolReparse(i, this.value); };
    const btn = r.querySelector('button');
    if (btn) btn.onclick = () => urlPoolRemoveRow(i);
  });
}

function urlPoolAddRow() {
  const container = document.getElementById('url-pool-rows');
  if (!container) return;
  const rowIdx = container.querySelectorAll('.url-row').length;
  const div = document.createElement('div');
  div.innerHTML = buildPoolRow('', rowIdx);
  container.appendChild(div.firstElementChild);
}

async function urlPoolSave(btn) {
  const container = document.getElementById('url-pool-rows');
  if (!container) return;
  const globalPages = State.lastSnapshot?.config?.pages_per_url || 40;
  const urls = Array.from(container.querySelectorAll('.url-row')).map(row => {
    const urlInp = row.querySelector('.url-input');
    const pagesInp = row.querySelector('.url-pages-input');
    const url = urlInp?.value?.trim() || '';
    const pages = parseInt(pagesInp?.value) || globalPages;
    return {url, pages};
  }).filter(u => u.url);
  const st = document.getElementById('url-pool-st');
  if (btn) btn.disabled = true;
  if (st) { st.textContent = '‚è≥...'; st.style.color = 'var(--dim)'; }
  try {
    send({type: 'set_url_pool', urls});
    if (st) { st.textContent = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (${urls.length} URL)`; st.style.color = 'var(--green)'; }
  } catch(e) {
    if (st) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  } finally {
    if (btn) btn.disabled = false;
    setTimeout(() => { if (st) st.textContent = ''; }, 4000);
  }
}

function urlPoolBuild(snap) {
  const el = document.getElementById('url-pool-rows');
  if (!el || el.dataset.built === 'true') return;
  el.dataset.built = 'true';
  el.innerHTML = '';
  const pool = snap?.config?.url_pool || [];
  pool.forEach((item, i) => {
    const div = document.createElement('div');
    div.innerHTML = buildPoolRow(item, i);
    el.appendChild(div.firstElementChild);
  });
  if (!pool.length) {
    el.innerHTML = '<div style="font-size:11px;color:var(--dim)">–ü—É–ª –ø—É—Å—Ç–æ–π ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π URL</div>';
  }
}

// ‚îÄ‚îÄ URL selector on account cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncAccUrlChecks(snap) {
  const pool = snap?.config?.url_pool || [];
  (snap?.accounts || []).filter(a => !a.temp).forEach(acc => {
    const container = document.getElementById(`acc-url-checks-${acc.idx}`);
    const wrap = document.getElementById(`acc-url-wrap-${acc.idx}`);
    if (!container || (wrap && wrap.open)) return; // don't overwrite while user is choosing
    const selected = new Set(acc.urls || []);
    if (!pool.length) {
      container.innerHTML = '<div style="font-size:11px;color:var(--dim)">–ü—É–ª –ø—É—Å—Ç–æ–π ‚Äî –¥–æ–±–∞–≤—å—Ç–µ URL –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</div>';
      return;
    }
    const globalPages = State.lastSnapshot?.config?.pages_per_url || 40;
    container.innerHTML = pool.map((item, i) => {
      const url = typeof item === 'string' ? item : (item?.url || '');
      const poolPages = typeof item === 'object' && item?.pages ? item.pages : globalPages;
      // Per-account override (0 = use pool/global)
      const accPages = acc.url_pages?.[url] || '';
      const checked = selected.has(url) ? 'checked' : '';
      const badge = parseUrlFilter(url);
      const urlCount = acc.url_stats?.[url];
      const countInfo = urlCount != null ? `<span style="color:var(--green);font-size:10px;margin-left:4px">‚Üí${urlCount}</span>` : '';
      return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:5px">
        <label style="display:flex;align-items:flex-start;gap:5px;cursor:pointer;font-size:11px;flex:1;min-width:0">
          <input type="checkbox" value="${esc(url)}" ${checked} style="margin-top:2px;flex-shrink:0">
          <span style="color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${badge}${countInfo}</span>
        </label>
        <input type="number" class="apply-input acc-url-pages-inp" data-url="${esc(url)}"
          min="1" max="200" placeholder="${poolPages}"
          value="${esc(String(accPages))}"
          title="–ì–ª—É–±–∏–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ URL (–ø—É—Å—Ç–æ = ${poolPages} —Å—Ç—Ä. –∏–∑ –ø—É–ª–∞)"
          style="width:52px;font-size:10px;padding:2px 4px;text-align:center;flex-shrink:0">
      </div>`;
    }).join('');
  });
}

async function urlAccSave(accIdx, btn) {
  const container = document.getElementById(`acc-url-checks-${accIdx}`);
  if (!container) return;
  const urls = Array.from(container.querySelectorAll('input[type=checkbox]:checked'))
    .map(cb => cb.value).filter(Boolean);
  // Collect per-URL pages overrides
  const url_pages = {};
  container.querySelectorAll('.acc-url-pages-inp').forEach(inp => {
    const v = parseInt(inp.value);
    if (v > 0) url_pages[inp.dataset.url] = v;
  });
  const st = document.getElementById(`url-acc-st-${accIdx}`);
  if (btn) btn.disabled = true;
  if (st) { st.textContent = '‚è≥...'; st.style.color = 'var(--dim)'; }
  try {
    const res = await fetch(`/api/account/${accIdx}/set_urls`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({urls, url_pages})
    });
    const data = await res.json();
    if (data.ok) {
      if (st) { st.textContent = `‚úÖ ${data.count} URL`; st.style.color = 'var(--green)'; }
    } else {
      if (st) { st.textContent = '‚ùå ' + (data.error||'–û—à–∏–±–∫–∞'); st.style.color = 'var(--red)'; }
    }
  } catch(e) {
    if (st) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  } finally {
    if (btn) btn.disabled = false;
    setTimeout(() => { if (st) st.textContent = ''; }, 4000);
  }
}

// ‚îÄ‚îÄ Main accounts management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACC_COLORS = ['cyan','magenta','green','yellow','blue','red'];

async function accDeleteCard(idx, btn) {
  if (!await showConfirm(`–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç <b>#${idx}</b>? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) return;
  if (btn) btn.disabled = true;
  try {
    const res = await fetch(`/api/account/${idx}/delete`, {method: 'DELETE'});
    const data = await res.json();
    if (data.ok) {
      const card = document.getElementById('card-' + idx);
      if (card) card.remove();
    } else {
      alert('–û—à–∏–±–∫–∞: ' + (data.error || ''));
      if (btn) btn.disabled = false;
    }
  } catch(e) {
    alert('–û—à–∏–±–∫–∞: ' + e);
    if (btn) btn.disabled = false;
  }
}

// ‚îÄ‚îÄ Browser sessions management in Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildSessList(snap) {
  const el = document.getElementById('sess-list');
  if (!el) return;
  const sessions = (snap?.accounts || []).filter(a => a.temp);
  if (!sessions.length) {
    el.innerHTML = '<div style="font-size:11px;color:var(--dim);margin-bottom:8px">–ù–µ—Ç —Å–µ—Å—Å–∏–π ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –Ω–∏–∂–µ.</div>';
    return;
  }
  // Rebuild only if count changed
  if (el.dataset.count === String(sessions.length)) return;
  el.dataset.count = String(sessions.length);
  el.innerHTML = '';
  sessions.forEach(acc => {
    const div = document.createElement('div');
    div.id = `sess-row-${acc.idx}`;
    div.style.cssText = 'margin-bottom:8px;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px';
    div.innerHTML =
      `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">` +
        `<div>` +
          `<span style="font-size:12px;font-weight:600;color:var(--yellow)">${esc(acc.name)}</span>` +
          `<span style="font-size:11px;color:var(--dim);margin-left:8px">${acc.bot_active ? t('sess_active') : t('sess_inactive')}</span>` +
        `</div>` +
        `<div style="display:flex;gap:6px">` +
          (!acc.bot_active ? `<button class="btn-sm" style="color:var(--green);border-color:var(--green)" onclick="sessActivate(${acc.idx},this)">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>` : '') +
          `<button class="btn-sm" onclick="sessEditToggle(${acc.idx})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>` +
          `<button class="btn-sm" style="color:var(--red);border-color:var(--red)" onclick="sessionRemove(${acc.idx})">üóëÔ∏è</button>` +
        `</div>` +
      `</div>` +
      `<div style="font-size:11px;color:var(--dim)">` +
        `resume_hash: <b style="font-family:monospace;color:var(--text)">${esc((acc.resume_hash||'').slice(0,14))}...</b>` +
      `</div>` +
      `<div id="sess-edit-form-${acc.idx}" style="display:none;margin-top:10px">` +
        `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">` +
          `<div><div style="font-size:11px;color:var(--dim);margin-bottom:3px">–ò–º—è</div>` +
            `<input id="sess-edit-name-${acc.idx}" class="apply-input" style="font-size:11px" value="${esc(acc.name)}"></div>` +
          `<div><div style="font-size:11px;color:var(--dim);margin-bottom:3px">–ö–æ—Ä–æ—Ç–∫–æ–µ</div>` +
            `<input id="sess-edit-short-${acc.idx}" class="apply-input" style="font-size:11px" value="${esc(acc.short||'')}"></div>` +
          `<div><div style="font-size:11px;color:var(--dim);margin-bottom:3px">–¶–≤–µ—Ç</div>` +
            `<select id="sess-edit-color-${acc.idx}" class="apply-input" style="font-size:11px">` +
              ACC_COLORS.map(c => `<option value="${c}"${c===(acc.color||'yellow')?' selected':''}>${c}</option>`).join('') +
            `</select></div>` +
          `<div><div style="font-size:11px;color:var(--dim);margin-bottom:3px">resume_hash</div>` +
            `<input id="sess-edit-hash-${acc.idx}" class="apply-input" style="font-size:11px;font-family:monospace" value="${esc(acc.resume_hash||'')}"></div>` +
        `</div>` +
        `<div style="display:flex;gap:8px;align-items:center">` +
          `<button class="btn-sm" onclick="sessProfileSave(${acc.idx},this)">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>` +
          `<span id="sess-edit-st-${acc.idx}" style="font-size:11px;color:var(--dim)"></span>` +
        `</div>` +
      `</div>`;
    el.appendChild(div);
  });
}

async function sessActivate(idx, btn) {
  if (btn) btn.disabled = true;
  try {
    const res = await fetch(`/api/session/${idx}/activate`, {method: 'POST'});
    const data = await res.json();
    if (data.ok) {
      const listEl = document.getElementById('sess-list');
      if (listEl) listEl.dataset.count = '';
    } else {
      alert('–û—à–∏–±–∫–∞: ' + (data.error || ''));
      if (btn) btn.disabled = false;
    }
  } catch(e) {
    alert('–û—à–∏–±–∫–∞: ' + e);
    if (btn) btn.disabled = false;
  }
}

async function touchToggle(idx, el) {
  if (!el) return;
  const wasOn = el.classList.contains('on');
  // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å—Ä–∞–∑—É
  el.classList.toggle('on', !wasOn);
  el.classList.toggle('off', wasOn);
  const lbl = document.getElementById('acc-touch-label-' + idx);
  if (lbl) lbl.textContent = !wasOn ? 'üîÅ –≤–∫–ª' : '‚è∏ –≤—ã–∫–ª';
  try {
    const res = await fetch(`/api/account/${idx}/resume_touch_toggle`, {method: 'POST'});
    if (!res.ok) throw new Error(res.status);
    // —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ WebSocket
  } catch(e) {
    // –æ—Ç–∫–∞—Ç
    el.classList.toggle('on', wasOn);
    el.classList.toggle('off', !wasOn);
    if (lbl) lbl.textContent = wasOn ? 'üîÅ –≤–∫–ª' : '‚è∏ –≤—ã–∫–ª';
  }
}

async function resumeTouchNow(idx, btn) {
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –ø–æ–¥–Ω–∏–º–∞—é...'; btn.style.color = ''; }
  try {
    await fetch(`/api/account/${idx}/resume_touch`, {method: 'POST'});
    // –¥–µ—Ä–∂–∏–º disabled ‚Äî updateCard —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫—É –∫–æ–≥–¥–∞ –ø—Ä–∏–¥—ë—Ç —Ä–µ–∞–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä
    if (btn) btn.setAttribute('data-touching', '1');
    // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ 15—Å –µ—Å–ª–∏ WebSocket –Ω–µ –ø—Ä–∏—à—ë–ª
    setTimeout(() => {
      if (btn && btn.getAttribute('data-touching')) {
        btn.removeAttribute('data-touching');
        btn.disabled = false;
        btn.textContent = 'üì§ –ü–æ–¥–Ω—è—Ç—å';
        btn.style.color = '';
      }
    }, 15000);
  } catch(e) {
    if (btn) { btn.textContent = '‚ùå'; btn.style.color = 'var(--red)'; btn.disabled = false; btn.removeAttribute('data-touching'); }
  }
}

function sessEditToggle(idx) {
  const form = document.getElementById(`sess-edit-form-${idx}`);
  if (form) form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function sessProfileSave(idx, btn) {
  const st = document.getElementById(`sess-edit-st-${idx}`);
  const body = {
    name:        document.getElementById(`sess-edit-name-${idx}`)?.value.trim(),
    short:       document.getElementById(`sess-edit-short-${idx}`)?.value.trim(),
    color:       document.getElementById(`sess-edit-color-${idx}`)?.value,
    resume_hash: document.getElementById(`sess-edit-hash-${idx}`)?.value.trim(),
  };
  if (btn) btn.disabled = true;
  if (st) { st.textContent = '‚è≥...'; st.style.color = 'var(--dim)'; }
  try {
    const res = await fetch(`/api/session/${idx}/profile`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.ok) {
      if (st) { st.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; st.style.color = 'var(--green)'; }
      const listEl = document.getElementById('sess-list');
      if (listEl) listEl.dataset.count = '';
    } else {
      if (st) { st.textContent = '‚ùå ' + (data.error||'–û—à–∏–±–∫–∞'); st.style.color = 'var(--red)'; }
    }
  } catch(e) {
    if (st) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  } finally {
    if (btn) btn.disabled = false;
    setTimeout(() => { if (st) st.textContent = ''; }, 4000);
  }
}

// Build/refresh account cookies list from snapshot
function buildAccCookiesList(snap) {
  const el = document.getElementById('acc-cookies-list');
  if (!el) return;
  const accs = (snap?.accounts || []);
  if (!accs.length) { el.innerHTML = '<div class="c-dim" style="font-size:12px">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>'; return; }
  // Only rebuild if account count changed
  if (el.dataset.count === String(accs.length)) return;
  el.dataset.count = String(accs.length);
  el.innerHTML = '';
  accs.forEach(acc => {
    const colorStyle = `color:${colorVar(acc.color || 'text')}`;
    const div = document.createElement('div');
    div.style.cssText = 'margin-bottom:14px;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px';
    div.innerHTML =
      `<div style="font-size:12px;font-weight:600;margin-bottom:6px;${colorStyle}">${esc(acc.name)}</div>` +
      `<textarea id="ck-ta-${acc.idx}" class="apply-input" rows="2" style="font-size:11px;margin-bottom:6px" ` +
        `placeholder="curl 'https://hh.ru/...' -H 'cookie: hhtoken=...' ...&#10;‚Äî –∏–ª–∏: hhtoken=xxx; _xsrf=yyy; hhul=zzz; crypted_id=aaa"></textarea>` +
      `<div style="display:flex;gap:8px;align-items:center">` +
        `<button class="btn-sm" onclick="updateAccCookies(${acc.idx})">${t('btn_update_cookies')}</button>` +
        `<span id="ck-st-${acc.idx}" style="font-size:11px;color:var(--dim)"></span>` +
      `</div>`;
    el.appendChild(div);
  });
}

async function updateAccCookies(idx) {
  const ta = document.getElementById('ck-ta-' + idx);
  const st = document.getElementById('ck-st-' + idx);
  const val = ta?.value.trim();
  if (!val) { st.textContent = '‚ùå –ü—É—Å—Ç–æ'; st.style.color = 'var(--red)'; return; }
  st.textContent = '‚è≥ –û–±–Ω–æ–≤–ª—è—é...'; st.style.color = 'var(--dim)';
  try {
    const res = await fetch(`/api/account/${idx}/update_cookies`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({cookies: val})
    });
    const data = await res.json();
    if (data.ok) {
      ta.value = '';
      st.textContent = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ (${(data.keys||[]).length} –∫–ª—é—á–µ–π)`;
      st.style.color = 'var(--green)';
    } else {
      st.textContent = '‚ùå ' + (data.error || '–û—à–∏–±–∫–∞');
      st.style.color = 'var(--red)';
    }
  } catch(e) {
    st.textContent = '‚ùå ' + e;
    st.style.color = 'var(--red)';
  }
}

function applySettings() {
  SETTINGS_DEF.forEach(s => {
    const el = document.getElementById('sr-' + s.key);
    if (el) sendCmd({ type: 'set_config', key: s.key, value: Number(el.value) });
  });
  const st = document.getElementById('settings-status');
  st.textContent = t('settings_applied');
  setTimeout(() => { st.textContent = ''; }, 3000);
}

// ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connect() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${proto}://${location.host}/ws`);
  State.ws = ws;

  ws.onopen = () => {
    document.getElementById('conn-dot').classList.add('connected');
    State.reconnectDelay = 1000;
  };

  ws.onmessage = (ev) => {
    try {
      const snap = JSON.parse(ev.data);
      if (snap.type === 'state_update') {
        State.lastSnapshot = snap;
        try {
          renderAll(snap);
          const dbg = document.getElementById('dbg-err');
          if (dbg) dbg.style.display = 'none';
        } catch (renderErr) {
          const dbg = document.getElementById('dbg-err');
          if (dbg) { dbg.style.display = ''; dbg.textContent = 'JS ERROR: ' + renderErr; }
          console.error('renderAll error:', renderErr);
        }
      }
    } catch (e) { console.error('WS parse error:', e); }
  };

  ws.onclose = () => {
    document.getElementById('conn-dot').classList.remove('connected');
    State.reconnectTimer = setTimeout(() => {
      State.reconnectDelay = Math.min(State.reconnectDelay * 2, 30000);
      connect();
    }, State.reconnectDelay);
  };

  ws.onerror = () => { ws.close(); };
}

function sendCmd(obj) {
  if (State.ws && State.ws.readyState === 1) {
    State.ws.send(JSON.stringify(obj));
  }
}

// ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll(snap) {
  renderHeader(snap);
  updateHeaderResumeStats(snap);
  syncLetterSelects(snap);
  syncAccUrlChecks(snap);
  syncLlmSettings(snap);
  updatePageTitle(snap);
  checkNotifications(snap);
  if (State.currentTab === 'main') renderMain(snap);
  else if (State.currentTab === 'log') renderLog(snap);
  else if (State.currentTab === 'hh') renderHH(snap);
  else if (State.currentTab === 'llm') renderLlmLog(snap);
  else if (State.currentTab === 'views') loadViews();
  else if (State.currentTab === 'apply') {
    applyBuildAccountSelect(snap);
  }
  // applied/tests/views rendered on tab switch
}

function updatePageTitle(snap) {
  const hasLimit = (snap.accounts || []).some(a => a.status === 'limit');
  const sent = snap.global_stats?.total_sent || 0;
  if (hasLimit) {
    document.title = t('title_limit');
  } else if (snap.paused) {
    document.title = t('title_paused');
  } else if (sent > 0) {
    document.title = `‚úÖ ${sent} –æ—Ç–∫–ª. | HH Bot`;
  } else {
    document.title = 'HH Bot Dashboard';
  }
}

function checkNotifications(snap) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  (snap.accounts || []).forEach(acc => {
    const prev = State.prevInterviews[acc.idx] ?? acc.hh_interviews;
    if (acc.hh_interviews > prev) {
      sendBotNotification(
        `${t('notif_new_inv')}${acc.short}`,
        `${t('notif_inv_count_pre')} ${acc.hh_interviews} ${t('notif_inv_count_mid')}${acc.hh_interviews - prev})`
      );
    }
    State.prevInterviews[acc.idx] = acc.hh_interviews;
    const wasLimit = State.prevLimitState[acc.idx];
    if (acc.status === 'limit' && !wasLimit) {
      sendBotNotification(`${t('notif_limit')}${acc.short}`, t('notif_limit_body'));
    }
    State.prevLimitState[acc.idx] = acc.status === 'limit';
    // Cookies expired detection
    const wasExpired = State.prevCookiesExpired[acc.idx];
    if (acc.cookies_expired && !wasExpired) {
      sendBotNotification(`${t('notif_cookies')}${acc.short}`, t('notif_cookies_body'));
    }
    State.prevCookiesExpired[acc.idx] = acc.cookies_expired;
  });
}

function sendBotNotification(title, body) {
  try { new Notification(title, { body, icon: '/favicon.ico' }); } catch(e) {}
}

function fmtUptime(s) {
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  if (h > 0) return `${h}—á ${String(m).padStart(2,'0')}–º`;
  return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function renderHeader(snap) {
  document.getElementById('uptime').textContent = '‚è± ' + fmtUptime(snap.uptime_seconds);
  document.getElementById('global-found').textContent = snap.global_stats.total_found;
  document.getElementById('global-sent').textContent = snap.global_stats.total_sent;
  document.getElementById('storage-total').textContent = snap.global_stats.storage_total;
  document.getElementById('storage-tests').textContent = snap.global_stats.storage_tests;

  const btn = document.getElementById('pause-btn');
  if (snap.paused) {
    btn.textContent = t('btn_resume');
    btn.classList.add('paused');
  } else {
    const pausedAccs = (snap.accounts || []).filter(a => a.paused).length;
    btn.textContent = pausedAccs ? `${t('btn_pause')} (${pausedAccs})` : t('btn_pause');
    btn.classList.remove('paused');
  }
}

// ‚îÄ‚îÄ Main tab ‚îÄ‚îÄ
function renderMain(snap) {
  renderAccounts(snap);
  renderGlobalStats(snap);
  renderRecentResponses(snap);
}

const STATUS_MAP = {
  idle:       ['‚è∏', 'status_idle',       'status-idle'],
  collecting: ['üì•', 'status_collecting', 'status-collecting'],
  applying:   ['üì§', 'status_applying',   'status-applying'],
  limit:      ['üö´', 'status_limit',      'status-limit'],
  waiting:    ['‚è≥', 'status_waiting',    'status-waiting'],
  checking:   ['üîç', 'status_checking',   'status-checking'],
  '‚Äî':        ['‚≠ï', 'status_inactive',   'status-idle'],
};

function renderAccounts(snap) {
  const grid = document.getElementById('accounts-grid');
  // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤
  let emptyEl = document.getElementById('accounts-empty');
  if (!snap.accounts || snap.accounts.length === 0) {
    if (!emptyEl) {
      emptyEl = document.createElement('div');
      emptyEl.id = 'accounts-empty';
      emptyEl.style.cssText = 'grid-column:1/-1;text-align:center;padding:48px 16px;color:var(--dim);font-size:14px';
      emptyEl.innerHTML = `<div style="font-size:32px;margin-bottom:12px">üì≠</div>${t('no_accounts')}`;
      grid.appendChild(emptyEl);
    }
    return;
  }
  if (emptyEl) emptyEl.remove();
  // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç
  const alive = new Set(snap.accounts.map(a => 'card-' + a.idx));
  grid.querySelectorAll('.acc-card').forEach(el => {
    if (el.id && !alive.has(el.id)) el.remove();
  });
  snap.accounts.forEach(acc => {
    let card = document.getElementById('card-' + acc.idx);
    if (!card) {
      card = document.createElement('div');
      card.id = 'card-' + acc.idx;
      card.className = 'acc-card color-' + (acc.color || 'yellow');
      card.innerHTML = buildCardHTML(acc);
      grid.appendChild(card);
    } else {
      card.className = 'acc-card color-' + (acc.color || 'yellow');
      updateCard(card, acc);
    }
  });
}

function buildCardHTML(acc) {
  return `
    <div class="acc-header">
      <div class="acc-name" id="acc-name-${acc.idx}">${acc.name}</div>
      <button class="compact-btn" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É" onclick="toggleCompact(${acc.idx})">‚¨ú</button>
      <button class="compact-btn" title="–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" style="color:var(--red);margin-left:2px" onclick="accDeleteCard(${acc.idx}, this)">üóë</button>
      <div class="acc-status-badge status-idle" id="acc-badge-${acc.idx}">‚è∏ ${t('status_idle')}</div>
    </div>
    <div class="acc-progress"><div class="acc-progress-fill" id="acc-prog-${acc.idx}"></div></div>
    <div class="acc-stats">
      <div class="stat-box" title="–°–µ—Å—Å–∏—è / –í—Å–µ–≥–æ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è">
        <div class="stat-val c-green" id="acc-sent-${acc.idx}">0</div>
        <div class="stat-lbl">${t('stat_replies')} <span style="color:var(--dim);font-size:10px">/ <span id="acc-total-${acc.idx}">0</span></span></div>
      </div>
      <div class="stat-box">
        <div class="stat-val c-magenta" id="acc-tests-${acc.idx}">0</div>
        <div class="stat-lbl">${t('stat_tests')}</div>
      </div>
      <div class="stat-box" id="acc-qsent-box-${acc.idx}" style="display:none">
        <div class="stat-val c-cyan" id="acc-qsent-${acc.idx}">0</div>
        <div class="stat-lbl">${t('stat_surveys')}</div>
      </div>
      <div class="stat-box">
        <div class="stat-val c-blue" id="acc-already-${acc.idx}">0</div>
        <div class="stat-lbl">${t('stat_already')}</div>
      </div>
      <div class="stat-box">
        <div class="stat-val c-red" id="acc-err-${acc.idx}">0</div>
        <div class="stat-lbl">${t('stat_errors')}</div>
      </div>
      <div class="stat-box" id="acc-sal-box-${acc.idx}" style="display:none">
        <div class="stat-val c-yellow" id="acc-sal-${acc.idx}">0</div>
        <div class="stat-lbl">${t('stat_salary')}</div>
      </div>
      <div class="stat-box" id="acc-intrv-box-${acc.idx}" style="display:none">
        <div class="stat-val" style="color:#f0c060" id="acc-intrv-${acc.idx}">0</div>
        <div id="acc-intrv-total-${acc.idx}" style="font-size:10px;color:var(--dim);line-height:1.2"></div>
        <div class="stat-lbl">${t('stat_interviews')}</div>
      </div>
    </div>
    <div class="acc-vacancy" id="acc-vacancy-${acc.idx}">
      <div class="acc-vacancy-title c-dim">${t('card_waiting')}</div>
    </div>
    <div class="acc-meta" id="acc-meta-${acc.idx}"></div>
    <div class="acc-hh-stats" id="acc-hh-${acc.idx}">${t('card_hh_loading')}</div>
    <div class="acc-resume-stats" id="acc-rs-${acc.idx}" style="display:none">
      <span class="acc-resume-stat">üëÅÔ∏è <span id="acc-rs-views-${acc.idx}">0</span> ${t('rs_views')}</span>
      <span class="acc-resume-stat c-cyan">+<span id="acc-rs-vnew-${acc.idx}">0</span> –Ω–æ–≤—ã—Ö</span>
      <span class="acc-resume-stat">üîé <span id="acc-rs-shows-${acc.idx}">0</span> ${t('rs_shows')}</span>
      <span class="acc-resume-stat c-green">üì¨ <span id="acc-rs-inv-${acc.idx}">0</span> ${t('rs_inv')}</span>
      <span class="acc-touch-timer c-yellow" id="acc-touch-timer-${acc.idx}" style="display:none"></span>
    </div>
    <div class="acc-history" id="acc-hist-${acc.idx}"></div>
    <div class="acc-event-log" id="acc-elog-${acc.idx}"></div>
    <div id="acc-errbadge-${acc.idx}" style="display:none;font-size:11px;padding:2px 0;margin-bottom:2px"></div>
    <div id="acc-cookiesbadge-${acc.idx}" class="cookies-expired-badge" style="display:none">${t('cookies_expired_badge')}</div>
    <label class="acc-skip-tests${acc.apply_tests ? ' active' : ''}" id="acc-apply-label-${acc.idx}">
      <input type="checkbox" id="acc-apply-cb-${acc.idx}" ${acc.apply_tests ? 'checked' : ''}
        onchange="applyTestsToggle(${acc.idx}, this)">
      ${t('card_apply_tests')}
    </label>
    <div class="acc-actions">
      <button class="btn-sm" id="acc-pause-btn-${acc.idx}"
        onclick="sendCmd({type:'account_pause', idx:${acc.idx}})">${t('btn_acc_pause')}</button>
      <span class="touch-toggle ${acc.resume_touch_enabled !== false ? 'on' : 'off'}" id="acc-touch-toggle-${acc.idx}" onclick="touchToggle(${acc.idx},this)" title="–ê–≤—Ç–æ-–ø–æ–¥—ä—ë–º —Ä–µ–∑—é–º–µ –≤–∫–ª/–≤—ã–∫–ª">
        <span class="tgl-dot"></span>
        <span>–ê–≤—Ç–æ-–ø–æ–¥—ä—ë–º —Ä–µ–∑—é–º–µ</span>
        <span id="acc-touch-label-${acc.idx}">${acc.resume_touch_enabled !== false ? 'üîÅ –≤–∫–ª' : '‚è∏ –≤—ã–∫–ª'}</span>
      </span>
      <button class="btn-sm" id="acc-touch-btn-${acc.idx}"
        onclick="resumeTouchNow(${acc.idx},this)" title="–ü–æ–¥–Ω—è—Ç—å —Ä–µ–∑—é–º–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å">üì§ –°–µ–π—á–∞—Å</button>
      <button class="btn-sm"
        onclick="declineDiscards(${acc.idx},this)">${t('btn_clear_discards')}</button>
      <button class="btn-sm llm-toggle-btn llm-on" id="acc-llm-btn-${acc.idx}"
        onclick="llmToggleAccount(${acc.idx},this)" title="–í–∫–ª/–≤—ã–∫–ª LLM –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞">ü§ñ –í–ö–õ</button>
      ${acc.temp && !acc.bot_active ? `<button class="btn-sm" style="color:var(--green);border-color:var(--green)" onclick="sessionActivate(${acc.idx})">${t('btn_launch')}</button>` : ''}
      ${acc.temp ? `<button class="btn-sm" style="color:var(--red);border-color:var(--red)" onclick="sessionRemove(${acc.idx})">${t('btn_delete')}</button>` : ''}
    </div>
    <details class="acc-letter-wrap" id="acc-letter-wrap-${acc.idx}">
      <summary>${t('letter_section')}</summary>
      <div class="acc-letter-body">
        <select id="acc-letter-tpl-${acc.idx}" class="apply-input" style="font-size:11px;padding:3px 6px;margin-bottom:6px"
          onchange="letterPickTpl(${acc.idx})">
          <option value="">‚Äî –ø—É—Å—Ç–æ ‚Äî</option>
          <option value="__custom__">‚úèÔ∏è –°–≤–æ—ë</option>
        </select>
        <textarea id="acc-letter-ta-${acc.idx}" class="apply-input" rows="3"
          style="font-size:11px" placeholder="–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ...">${esc(acc.letter||'')}</textarea>
        <div style="display:flex;gap:6px;margin-top:6px;align-items:center">
          <button class="btn-sm" onclick="letterSave(${acc.idx},this)">${t('btn_save')}</button>
          <span id="acc-letter-st-${acc.idx}" style="font-size:11px;color:var(--dim)"></span>
        </div>
      </div>
    </details>
    <details class="acc-letter-wrap" id="acc-url-wrap-${acc.idx}">
      <summary>${t('url_section')}</summary>
      <div class="acc-letter-body">
        <div id="acc-url-checks-${acc.idx}" style="margin-bottom:8px"></div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn-sm" onclick="urlAccSave(${acc.idx},this)">${t('btn_apply_url')}</button>
          <span id="url-acc-st-${acc.idx}" style="font-size:11px;color:var(--dim)"></span>
        </div>
      </div>
    </details>
  `;
}

function updateCard(card, acc) {
  // Status badge ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å
  const badge = document.getElementById('acc-badge-' + acc.idx);
  if (badge) {
    const globalPaused = State.lastSnapshot?.paused;
    const accPaused = acc.paused;
    if (globalPaused) {
      badge.className = 'acc-status-badge status-idle';
      badge.textContent = t('status_all_paused');
      badge.title = '';
    } else if (accPaused) {
      badge.className = 'acc-status-badge status-idle';
      badge.textContent = t('status_acc_paused');
      badge.title = '';
    } else {
      const [icon, labelKey, cls] = STATUS_MAP[acc.status] || ['‚ùì', null, 'status-idle'];
      badge.className = 'acc-status-badge ' + cls;
      badge.textContent = icon + ' ' + (labelKey ? t(labelKey) : acc.status.toUpperCase());
      if (acc.status_detail) badge.title = acc.status_detail;
    }
  }

  // Resume stats block
  const rsBlock = document.getElementById('acc-rs-' + acc.idx);
  if (rsBlock && acc.resume_views_7d > 0) {
    rsBlock.style.display = '';
    setText('acc-rs-views-' + acc.idx, acc.resume_views_7d);
    setText('acc-rs-vnew-' + acc.idx, acc.resume_views_new);
    setText('acc-rs-shows-' + acc.idx, acc.resume_shows_7d);
    setText('acc-rs-inv-' + acc.idx, acc.resume_invitations_7d);
    // Touch timer
    const timerEl = document.getElementById('acc-touch-timer-' + acc.idx);
    if (timerEl) {
      const secs = acc.resume_next_touch_seconds || 0;
      if (secs > 0) {
        const h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60);
        timerEl.style.display = '';
        timerEl.textContent = `‚è± ${t('rs_raise_in')} ${h > 0 ? h + '—á ' : ''}${m}–º`;
      } else {
        timerEl.style.display = '';
        timerEl.textContent = `‚úÖ ${acc.resume_free_touches || 0} ${t('rs_raises_avail')}`;
        timerEl.className = 'acc-touch-timer c-green';
      }
    }
  }

  // Auto-touch toggle + button
  const touchToggleEl = document.getElementById('acc-touch-toggle-' + acc.idx);
  const touchLabelEl  = document.getElementById('acc-touch-label-' + acc.idx);
  const touchBtn      = document.getElementById('acc-touch-btn-' + acc.idx);
  const autoOn = acc.resume_touch_enabled !== false;
  const m = acc.next_resume_touch ? acc.next_resume_touch.match(/\(([^)]+)\)/) : null;
  const countdown = m && m[1]; // "2—á30–º"
  if (touchToggleEl) {
    touchToggleEl.className = 'touch-toggle ' + (autoOn ? 'on' : 'off');
    if (touchLabelEl) {
      if (autoOn) {
        touchLabelEl.textContent = countdown ? `üîÅ –≤–∫–ª ¬∑ —á–µ—Ä–µ–∑ ${countdown}` : 'üîÅ –≤–∫–ª';
      } else {
        touchLabelEl.textContent = countdown ? `‚è∏ –≤—ã–∫–ª ¬∑ –±—ã–ª–æ —á–µ—Ä–µ–∑ ${countdown}` : '‚è∏ –≤—ã–∫–ª';
      }
    }
  }
  if (touchBtn) {
    const touching = touchBtn.getAttribute('data-touching');
    if (touching) {
      if (countdown) {
        touchBtn.removeAttribute('data-touching');
        touchBtn.disabled = false;
        touchBtn.textContent = 'üì§ –°–µ–π—á–∞—Å';
        touchBtn.style.color = '';
      }
    } else if (!touchBtn.disabled) {
      touchBtn.textContent = 'üì§ –°–µ–π—á–∞—Å';
      touchBtn.style.color = '';
    }
  }

  // Stats
  setText('acc-sent-' + acc.idx, acc.sent);
  setText('acc-total-' + acc.idx, acc.total_applied ?? '');
  setText('acc-tests-' + acc.idx, acc.tests);
  setText('acc-already-' + acc.idx, acc.already_applied);
  setText('acc-err-' + acc.idx, acc.errors);

  // Questionnaire sent (show when > 0)
  const qBox = document.getElementById('acc-qsent-box-' + acc.idx);
  if (qBox) {
    const qSent = acc.questionnaire_sent || 0;
    qBox.style.display = qSent > 0 ? '' : 'none';
    setText('acc-qsent-' + acc.idx, qSent);
  }

  // Salary filter stat (only show when filter is active)
  const salBox = document.getElementById('acc-sal-box-' + acc.idx);
  if (salBox) {
    const minSal = acc.min_salary || (State.lastSnapshot && State.lastSnapshot.config && State.lastSnapshot.config.min_salary) || 0;
    salBox.style.display = minSal > 0 ? '' : 'none';
    setText('acc-sal-' + acc.idx, acc.salary_skipped || 0);
  }

  // HH interviews stat box ‚Äî —Å–≤–µ–∂–∏–µ (60–¥) –∫—Ä—É–ø–Ω–æ, –≤—Å–µ–≥–æ –º–µ–ª–∫–æ
  const intrvBox = document.getElementById('acc-intrv-box-' + acc.idx);
  if (intrvBox) {
    const recent = acc.hh_interviews_recent ?? acc.hh_interviews ?? 0;
    const total  = acc.hh_interviews || 0;
    intrvBox.style.display = total > 0 ? '' : 'none';
    setText('acc-intrv-' + acc.idx, recent);
    const totalEl = document.getElementById('acc-intrv-total-' + acc.idx);
    if (totalEl) totalEl.textContent = total > recent ? `–≤—Å–µ–≥–æ ${total}` : '';
  }


  // Progress bar
  const prog = document.getElementById('acc-prog-' + acc.idx);
  if (prog) {
    let pct = 0;
    if (acc.status === 'applying' && acc.total_vacancies > 0) {
      pct = Math.round(acc.current_vacancy_idx / acc.total_vacancies * 100);
      prog.className = 'acc-progress-fill applying';
    } else if (acc.status === 'collecting') {
      pct = 30; // indeterminate pulse
      prog.className = 'acc-progress-fill';
    } else if (acc.status === 'limit') {
      pct = 100;
      prog.className = 'acc-progress-fill limit';
    } else {
      pct = 0;
      prog.className = 'acc-progress-fill';
    }
    prog.style.width = pct + '%';
  }

  // Compact card mode
  if (State.compactCards.has(acc.idx)) {
    card.classList.add('compact');
  } else {
    card.classList.remove('compact');
  }

  // Consecutive errors badge
  const errBadge = document.getElementById('acc-errbadge-' + acc.idx);
  if (errBadge) {
    const n = acc.consecutive_errors || 0;
    const threshold = State.lastSnapshot?.config?.auto_pause_errors || 5;
    if (n > 0) {
      errBadge.style.display = '';
      errBadge.textContent = `‚ö° ${n} ${t('errs_in_row')}`;
      errBadge.style.color = n >= threshold ? 'var(--red)' : 'var(--yellow)';
    } else {
      errBadge.style.display = 'none';
    }
  }

  // Cookies expired badge
  const cookiesBadge = document.getElementById('acc-cookiesbadge-' + acc.idx);
  if (cookiesBadge) {
    cookiesBadge.style.display = acc.cookies_expired ? '' : 'none';
  }

  // Current vacancy
  const vac = document.getElementById('acc-vacancy-' + acc.idx);
  if (vac) {
    if (acc.current_vacancy_title) {
      vac.innerHTML = `
        <div class="acc-vacancy-title">${esc(acc.current_vacancy_title)}</div>
        <div class="acc-vacancy-company c-dim">@ ${esc(acc.current_vacancy_company)}</div>
      `;
    } else if (acc.status === 'applying') {
      vac.innerHTML = `<div class="acc-vacancy-title c-dim">${t('card_sending')}</div>`;
    } else {
      vac.innerHTML = `<div class="acc-vacancy-title c-dim">${esc(acc.status_detail) || t('card_waiting')}</div>`;
    }
  }

  // Meta
  const meta = document.getElementById('acc-meta-' + acc.idx);
  if (meta) {
    const parts = [];
    if (acc.found_vacancies > 0) parts.push(`üîç ${acc.found_vacancies} –Ω–∞–π–¥–µ–Ω–æ`);
    if (acc.next_resume_touch) parts.push(`üì§ —Ä–µ–∑—é–º–µ: ${acc.next_resume_touch}`);
    meta.textContent = parts.join('  ');
  }

  // HH stats
  const hh = document.getElementById('acc-hh-' + acc.idx);
  if (hh) {
    if (acc.hh_stats_loading && !acc.hh_stats_updated) {
      hh.textContent = t('card_hh_loading');
    } else if (acc.hh_stats_updated) {
      const recent = acc.hh_interviews_recent ?? acc.hh_interviews ?? 0;
      const total  = acc.hh_interviews || 0;
      const intrvStr = total > recent
        ? `<span style="color:#f0c060">üéØ ${recent}</span><span class="c-dim"> (${total} –≤—Å–µ–≥–æ)</span>`
        : `<span style="color:#f0c060">üéØ ${recent}</span>`;
      hh.innerHTML =
        intrvStr + ` ${t('hh_interviews')} &nbsp;` +
        `<span class="c-yellow">üëÅ ${acc.hh_viewed}</span> ${t('hh_viewed')} &nbsp;` +
        `<span class="c-red">‚ùå ${acc.hh_discards}</span> ${t('hh_discards')} &nbsp;` +
        `<span class="c-dim">(${acc.hh_stats_updated})</span>`;
    } else {
      hh.textContent = acc.hh_stats_loading ? '‚è≥ HH...' : '‚Äî';
    }
  }

  // History
  const hist = document.getElementById('acc-hist-' + acc.idx);
  if (hist && acc.action_history.length > 0) {
    hist.textContent = acc.action_history.slice(-5).join('  |  ');
  }

  // Per-account event log
  const elog = document.getElementById('acc-elog-' + acc.idx);
  if (elog && acc.acc_event_log) {
    if (acc.acc_event_log.length === 0) {
      elog.innerHTML = '';
    } else {
      elog.innerHTML = acc.acc_event_log.map(e => {
        const co = e.company ? ` <span style="color:var(--dim)">@ ${esc(e.company)}</span>` : '';
        const extra = e.extra ? `<div class="acc-elog-extra">${esc(e.extra)}</div>` : '';
        return `<div class="acc-elog-entry">
          <span class="acc-elog-time">${e.time}</span>
          <span class="acc-elog-icon">${e.icon}</span>
          <div class="acc-elog-body">
            <div class="acc-elog-title">${esc(e.title)}${co}</div>
            ${extra}
          </div>
        </div>`;
      }).join('');
    }
  }

  // Apply tests checkbox
  const skipCb = document.getElementById('acc-apply-cb-' + acc.idx);
  const skipLabel = document.getElementById('acc-apply-label-' + acc.idx);
  if (skipCb && skipCb.checked !== !!acc.apply_tests) skipCb.checked = !!acc.apply_tests;
  if (skipLabel) {
    if (acc.apply_tests) skipLabel.classList.add('active');
    else skipLabel.classList.remove('active');
  }

  // Pause button ‚Äî —É—á–∏—Ç—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–∞—É–∑—É
  const pauseBtn = document.getElementById('acc-pause-btn-' + acc.idx);
  if (pauseBtn) {
    const globalPaused = State.lastSnapshot?.paused;
    if (globalPaused) {
      pauseBtn.textContent = t('btn_acc_global_pause');
      pauseBtn.classList.add('paused');
      pauseBtn.disabled = true;
      pauseBtn.title = '–°–Ω–∏–º–∏—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–∞—É–∑—É –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É';
    } else {
      pauseBtn.disabled = false;
      pauseBtn.title = '';
      if (acc.paused) {
        pauseBtn.textContent = t('btn_acc_resume');
        pauseBtn.classList.add('paused');
      } else {
        pauseBtn.textContent = t('btn_acc_pause');
        pauseBtn.classList.remove('paused');
      }
    }
  }

  // LLM toggle button
  const llmBtn = document.getElementById('acc-llm-btn-' + acc.idx);
  if (llmBtn) {
    const enabled = acc.llm_enabled !== false; // default true
    llmBtn.textContent = enabled ? 'ü§ñ –í–ö–õ' : 'ü§ñ –í–´–ö–õ';
    llmBtn.classList.toggle('llm-on', enabled);
    llmBtn.classList.toggle('llm-off', !enabled);
  }
}

function renderGlobalStats(snap) {
  const g = snap.global_stats;
  const el = document.getElementById('global-stats-body');
  if (!el) return;
  const rows = [
    [t('gs_found'),    `<span class="c-cyan">${g.total_found}</span>`],
    [t('gs_applied'),  `<span class="c-green">${g.total_sent}</span>`],
    [t('gs_tests'),    `<span class="c-magenta">${g.total_tests}</span>`],
    [t('gs_errors'),   `<span class="c-red">${g.total_errors}</span>`],
    [t('gs_in_db'),    `<span class="c-blue">${g.storage_total}</span>`],
    [t('gs_in_db_tests'), `<span class="c-magenta">${g.storage_tests}</span>`],
  ];
  el.innerHTML = rows.map(([l, v]) =>
    `<div class="global-row"><span class="lbl">${l}</span>${v}</div>`
  ).join('');
}

function renderRecentResponses(snap) {
  const list = document.getElementById('recent-list');
  if (!list) return;
  if (!snap.recent_responses.length) {
    list.innerHTML = `<div class="c-dim" style="padding:8px;font-size:11px">${t('recent_empty')}</div>`;
    return;
  }
  list.innerHTML = snap.recent_responses.slice(0, 15).map(r => {
    const title = r.title ? r.title.substring(0, 35) + (r.title.length > 35 ? '‚Ä¶' : '') : `ID:${r.id}`;
    return `
      <div class="resp-item">
        <span class="resp-time">${r.time}</span>
        <span>${r.icon}</span>
        <div>
          <div class="resp-title">${esc(title)}</div>
          ${r.company ? `<div class="resp-company">@ ${esc(r.company)}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

// ‚îÄ‚îÄ Log tab ‚îÄ‚îÄ
function logSetLevel(btn, level) {
  State.logLevel = level;
  document.querySelectorAll('.log-level-btn').forEach(b => {
    const isActive = b.dataset.level === level;
    if (isActive) b.classList.add('active');
    else b.classList.remove('active');
  });
  if (State.lastSnapshot) renderLog(State.lastSnapshot);
}

function logSyncAccFilter(snap) {
  const sel = document.getElementById('log-acc-filter');
  if (!sel) return;
  const current = sel.value;
  const names = [...new Set((snap.accounts||[]).map(a => a.short).filter(Boolean))];
  sel.innerHTML = `<option value="">${t('log_all_accs')}</option>` +
    names.map(n => `<option value="${esc(n)}"${current===n?' selected':''}>${esc(n)}</option>`).join('');
}

function renderLog(snap) {
  if (!snap) return;
  logSyncAccFilter(snap);
  const list = document.getElementById('log-list');
  if (!list || !snap.log) return;

  const search = (document.getElementById('log-search')?.value || '').toLowerCase();
  const accF   = document.getElementById('log-acc-filter')?.value || '';
  const level  = State.logLevel;

  let entries = snap.log;
  if (level)  entries = entries.filter(e => e.level === level);
  if (accF)   entries = entries.filter(e => e.acc === accF);
  if (search) entries = entries.filter(e =>
    (e.message||'').toLowerCase().includes(search) || (e.acc||'').toLowerCase().includes(search)
  );
  entries = entries.slice(0, State.MAX_LOG_NODES);

  const cnt = document.getElementById('log-count');
  if (cnt) cnt.textContent = `${entries.length} –∑–∞–ø–∏—Å–µ–π`;

  const frag = document.createDocumentFragment();
  entries.forEach(entry => {
    const el = document.createElement('div');
    el.className = 'log-item';
    el.innerHTML = `
      <span class="log-time">${entry.time}</span>
      <span class="log-acc" style="color:${colorVar(entry.color)}">${esc(entry.acc)}</span>
      <span class="log-msg log-${entry.level}">${esc(entry.message)}</span>
    `;
    frag.appendChild(el);
  });
  list.innerHTML = '';
  list.appendChild(frag);
}

// ‚îÄ‚îÄ HH Status tab ‚îÄ‚îÄ
function renderHH(snap) {
  const content = document.getElementById('hh-content');
  if (!content || !snap.accounts) return;

  content.innerHTML = snap.accounts.filter(acc => !acc.temp || acc.bot_active).map(acc => {
    let body = '';
    if (acc.hh_stats_loading && !acc.hh_stats_updated) {
      body = `<div class="c-dim">${t('hh_loading')}</div>`;
    } else if (!acc.hh_stats_updated) {
      body = `<div class="c-dim">${t('hh_no_data')}</div>`;
    } else {
      // Counters
      body += `<div class="hh-counters">
        <div class="hh-counter"><div class="hh-counter-val c-green">${acc.hh_interviews}</div><div class="hh-counter-lbl">${t('hh_interviews')}</div></div>
        <div class="hh-counter"><div class="hh-counter-val c-yellow">${acc.hh_viewed}</div><div class="hh-counter-lbl">${t('hh_viewed')}</div></div>
        <div class="hh-counter"><div class="hh-counter-val c-red">${acc.hh_discards}</div><div class="hh-counter-lbl">${t('hh_discards')}</div></div>
        <div class="hh-counter"><div class="hh-counter-val c-dim">${acc.hh_not_viewed}</div><div class="hh-counter-lbl">${t('hh_not_viewed')}</div></div>
      </div>`;
      body += `<div class="c-dim" style="font-size:11px;margin-bottom:10px">${t('hh_updated')} ${acc.hh_stats_updated}</div>`;

      // Interview list
      if (acc.hh_interviews_list && acc.hh_interviews_list.length) {
        body += `<div style="font-weight:700;margin-bottom:6px;color:var(--green)">${t('hh_inv_list')}</div>`;
        body += acc.hh_interviews_list.map(item => {
          const url = item.neg_id ? `https://hh.ru/applicant/negotiations/${item.neg_id}` : '';
          const textEl = url
            ? `<a class="hh-interview-text" href="${url}" target="_blank" rel="noopener">${esc(item.text || '')}</a>`
            : `<span class="hh-interview-text">${esc(item.text || '')}</span>`;
          return `<div class="hh-interview-item">` +
            (item.date ? `<span class="hh-interview-date">${esc(item.date)}</span>` : '') +
            textEl +
            `</div>`;
        }).join('');
      }

      // Possible offers
      if (acc.hh_possible_offers && acc.hh_possible_offers.length) {
        body += `<div style="font-weight:700;margin:12px 0 6px;color:var(--yellow)">${t('hh_offers')}</div>`;
        body += acc.hh_possible_offers.map(o =>
          `<div class="hh-offer-item">
            <div class="hh-offer-name">${esc(o.name)}</div>
            <div class="hh-offer-vacs">${o.vacancyNames.slice(0,3).map(n=>esc(n)).join(', ')}</div>
          </div>`
        ).join('');
      }
    }

    const colorStyle = `color:var(--${acc.color === 'magenta' ? 'magenta' : acc.color})`;
    return `
      <div class="hh-account-block">
        <div class="hh-account-title" style="${colorStyle}">${esc(acc.name)}</div>
        ${body}
      </div>
    `;
  }).join('');
}

// ‚îÄ‚îÄ Applied / Tests tabs ‚îÄ‚îÄ
// Applied tab state
const AppliedState = { all: [], shown: 0, pageSize: 80 };

async function loadApplied(force) {
  if (!force && AppliedState.all.length) { appliedRender(); return; }
  try {
    const res = await fetch('/api/applied?limit=2000');
    const items = await res.json();
    AppliedState.all = items;
    // Populate account filter
    const sel = document.getElementById('applied-acc-filter');
    const prev = sel.value;
    const accs = [...new Set(items.map(i => i.account).filter(Boolean))].sort();
    sel.innerHTML = `<option value="">${t('applied_all_accs')}</option>` +
      accs.map(a => `<option value="${esc(a)}"${a===prev?' selected':''}>${esc(a)}</option>`).join('');
    appliedRender();
  } catch(e) { console.error('loadApplied', e); }
}

function appliedSort(field) {
  if (AppliedSort.field === field) AppliedSort.dir *= -1;
  else { AppliedSort.field = field; AppliedSort.dir = -1; }
  // update header arrows
  document.querySelectorAll('#panel-applied .sort-th').forEach(th => {
    const f = th.getAttribute('onclick')?.match(/appliedSort\('(\w+)'\)/)?.[1];
    th.classList.toggle('sorted', f === field);
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.textContent = (f === field) ? (AppliedSort.dir === -1 ? '‚Üì' : '‚Üë') : '‚Üï';
  });
  appliedRender();
}

function appliedRender() {
  const search = (document.getElementById('applied-search')?.value || '').toLowerCase();
  const accF   = document.getElementById('applied-acc-filter')?.value || '';
  const hideEmpty = document.getElementById('applied-hide-empty')?.checked;

  let items = AppliedState.all;
  if (accF)      items = items.filter(i => i.account === accF);
  if (hideEmpty) items = items.filter(i => i.title || i.company);
  if (search)    items = items.filter(i =>
    (i.title||'').toLowerCase().includes(search) ||
    (i.company||'').toLowerCase().includes(search) ||
    (i.vacancy_id||'').includes(search)
  );

  // Sort
  const sf = AppliedSort.field, sd = AppliedSort.dir;
  items = [...items].sort((a, b) => {
    let av = a[sf] ?? '', bv = b[sf] ?? '';
    if (typeof av === 'number') return (av - bv) * sd;
    return String(av).localeCompare(String(bv), 'ru') * sd;
  });

  document.getElementById('applied-count').textContent = `(${items.length})`;
  AppliedState.shown = Math.min(AppliedState.pageSize, items.length);
  appliedFillTable(items.slice(0, AppliedState.shown));

  const lm = document.getElementById('applied-loadmore');
  const sh = document.getElementById('applied-shown');
  if (items.length > AppliedState.shown) {
    lm.style.display = 'block';
    sh.textContent = `${t('shown_of')} ${AppliedState.shown} ${t('shown_of2')} ${items.length}`;
    lm._items = items;
  } else {
    lm.style.display = 'none';
  }
}

function appliedShowMore() {
  const lm = document.getElementById('applied-loadmore');
  const items = lm._items || [];
  AppliedState.shown = Math.min(AppliedState.shown + AppliedState.pageSize, items.length);
  appliedFillTable(items.slice(0, AppliedState.shown));
  const sh = document.getElementById('applied-shown');
  if (AppliedState.shown >= items.length) {
    lm.style.display = 'none';
  } else {
    sh.textContent = `${t('shown_of')} ${AppliedState.shown} ${t('shown_of2')} ${items.length}`;
  }
}

function appliedFillTable(items) {
  const tbody = document.getElementById('applied-tbody');
  tbody.innerHTML = items.map(item => {
    const dt = item.at
      ? new Date(item.at).toLocaleString('ru-RU', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})
      : '';
    const acc = (item.account || '').replace(/^(.*?)\s*\((.+?)\)\s*$/, '$2') || item.account || '';
    const sal = item.salary_from || item.salary_to
      ? `${item.salary_from ? item.salary_from.toLocaleString('ru') : '?'} ‚Äî ${item.salary_to ? item.salary_to.toLocaleString('ru') : '?'}`
      : '';
    const hasTitle = !!(item.title || item.company);
    const titleCell = item.title
      ? `<a href="${esc(item.url)}" target="_blank">${esc(item.title)}</a>`
      : `<a href="${esc(item.url)}" target="_blank" style="color:var(--dim)">hh.ru/vacancy/${esc(item.vacancy_id)}</a>`;
    return `<tr class="${hasTitle ? '' : 'row-no-title'}">
      <td class="c-dim" style="white-space:nowrap">${dt}</td>
      <td style="white-space:nowrap">${esc(acc)}</td>
      <td>${titleCell}</td>
      <td>${esc(item.company || '')}</td>
      <td class="c-green" style="white-space:nowrap">${sal}</td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ Vacancy DB tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DBState = { all: [], shown: 0, pageSize: 100 };
const DB_STATUS = {
  sent:         ['‚úÖ', 'db_status_sent_lbl',        'c-green'],
  test_passed:  ['üìù', 'db_status_test_passed_lbl', 'c-cyan'],
  test_pending: ['üß™', 'db_status_test_pending_lbl','c-magenta'],
};
// DB_STATUS translated labels
T.ru.db_status_sent_lbl         = '–û—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å';
T.ru.db_status_test_passed_lbl  = '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω';
T.ru.db_status_test_pending_lbl = '–ù–µ –ø—Ä–æ–π–¥–µ–Ω';
T.en.db_status_sent_lbl         = 'Applied';
T.en.db_status_test_passed_lbl  = 'Test passed';
T.en.db_status_test_pending_lbl = 'Not passed';

async function loadDB(force) {
  if (!force && DBState.all.length) { dbRender(); return; }
  try {
    const res = await fetch('/api/vacancies?limit=3000');
    const items = await res.json();
    DBState.all = items;
    // Populate account filter
    const sel = document.getElementById('db-acc-filter');
    const prev = sel.value;
    const accs = [...new Set(items.flatMap(i => i.applied_by || []))].sort();
    sel.innerHTML = `<option value="">${t('db_all_accs')}</option>` +
      accs.map(a => `<option value="${esc(a)}"${a===prev?' selected':''}>${esc(a)}</option>`).join('');
    dbRender();
  } catch(e) { console.error('loadDB', e); }
}

function dbSort(field) {
  if (DBSort.field === field) DBSort.dir *= -1;
  else { DBSort.field = field; DBSort.dir = -1; }
  document.querySelectorAll('#panel-db .sort-th').forEach(th => {
    const f = th.getAttribute('onclick')?.match(/dbSort\('(\w+)'\)/)?.[1];
    th.classList.toggle('sorted', f === field);
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.textContent = (f === field) ? (DBSort.dir === -1 ? '‚Üì' : '‚Üë') : '‚Üï';
  });
  dbRender();
}

function dbRender() {
  const search  = (document.getElementById('db-search')?.value || '').toLowerCase();
  const statusF = document.getElementById('db-status-filter')?.value || '';
  const accF    = document.getElementById('db-acc-filter')?.value || '';

  let items = DBState.all;
  if (statusF) items = items.filter(i => i.status === statusF);
  if (accF)    items = items.filter(i => (i.applied_by || []).includes(accF));
  if (search)  items = items.filter(i =>
    (i.title||'').toLowerCase().includes(search) ||
    (i.company||'').toLowerCase().includes(search) ||
    (i.vacancy_id||'').includes(search)
  );

  // Sort
  const sf = DBSort.field, sd = DBSort.dir;
  items = [...items].sort((a, b) => {
    let av = a[sf] ?? '', bv = b[sf] ?? '';
    if (typeof av === 'number') return (av - bv) * sd;
    return String(av).localeCompare(String(bv), 'ru') * sd;
  });

  document.getElementById('db-count').textContent =
    `(${items.length} –∏–∑ ${DBState.all.length})`;
  DBState.shown = Math.min(DBState.pageSize, items.length);
  dbFillTable(items.slice(0, DBState.shown));

  const lm = document.getElementById('db-loadmore');
  const sh = document.getElementById('db-shown');
  if (items.length > DBState.shown) {
    lm.style.display = 'block';
    sh.textContent = `${t('shown_of')} ${DBState.shown} ${t('shown_of2')} ${items.length}`;
    lm._items = items;
  } else {
    lm.style.display = 'none';
  }
}

function dbShowMore() {
  const lm = document.getElementById('db-loadmore');
  const items = lm._items || [];
  DBState.shown = Math.min(DBState.shown + DBState.pageSize, items.length);
  dbFillTable(items.slice(0, DBState.shown));
  const sh = document.getElementById('db-shown');
  if (DBState.shown >= items.length) lm.style.display = 'none';
  else sh.textContent = `${t('shown_of')} ${DBState.shown} ${t('shown_of2')} ${items.length}`;
}

function dbFillTable(items) {
  const tbody = document.getElementById('db-tbody');
  tbody.innerHTML = items.map(item => {
    const [icon, labelKey, cls] = DB_STATUS[item.status] || ['‚ùì', null, 'c-dim'];
    const label = labelKey ? t(labelKey) : item.status;
    const dt = item.at
      ? new Date(item.at).toLocaleString('ru-RU', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})
      : '';
    const titleCell = item.title
      ? `<a href="${esc(item.url)}" target="_blank">${esc(item.title)}</a>`
      : `<a href="${esc(item.url)}" target="_blank" style="color:var(--dim)">hh.ru/vacancy/${esc(item.vacancy_id)}</a>`;
    const accs = (item.applied_by || [])
      .map(a => `<span style="font-size:10px;background:var(--bg-card2);padding:1px 5px;border-radius:3px">${esc(a.replace(/^.*?\((.+?)\).*$/, '$1') || a)}</span>`)
      .join(' ');
    return `<tr>
      <td><span class="${cls}" style="white-space:nowrap">${icon} ${label}</span></td>
      <td class="c-dim" style="white-space:nowrap">${dt}</td>
      <td>${titleCell}</td>
      <td>${esc(item.company || '')}</td>
      <td>${accs || '<span class="c-dim">‚Äî</span>'}</td>
      <td><button class="btn-sm" style="padding:1px 6px;color:var(--red);border-color:var(--red)"
        onclick="dbDelete('${esc(item.vacancy_id)}',this)" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã">‚úï</button></td>
    </tr>`;
  }).join('');
}

async function dbDelete(vid, btn) {
  if (!await showConfirm(`${t('confirm_del_db_pre')} <b>${vid}</b> ${t('confirm_del_db_mid')}<br><span style="color:var(--dim);font-size:12px">${t('confirm_del_db_body')}</span>`)) return;
  btn.disabled = true;
  try {
    const res = await fetch(`/api/vacancy/${vid}`, {method:'DELETE'});
    const data = await res.json();
    if (data.ok) {
      DBState.all = DBState.all.filter(i => i.vacancy_id !== vid);
      btn.closest('tr').remove();
      const cnt = document.getElementById('db-count');
      if (cnt) cnt.textContent = `(${DBState.all.length})`;
    } else {
      btn.disabled = false;
    }
  } catch(e) { btn.disabled = false; }
}

async function loadTests() {
  try {
    const res = await fetch('/api/tests?limit=300');
    const items = await res.json();
    const tbody = document.getElementById('tests-tbody');
    document.getElementById('tests-count').textContent = `(${items.length})`;

    tbody.innerHTML = items.map(item => {
      const dt = item.at ? new Date(item.at).toLocaleString('ru-RU', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
      // Account name: short (strip parenthetical) if possible
      const accFull = item.account_name || '';
      const accShort = accFull.replace(/^.*?\((.+?)\).*$/, '$1') || accFull;
      const resumeLink = item.resume_hash
        ? `<a href="https://hh.ru/resume/${item.resume_hash}" target="_blank" style="font-size:11px;color:var(--cyan)">${accShort}</a>`
        : `<span class="c-dim">${esc(accShort) || '‚Äî'}</span>`;
      // Applied by list
      const appliedBy = item.applied_by || [];
      const appliedCell = appliedBy.length
        ? `<span style="color:var(--green)">‚úÖ ${appliedBy.map(a => a.replace(/^.*?\((.+?)\).*$/, '$1') || a).join(', ')}</span>`
        : `<span class="c-dim">‚Äî</span>`;
      return `<tr>
        <td class="c-dim">${dt}</td>
        <td>${esc(item.title || item.vacancy_id)}</td>
        <td>${esc(item.company)}</td>
        <td>${resumeLink}</td>
        <td>${appliedCell}</td>
        <td><a href="${esc(item.url)}" target="_blank">hh.ru/vacancy/${item.vacancy_id}</a></td>
      </tr>`;
    }).join('');
  } catch(e) {}
}

// ‚îÄ‚îÄ Tabs switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('tabs').addEventListener('click', e => {
  const t = e.target.closest('.tab');
  if (!t) return;
  const tab = t.dataset.tab;
  if (!tab) return;

  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
  t.classList.add('active');
  document.getElementById('panel-' + tab).classList.add('active');
  State.currentTab = tab;
  try { localStorage.setItem('hh-tab', tab); } catch(e) {}

  // Reset settings-tab built flags so they rebuild with fresh data on next open
  if (tab !== 'settings') {
    const urlEl = document.getElementById('url-pool-rows');
    if (urlEl) urlEl.dataset.built = 'false';
    const sessEl = document.getElementById('sess-list');
    if (sessEl) sessEl.dataset.count = '';
  }

  // Load REST tabs on switch
  if (tab === 'applied') loadApplied();
  else if (tab === 'tests') loadTests();
  else if (tab === 'db') loadDB();
  else if (tab === 'hh' && State.lastSnapshot) renderHH(State.lastSnapshot);
  else if (tab === 'llm') {
    // Only reload table if stale (>10s since last load) ‚Äî prevents wipe on quick tab switches
    const stale = Date.now() - _llmLastDbRefresh > 10000;
    if (stale) { llmInterviewsLoad(); llmRenderAccStats(); }
    if (State.lastSnapshot) renderLlmLog(State.lastSnapshot);
  }
  else if (tab === 'log' && State.lastSnapshot) renderLog(State.lastSnapshot);
  else if (tab === 'views') loadViews();
  else if (tab === 'apply') {
    if (State.lastSnapshot) applyBuildAccountSelect(State.lastSnapshot);
  }
  else if (tab === 'settings' && State.lastSnapshot) {
    syncSettingsSliders(State.lastSnapshot);
    qSyncFromSnapshot(State.lastSnapshot);
    ltSyncFromSnapshot(State.lastSnapshot);
    buildAccCookiesList(State.lastSnapshot);
    urlPoolBuild(State.lastSnapshot);
    buildSessList(State.lastSnapshot);
  }
});

function syncSettingsSliders(snap) {
  if (!snap.config) return;
  SETTINGS_DEF.forEach(s => {
    const el = document.getElementById('sr-' + s.key);
    const sv = document.getElementById('sv-' + s.key);
    if (el && snap.config[s.key] !== undefined) {
      el.value = snap.config[s.key];
      if (sv) sv.textContent = snap.config[s.key];
    }
  });
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) {
  if (!s) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function colorVar(color) {
  const map = {
    cyan: 'var(--cyan)',
    magenta: 'var(--magenta)',
    green: 'var(--green)',
    yellow: 'var(--yellow)',
    red: 'var(--red)',
    blue: 'var(--blue)',
  };
  return map[color] || 'var(--text)';
}

// ‚îÄ‚îÄ Session mode toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _sessMode = 'curl';
function sessSetMode(mode) {
  _sessMode = mode;
  document.getElementById('sess-panel-curl').style.display   = mode === 'curl'   ? '' : 'none';
  document.getElementById('sess-panel-manual').style.display = mode === 'manual' ? '' : 'none';
  const btnCurl   = document.getElementById('sess-mode-curl');
  const btnManual = document.getElementById('sess-mode-manual');
  btnCurl.style.background   = mode === 'curl'   ? 'var(--cyan)' : 'transparent';
  btnCurl.style.color        = mode === 'curl'   ? '#000'        : 'var(--dim)';
  btnManual.style.background = mode === 'manual' ? 'var(--cyan)' : 'transparent';
  btnManual.style.color      = mode === 'manual' ? '#000'        : 'var(--dim)';
}

// ‚îÄ‚îÄ Session Add ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sessionAdd() {
  const nameEl   = document.getElementById('session-name');
  const letterEl = document.getElementById('session-letter');
  const st       = document.getElementById('session-status');
  let cookieStr = '';

  if (_sessMode === 'manual') {
    const hhtoken   = document.getElementById('ck-hhtoken')?.value.trim();
    const xsrf      = document.getElementById('ck-xsrf')?.value.trim();
    const hhul      = document.getElementById('ck-hhul')?.value.trim();
    const cryptedId = document.getElementById('ck-crypted-id')?.value.trim();
    if (!hhtoken) { st.textContent = '‚ùå hhtoken –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'; st.style.color = 'var(--red)'; return; }
    if (!xsrf)    { st.textContent = '‚ùå _xsrf –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω';   st.style.color = 'var(--red)'; return; }
    const parts = [`hhtoken=${hhtoken}`, `_xsrf=${xsrf}`];
    if (hhul)      parts.push(`hhul=${hhul}`);
    if (cryptedId) parts.push(`crypted_id=${cryptedId}`);
    cookieStr = parts.join('; ');
  } else {
    const ta = document.getElementById('session-cookies');
    cookieStr = ta?.value.trim();
    if (!cookieStr) { st.textContent = '‚ùå –í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É cookies'; st.style.color = 'var(--red)'; return; }
  }

  st.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é —Å–µ—Å—Å–∏—é...'; st.style.color = 'var(--dim)';
  try {
    const res = await fetch('/api/session/add', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        cookies: cookieStr,
        name: nameEl?.value.trim() || '',
        letter: letterEl?.value || ''
      })
    });
    const data = await res.json();
    if (data.status === 'ok') {
      st.textContent = '‚úÖ ' + data.message; st.style.color = 'var(--green)';
      // –û—á–∏—â–∞–µ–º –æ–±–∞ —Ä–µ–∂–∏–º–∞
      const ta = document.getElementById('session-cookies');
      if (ta) ta.value = '';
      ['ck-hhtoken','ck-xsrf','ck-hhul','ck-crypted-id'].forEach(id => {
        const el = document.getElementById(id); if (el) el.value = '';
      });
      if (nameEl)   nameEl.value = '';
      if (letterEl) letterEl.value = '';
    } else {
      st.textContent = '‚ùå ' + data.message; st.style.color = 'var(--red)';
    }
  } catch(e) {
    st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)';
  }
}


async function sessionChangeResume(idx, hash) {
  await fetch('/api/session/' + idx, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ resume_hash: hash })
  });
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–∑—é–º–µ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
  const card = document.getElementById('sess-card-' + idx);
  if (card) {
    const link = card.querySelector('a[href*="/resume/"]');
    if (link) link.href = 'https://hh.ru/resume/' + hash;
  }
}

async function sessionSaveLetter(idx) {
  const ta = document.getElementById('sess-letter-' + idx);
  const st = document.getElementById('sess-letter-st-' + idx);
  if (!ta || !st) return;
  st.textContent = '‚è≥'; st.style.color = 'var(--dim)';
  try {
    const res = await fetch('/api/session/' + idx, {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({letter: ta.value})
    });
    const data = await res.json();
    if (data.status === 'ok') {
      st.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; st.style.color = 'var(--green)';
      // –û–±–Ω–æ–≤–∏—Ç—å ApplyLetters —á—Ç–æ–±—ã —à–∞–±–ª–æ–Ω –≤ –¥—Ä–æ–ø–¥–∞—É–Ω–µ —Ç–æ–∂–µ –æ–±–Ω–æ–≤–∏–ª—Å—è
      ApplyLetters[idx] = ta.value;
      setTimeout(() => { st.textContent = ''; }, 2000);
    } else {
      st.textContent = '‚ùå ' + data.message; st.style.color = 'var(--red)';
    }
  } catch(e) {
    st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)';
  }
}

async function sessionRemove(idx) {
  if (!await showConfirm(t('confirm_del_sess'))) return;
  const card = document.getElementById('card-' + idx);
  if (card) card.remove();
  await fetch('/api/session/' + idx, {method: 'DELETE'});
}

async function sessionRefresh(idx) {
  const res = await fetch('/api/session/' + idx + '/refresh', {method: 'POST'});
  const data = await res.json();
  // snapshot will update via WS
}

async function sessionActivate(idx) {
  const res = await fetch('/api/session/' + idx + '/activate', {method: 'POST'});
  const data = await res.json();
  if (data.status !== 'ok') {
    alert('–û—à–∏–±–∫–∞: ' + data.message);
  }
}

// ‚îÄ‚îÄ Apply Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ApplyState = { checking: false, submitting: false, vid: '', accIdx: 0, questions: [] };

const ApplyLetters = {};

function applyBuildAccountSelect(snap) {
  const sel = document.getElementById('apply-account');
  const tpl = document.getElementById('apply-letter-tpl');
  if (!sel || !snap) return;

  (snap.accounts || []).forEach(a => { ApplyLetters[a.idx] = a.letter || ''; });

  // –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Å–æ—Å—Ç–∞–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
  const newKey = (snap.accounts || []).map(a => a.idx + ':' + a.name).join(',');
  if (sel.dataset.builtKey !== newKey) {
    sel.dataset.builtKey = newKey;
    const prev = sel.value;
    sel.innerHTML = (snap.accounts || []).map(a =>
      `<option value="${a.idx}">${esc(a.name)}</option>`
    ).join('');
    if (prev) sel.value = prev;
  }

  // Rebuild template dropdown: one option per account letter
  if (tpl) {
    const newTplKey = newKey;
    if (tpl.dataset.builtKey !== newTplKey) {
      tpl.dataset.builtKey = newTplKey;
      const prevTpl = tpl.value;
      tpl.innerHTML = `<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω ‚Äî</option>` +
        (snap.accounts || []).map(a =>
          `<option value="${a.idx}">${esc(a.name)}</option>`
        ).join('');
      if (prevTpl) tpl.value = prevTpl;
    }
  }

  // Fill letter textarea if it's empty or still contains a default letter
  const ta = document.getElementById('apply-letter');
  if (ta && (!ta.value || Object.values(ApplyLetters).includes(ta.value))) {
    ta.value = ApplyLetters[parseInt(sel.value) || 0] || '';
  }
}

function applyFillLetter(idx) {
  const ta = document.getElementById('apply-letter');
  if (ta) ta.value = ApplyLetters[parseInt(idx)] || '';
  // Sync template selector to the chosen account
  const tpl = document.getElementById('apply-letter-tpl');
  if (tpl) tpl.value = idx;
}

function applyPickTemplate(idx) {
  if (!idx) return;
  const ta = document.getElementById('apply-letter');
  if (ta && ApplyLetters[parseInt(idx)] !== undefined)
    ta.value = ApplyLetters[parseInt(idx)];
}

function applyShowResult(msg, type) {
  const el = document.getElementById('apply-result');
  el.style.display = '';
  el.className = 'apply-result ' + type;
  el.innerHTML = msg;
}

function applyHideQuestionnaire() {
  document.getElementById('apply-questionnaire').style.display = 'none';
  document.getElementById('apply-questionnaire').innerHTML = '';
}

async function applyCheck() {
  if (ApplyState.checking) return;
  const accIdx = parseInt(document.getElementById('apply-account').value || '0');
  const raw = document.getElementById('apply-vacancy').value.trim();
  if (!raw) { applyShowResult('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID –≤–∞–∫–∞–Ω—Å–∏–∏', 'err'); return; }

  ApplyState.checking = true;
  ApplyState.accIdx = accIdx;
  applyHideQuestionnaire();
  applyShowResult('‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –≤–∞–∫–∞–Ω—Å–∏—é...', 'info');

  try {
    const letter = document.getElementById('apply-letter')?.value || '';
    const res = await fetch('/api/apply/check', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({account_idx: accIdx, vacancy_id: raw, letter})
    });
    const data = await res.json();
    ApplyState.vid = data.vacancy_id || raw;

    if (data.status === 'sent') {
      applyShowResult(`‚úÖ ${data.message}`, 'ok');
      applyHideQuestionnaire();
    } else if (data.status === 'already') {
      applyShowResult(`üîÑ ${data.message}`, 'warn');
    } else if (data.status === 'limit') {
      applyShowResult(`üö´ ${data.message}`, 'err');
    } else if (data.status === 'test_required') {
      ApplyState.questions = data.questions || [];
      applyShowResult(
        `üìù <b>${data.message}</b><br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç—ã –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è¬ª`,
        'info'
      );
      applyRenderQuestionnaire(data);
    } else {
      applyShowResult(`‚ùå ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'err');
    }
  } catch(e) {
    applyShowResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + e, 'err');
  } finally {
    ApplyState.checking = false;
  }
}

function applyRenderQuestionnaire(data) {
  const el = document.getElementById('apply-questionnaire');
  el.style.display = '';
  const qs = data.questions || [];

  let html = `
    <hr class="apply-divider">
    <div style="font-size:13px;font-weight:700;margin-bottom:12px">
      üìã –û–ø—Ä–æ—Å–Ω–∏–∫ ‚Äî ${qs.length} –≤–æ–ø—Ä–æ—Å–æ–≤
    </div>

    <div class="apply-q-list">
  `;

  qs.forEach((q, i) => {
    html += `<div class="apply-q-item">
      <div class="apply-q-num">–í–æ–ø—Ä–æ—Å ${i+1} –∏–∑ ${qs.length}</div>
      <div class="apply-q-text">${esc(q.text)}</div>
    `;

    if (q.type === 'radio') {
      html += `<div class="apply-radio-opts">`;
      q.options.forEach(opt => {
        const checked = opt.value === q.suggested ? 'checked' : '';
        html += `<label class="apply-radio-opt">
          <input type="radio" name="aq_${q.field}" value="${esc(opt.value)}" ${checked}>
          ${esc(opt.label)}
        </label>`;
      });
      html += `</div>`;
    } else if (q.type === 'textarea') {
      html += `<textarea class="apply-q-answer" id="aq_${q.field}" rows="3">${esc(q.suggested)}</textarea>`;
    }
    html += `</div>`;
  });

  html += `</div>
    <div class="apply-btn-row" style="margin-top:16px">
      <button class="apply-btn" onclick="applySubmit()">üöÄ –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button>
      <button class="apply-btn-secondary" onclick="applyHideQuestionnaire();applyShowResult('','');document.getElementById('apply-result').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
      <span id="apply-submit-status" style="font-size:12px;color:var(--dim)"></span>
    </div>
  `;

  el.innerHTML = html;
}

async function applySubmit() {
  if (ApplyState.submitting) return;
  ApplyState.submitting = true;
  const statusEl = document.getElementById('apply-submit-status');
  if (statusEl) statusEl.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é...';

  // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã
  const answers = {};
  ApplyState.questions.forEach(q => {
    if (q.type === 'radio') {
      const checked = document.querySelector(`input[name="aq_${q.field}"]:checked`);
      if (checked) answers[q.field] = checked.value;
    } else if (q.type === 'textarea') {
      const ta = document.getElementById('aq_' + q.field);
      if (ta) answers[q.field] = ta.value;
    }
  });

  const letter = document.getElementById('apply-letter')?.value || '';

  try {
    const res = await fetch('/api/apply/submit', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({account_idx: ApplyState.accIdx, vacancy_id: ApplyState.vid, letter, answers})
    });
    const data = await res.json();

    if (data.status === 'sent') {
      applyShowResult(`‚úÖ ${data.message}`, 'ok');
      applyHideQuestionnaire();
    } else if (data.status === 'limit') {
      applyShowResult(`üö´ ${data.message}`, 'err');
    } else {
      applyShowResult(`‚ùå ${data.message}`, 'err');
    }
    if (statusEl) statusEl.textContent = '';
  } catch(e) {
    applyShowResult('‚ùå –û—à–∏–±–∫–∞: ' + e, 'err');
  } finally {
    ApplyState.submitting = false;
  }
}

// ‚îÄ‚îÄ Resume Views Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadViews() {
  const statsRow = document.getElementById('views-stats-row');
  const accsEl = document.getElementById('views-accounts');
  if (!statsRow || !accsEl) return;

  const snap = State.lastSnapshot;
  if (!snap) return;

  // Aggregate header stats
  let totalViews = 0, totalViewsNew = 0, totalShows = 0, totalInv = 0, totalInvNew = 0;
  (snap.accounts || []).forEach(a => {
    totalViews += a.resume_views_7d || 0;
    totalViewsNew += a.resume_views_new || 0;
    totalShows += a.resume_shows_7d || 0;
    totalInv += a.resume_invitations_7d || 0;
    totalInvNew += a.resume_invitations_new || 0;
  });

  statsRow.innerHTML = `
    <div class="views-stat-card"><div class="views-stat-val c-cyan">${totalViews}</div><div class="views-stat-lbl">${t('views_7d')}</div></div>
    <div class="views-stat-card"><div class="views-stat-val c-green">+${totalViewsNew}</div><div class="views-stat-lbl">${t('views_new')}</div></div>
    <div class="views-stat-card"><div class="views-stat-val" style="color:var(--dim)">${totalShows}</div><div class="views-stat-lbl">${t('views_shows')}</div></div>
    <div class="views-stat-card"><div class="views-stat-val c-magenta">${totalInv}</div><div class="views-stat-lbl">${t('views_invitations')}</div></div>
    <div class="views-stat-card"><div class="views-stat-val c-green">+${totalInvNew}</div><div class="views-stat-lbl">${t('views_inv_new')}</div></div>
  `;

  // Per-account blocks
  const existingIds = new Set([...accsEl.querySelectorAll('.views-acc-block')].map(el => el.dataset.idx));
  const snapIds = new Set((snap.accounts || []).map(a => String(a.idx)));
  const needRebuild = [...snapIds].some(id => !existingIds.has(id)) || [...existingIds].some(id => !snapIds.has(id));

  if (needRebuild) {
    accsEl.innerHTML = '';
    for (const acc of (snap.accounts || [])) {
      const block = document.createElement('div');
      block.className = 'views-acc-block';
      block.dataset.idx = String(acc.idx);
      const colorStyle = `color:${colorVar(acc.color)}`;
      block.innerHTML = `
        <div class="views-acc-title">
          <span style="${colorStyle}">${esc(acc.name)}</span>
          <button class="btn-refresh" onclick="loadViewHistory(${acc.idx})">${t('btn_load_history')}</button>
          <button class="btn-sm" onclick="declineDiscards(${acc.idx},this)">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∏—Å–∫–∞—Ä–¥—ã</button>
        </div>
        <div id="views-hist-${acc.idx}"><div class="c-dim" style="font-size:12px;padding:8px 0">‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...</div></div>
      `;
      accsEl.appendChild(block);
      loadViewHistory(acc.idx);
    }
  } else {
    // –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è —Ç–µ—Ö —É –∫–æ–≥–æ –µ—â—ë –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ loaded
    for (const acc of (snap.accounts || [])) {
      const histEl = document.getElementById('views-hist-' + acc.idx);
      if (histEl && !histEl.dataset.loaded && !histEl.dataset.loading) {
        histEl.dataset.loading = '1';
        loadViewHistory(acc.idx).finally(() => { histEl.removeAttribute('data-loading'); });
      }
    }
  }
}

async function loadViewHistory(idx) {
  const el = document.getElementById('views-hist-' + idx);
  if (!el) return;
  el.innerHTML = '<div class="c-dim" style="font-size:12px;padding:8px 0">‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...</div>';
  try {
    const res = await fetch(`/api/account/${idx}/resume_views`);
    const data = await res.json();

    // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–æ–≤ —Å—Ä–∞–∑—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ API –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å WebSocket
    const s = data.stats || {};
    const statsRow = document.getElementById('views-stats-row');
    if (statsRow && (s.views_7d || s.shows_7d || s.invitations_7d)) {
      statsRow.querySelector('.views-stat-val.c-cyan') && (statsRow.querySelector('.views-stat-val.c-cyan').textContent = s.views_7d || 0);
      const greens = statsRow.querySelectorAll('.views-stat-val.c-green');
      if (greens[0]) greens[0].textContent = '+' + (s.views_new || 0);
      if (greens[1]) greens[1].textContent = '+' + (s.invitations_new || 0);
      const dim = statsRow.querySelector('.views-stat-val[style]');
      if (dim) dim.textContent = s.shows_7d || 0;
      const magenta = statsRow.querySelector('.views-stat-val.c-magenta');
      if (magenta) magenta.textContent = s.invitations_7d || 0;
    }

    el.dataset.loaded = '1'; // –ø–æ–º–µ—á–∞–µ–º ‚Äî –±–æ–ª—å—à–µ –Ω–µ —Ä–µ—Ç—Ä–∞–∏—Ç—å
    const history = data.history || [];
    if (!history.length) {
      el.innerHTML = `<div class="c-dim" style="font-size:12px;padding:8px 0">${t('views_no_data')}</div>`;
      return;
    }
    el.innerHTML = `
      <table class="views-table">
        <thead><tr><th>${t('col_date')}</th><th>${t('col_employer')}</th><th>${t('col_vacancy')}</th></tr></thead>
        <tbody>
          ${history.map(h => `<tr>
            <td class="c-dim">${esc(h.date)}</td>
            <td><a href="https://hh.ru/employer/${esc(h.employer_id)}" target="_blank">${esc(h.name)}</a></td>
            <td class="c-dim">${esc(h.vacancy)}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    `;
  } catch(e) {
    el.innerHTML = '<div class="c-red" style="font-size:12px">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
    // –Ω–µ —Å—Ç–∞–≤–∏–º loaded ‚Äî –ø—É—Å—Ç—å retry –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Ç–∏–∫–µ
  }
}

async function declineDiscards(idx, btn) {
  if (!btn) return;
  btn.disabled = true;
  btn.textContent = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...';
  try {
    const res = await fetch(`/api/account/${idx}/decline_discards`, {method:'POST'});
    const data = await res.json();
    btn.textContent = `‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: ${data.declined || 0}`;
    setTimeout(() => { btn.disabled = false; btn.textContent = t('btn_clear_discards'); }, 4000);
  } catch(e) {
    btn.textContent = '‚ùå –û—à–∏–±–∫–∞';
    setTimeout(() => { btn.disabled = false; btn.textContent = t('btn_clear_discards'); }, 3000);
  }
}

async function applyTestsToggle(idx, cb) {
  try {
    const res = await fetch(`/api/account/${idx}/apply_tests`, {method:'POST'});
    const data = await res.json();
    if (!data.ok) { cb.checked = !cb.checked; return; }
    const label = document.getElementById('acc-apply-label-' + idx);
    if (label) {
      if (data.apply_tests) label.classList.add('active');
      else label.classList.remove('active');
    }
  } catch(e) {
    cb.checked = !cb.checked;
  }
}

// ‚îÄ‚îÄ JSON Editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const JSON_CONFIG_TEMPLATE = {
  "pages_per_url": 3,
  "max_concurrent": 5,
  "response_delay": 2,
  "pause_between_cycles": 5,
  "limit_check_interval": 30,
  "resume_touch_interval": 4,
  "batch_responses": 5,
  "min_salary": 0,
  "questionnaire_default_answer": "–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.",
  "questionnaire_templates": [
    {"keyword": "–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –≤–æ–ø—Ä–æ—Å–∞", "answer": "–æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å"}
  ],
  "letter_templates": [
    {"name": "–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞", "text": "–¢–µ–∫—Å—Ç —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∏—Å—å–º–∞..."}
  ],
  "url_pool": [
    {"url": "https://hh.ru/search/vacancy?text=QA&area=1&order_by=publication_time&items_on_page=20", "pages": 40}
  ]
};

const JSON_ACCOUNT_TEMPLATE = {
  "name": "–ò–º—è (–ö–æ–º–ø–∞–Ω–∏—è)",
  "short": "–ò–º—è",
  "color": "yellow",
  "resume_hash": "–í–°–¢–ê–í–¨–¢–ï_–•–≠–®_–†–ï–ó–Æ–ú–ï",
  "letter": "",
  "apply_tests": false,
  "urls": [],
  "cookies": {
    "hhtoken": "",
    "_xsrf": "",
    "hhul": "",
    "crypted_id": ""
  }
};

function jsonConfigTemplate() {
  const ta = document.getElementById('json-config-ta');
  const st = document.getElementById('json-config-st');
  ta.value = JSON.stringify(JSON_CONFIG_TEMPLATE, null, 2);
  st.textContent = 'üìã –®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ';
  st.style.color = 'var(--cyan)';
}

function jsonAccountsTemplate() {
  const ta = document.getElementById('json-accounts-ta');
  const st = document.getElementById('json-accounts-st');
  // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç –≤ –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞
  let arr = [];
  try { arr = JSON.parse(ta.value); if (!Array.isArray(arr)) arr = []; } catch(e) {}
  arr.push(JSON.parse(JSON.stringify(JSON_ACCOUNT_TEMPLATE)));
  ta.value = JSON.stringify(arr, null, 2);
  st.textContent = arr.length > 1
    ? `üìã –î–æ–±–∞–≤–ª–µ–Ω —à–∞–±–ª–æ–Ω –∞–∫–∫–∞—É–Ω—Ç–∞ (–≤—Å–µ–≥–æ ${arr.length})`
    : 'üìã –®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ';
  st.style.color = 'var(--cyan)';
}
async function jsonConfigLoad(btn) {
  btn.disabled = true;
  try {
    const res = await fetch('/api/raw/config');
    const data = await res.json();
    document.getElementById('json-config-ta').value = JSON.stringify(data, null, 2);
    document.getElementById('json-config-st').textContent = '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ';
    document.getElementById('json-config-st').style.color = 'var(--green)';
  } catch(e) {
    document.getElementById('json-config-st').textContent = '‚ùå ' + e;
    document.getElementById('json-config-st').style.color = 'var(--red)';
  }
  btn.disabled = false;
}

async function jsonConfigSave(btn) {
  const ta = document.getElementById('json-config-ta');
  const st = document.getElementById('json-config-st');
  let parsed;
  try { parsed = JSON.parse(ta.value); }
  catch(e) { st.textContent = '‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON: ' + e.message; st.style.color = 'var(--red)'; return; }
  btn.disabled = true;
  try {
    const res = await fetch('/api/raw/config', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(parsed)
    });
    const data = await res.json();
    if (data.ok) { st.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; st.style.color = 'var(--green)'; }
    else { st.textContent = '‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'); st.style.color = 'var(--red)'; }
  } catch(e) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  btn.disabled = false;
}

async function jsonAccountsLoad(btn) {
  btn.disabled = true;
  try {
    const res = await fetch('/api/raw/accounts');
    const data = await res.json();
    document.getElementById('json-accounts-ta').value = JSON.stringify(data, null, 2);
    document.getElementById('json-accounts-st').textContent = '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ';
    document.getElementById('json-accounts-st').style.color = 'var(--green)';
  } catch(e) {
    document.getElementById('json-accounts-st').textContent = '‚ùå ' + e;
    document.getElementById('json-accounts-st').style.color = 'var(--red)';
  }
  btn.disabled = false;
}

async function jsonAccountsSave(btn) {
  const ta = document.getElementById('json-accounts-ta');
  const st = document.getElementById('json-accounts-st');
  let parsed;
  try { parsed = JSON.parse(ta.value); }
  catch(e) { st.textContent = '‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON: ' + e.message; st.style.color = 'var(--red)'; return; }
  if (!Array.isArray(parsed)) {
    st.textContent = '‚ùå –û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤'; st.style.color = 'var(--red)'; return;
  }
  btn.disabled = true;
  try {
    const res = await fetch('/api/raw/accounts', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(parsed)
    });
    const data = await res.json();
    if (data.ok) { st.textContent = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (${data.count} –∞–∫–∫–∞—É–Ω—Ç–æ–≤)`; st.style.color = 'var(--green)'; }
    else { st.textContent = '‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'); st.style.color = 'var(--red)'; }
  } catch(e) { st.textContent = '‚ùå ' + e; st.style.color = 'var(--red)'; }
  btn.disabled = false;
}

// Update header resume stats
function updateHeaderResumeStats(snap) {
  let totalViewsNew = 0, totalInvNew = 0, totalShows = 0;
  (snap.accounts || []).forEach(a => {
    totalViewsNew += a.resume_views_new || 0;
    totalInvNew += a.resume_invitations_new || 0;
    totalShows += a.resume_shows_7d || 0;
  });
  const hdrEl = document.getElementById('hdr-resume-stats');
  if (hdrEl) {
    hdrEl.style.display = (totalViewsNew > 0 || totalInvNew > 0 || totalShows > 0) ? '' : 'none';
    setText('hdr-views-new', totalViewsNew);
    setText('hdr-inv-new', totalInvNew);
    setText('hdr-shows', totalShows);
  }
}

// ‚îÄ‚îÄ Questionnaire templates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function qRenderTemplates(templates) {
  const list = document.getElementById('q-templates-list');
  list.innerHTML = '';
  (templates || []).forEach((tmpl, i) => {
    const row = document.createElement('div');
    row.className = 'q-template-row';
    row.dataset.idx = i;
    row.innerHTML = `
      <button class="q-del" onclick="qDelTemplate(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
      <label>${t('q_keywords_label')} ‚Äî –ø–æ –Ω–∏–º –∏—â–µ—Ç—Å—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞</label>
      <input type="text" class="q-keywords-input" placeholder="${t('q_keywords_ph')}"
        value="${esc((tmpl.keywords || []).join(', '))}">
      <label>${t('q_answer_label')}</label>
      <textarea class="q-answer-input" rows="3" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">${esc(tmpl.answer || '')}</textarea>
    `;
    list.appendChild(row);
  });
}

// ‚îÄ‚îÄ Questionnaire presets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Q_PRESETS = {
  universal: {
    default: '–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.',
    templates: [
      { keywords: ['–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫'],
        answer: '–î–∞, –≥–æ—Ç–æ–≤–∞ –∫ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞–º.' },
      { keywords: ['–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫', '—Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω', '–∑–∞–¥–µ—Ä–∂'],
        answer: '–î–∞, –≥–æ—Ç–æ–≤–∞ –∫ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.' },
      { keywords: ['–Ω–µ–Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω', '–≥–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫', '–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω'],
        answer: '–î–∞, —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é.' },
      { keywords: ['–≤–∞—Ö—Ç'],
        answer: '–ù–µ—Ç, –≤–∞—Ö—Ç–æ–≤—ã–π –º–µ—Ç–æ–¥ –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é.' },
      { keywords: ['–Ω–æ—á–Ω —Å–º–µ–Ω', '—Å–º–µ–Ω–Ω', '–ø–æ—Å–º–µ–Ω–Ω', '2/2', '3/3'],
        answer: '–î–∞, —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é —Å–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫.' },
      { keywords: ['–≤—ã—Ö–æ–¥–Ω', '–ø—Ä–∞–∑–¥–Ω–∏–∫', '—Å—É–±–±–æ—Ç', '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω'],
        answer: '–î–∞, –≥–æ—Ç–æ–≤–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.' },
      { keywords: ['–ø–æ—á–µ–º—É', '–ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç', '—Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å —É –Ω–∞—Å', '—Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤'],
        answer: '–ú–µ–Ω—è –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞.' },
      { keywords: ['—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ', '–æ–ø–∏—à–∏—Ç–µ —Å–µ–±—è', '–∫—Ç–æ –≤—ã'],
        answer: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ —Ü–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª—ë–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã. –ë—ã—Å—Ç—Ä–æ –æ–±—É—á–∞—é—Å—å, —É–º–µ—é —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ –∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. –ì–æ—Ç–æ–≤–∞ –∫ –Ω–æ–≤—ã–º –∑–∞–¥–∞—á–∞–º –∏ —Ä–∞–∑–≤–∏—Ç–∏—é.' },
      { keywords: ['–æ–ø—ã—Ç —Ä–∞–±–æ—Ç', '—Å—Ç–∞–∂', '—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç'],
        answer: '–ò–º–µ—é –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –≤ –¥–∞–Ω–Ω–æ–π —Å—Ñ–µ—Ä–µ –±–æ–ª–µ–µ 2 –ª–µ—Ç. –ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.' },
      { keywords: ['—Å–∏–ª—å–Ω —Å—Ç–æ—Ä–æ–Ω', '–¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤', '–ø—Ä–µ–∏–º—É—â–µ—Å—Ç'],
        answer: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –∫–æ–º–º—É–Ω–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –±—ã—Å—Ç—Ä–æ–µ –æ–±—É—á–µ–Ω–∏–µ.' },
      { keywords: ['–ø–æ—á–µ–º—É —É–≤–æ–ª–∏–ª', '–ø—Ä–µ–¥—ã–¥—É—â', '–ø—Ä–æ—à–ª –º–µ—Å—Ç–æ'],
        answer: '–í –ø–æ–∏—Å–∫–µ –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.' },
      { keywords: ['–∑–∞—Ä–ø–ª–∞—Ç', '–æ–∫–ª–∞–¥', '–¥–æ—Ö–æ–¥', '–≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥', '–æ–∂–∏–¥–∞–Ω–∏', '–∂–µ–ª–∞–µ–º'],
        answer: '–û—Ç 70 000 —Ä—É–±–ª–µ–π. –ì–æ—Ç–æ–≤–∞ –æ–±—Å—É–¥–∏—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.' },
      { keywords: ['–∫–æ–≥–¥–∞', '–ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å', '–≤—ã–π—Ç–∏ –Ω–∞ —Ä–∞–±–æ—Ç—É', '–¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞', '–≥–æ—Ç–æ–≤'],
        answer: '–ì–æ—Ç–æ–≤–∞ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 2 –Ω–µ–¥–µ–ª—å.' },
      { keywords: ['—Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç', '–æ—Ñ–∏—Å', '—É–¥–∞–ª—ë–Ω–Ω', '—É–¥–∞–ª–µ–Ω', 'remote', '–≥–∏–±—Ä–∏–¥'],
        answer: '–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é –≥–∏–±—Ä–∏–¥–Ω—ã–π –∏ —É–¥–∞–ª—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.' },
      { keywords: ['–≥–æ—Ä–æ–¥', '—Ä–µ–≥–∏–æ–Ω', '–ø–µ—Ä–µ–µ–∑–¥', '—Ä–µ–ª–æ–∫–∞—Ü'],
        answer: '–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.' },
      { keywords: ['–∞–Ω–≥–ª–∏–π—Å–∫', 'english', '–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω —è–∑—ã–∫'],
        answer: '–ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å.' },
      { keywords: ['–∞–≤—Ç–æ–º–æ–±–∏–ª', '–º–∞—à–∏–Ω', '–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫', '–ø—Ä–∞–≤–∞ –∫–∞—Ç'],
        answer: '–ù–µ—Ç.' },
      { keywords: ['–æ–±—Ä–∞–∑–æ–≤–∞–Ω', '–¥–∏–ø–ª–æ–º', '–≤—É–∑', '–∏–Ω—Å—Ç–∏—Ç—É—Ç', '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç'],
        answer: '–í—ã—Å—à–µ–µ.' },
      { keywords: ['–æ–±—É—á–µ–Ω–∏', '–∫—É—Ä—Å', '—Ç—Ä–µ–Ω–∏–Ω–≥'],
        answer: '–î–∞, –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—É—á–µ–Ω–∏—é –∏ —Ä–∞–∑–≤–∏—Ç–∏—é.' },
    ]
  },
  sales: {
    default: '–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.',
    templates: [
      { keywords: ['–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫'],
        answer: '–î–∞, –≥–æ—Ç–æ–≤–∞.' },
      { keywords: ['–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫', '—Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω'],
        answer: '–î–∞, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.' },
      { keywords: ['–≤–∞—Ö—Ç'],
        answer: '–ù–µ—Ç.' },
      { keywords: ['–ø–æ—á–µ–º—É', '–ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç', '—Ö–æ—Ç–∏—Ç–µ'],
        answer: '–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–ª–∞–Ω –∏ —Ä–∞—Å—Ç–∏ –≤ –¥–æ—Ö–æ–¥–µ.' },
      { keywords: ['–æ–ø—ã—Ç –ø—Ä–æ–¥–∞–∂', '–ø—Ä–æ–¥–∞–≤–∞–ª', '–º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º'],
        answer: '–î–∞, –µ—Å—Ç—å –æ–ø—ã—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂. –£–º–µ—é —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å KPI.' },
      { keywords: ['–æ–ø—ã—Ç —Ä–∞–±–æ—Ç —Å –∫–ª–∏–µ–Ω—Ç', '–∫–ª–∏–µ–Ω—Ç—Å–∫'],
        answer: '–î–∞, –µ—Å—Ç—å –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏: –≤—Ö–æ–¥—è—â–∏–µ –∏ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤.' },
      { keywords: ['–∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä', '–∫–æ–ª —Ü–µ–Ω—Ç—Ä', 'call center', '–æ–ø–µ—Ä–∞—Ç–æ—Ä'],
        answer: '–î–∞, –µ—Å—Ç—å –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–∞.' },
      { keywords: ['crm', '—Å—Ä–º', '1—Å', '1c'],
        answer: '–î–∞, —Ä–∞–±–æ—Ç–∞–ª–∞ —Å CRM-—Å–∏—Å—Ç–µ–º–∞–º–∏ –∏ 1–°.' },
      { keywords: ['–ø–ª–∞–Ω', 'kpi', '–∫–∏ –ø–∏ –∞–π', '–≤—ã–ø–æ–ª–Ω–µ–Ω–∏'],
        answer: '–î–∞, —É–º–µ—é —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –ø–ª–∞–Ω–æ–≤—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º –∏ –≤—ã–ø–æ–ª–Ω—è—é –∏—Ö.' },
      { keywords: ['—Å—Ç—Ä–µ—Å—Å', '–∫–æ–Ω—Ñ–ª–∏–∫—Ç', '—Å–ª–æ–∂–Ω –∫–ª–∏–µ–Ω—Ç'],
        answer: '–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–∞, —É–º–µ—é —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å–ª–æ–∂–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.' },
      { keywords: ['–∑–∞—Ä–ø–ª–∞—Ç', '–æ–∫–ª–∞–¥', '–¥–æ—Ö–æ–¥', '–æ–∂–∏–¥–∞–Ω–∏'],
        answer: '–û–∫–ª–∞–¥ –æ—Ç 50 000 + % –æ—Ç –ø—Ä–æ–¥–∞–∂.' },
      { keywords: ['–∫–æ–≥–¥–∞', '–ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å', '–≤—ã–π—Ç–∏'],
        answer: '–ì–æ—Ç–æ–≤–∞ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏.' },
      { keywords: ['—Ñ–æ—Ä–º–∞—Ç', '–æ—Ñ–∏—Å', '—É–¥–∞–ª—ë–Ω–Ω'],
        answer: '–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é –æ—Ñ–∏—Å–Ω—ã–π –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—ã.' },
      { keywords: ['–∞–Ω–≥–ª–∏–π—Å–∫', 'english'],
        answer: '–ë–∞–∑–æ–≤—ã–π.' },
      { keywords: ['–æ–±—É—á–µ–Ω–∏', '—Ç—Ä–µ–Ω–∏–Ω–≥'],
        answer: '–î–∞, –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—É—á–µ–Ω–∏—é.' },
    ]
  },
  office: {
    default: '–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.',
    templates: [
      { keywords: ['–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫'],
        answer: '–ù–µ—Ç, –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∏ –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é.' },
      { keywords: ['–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫', '—Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω'],
        answer: '–í –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –≥–æ—Ç–æ–≤–∞.' },
      { keywords: ['–≤–∞—Ö—Ç'],
        answer: '–ù–µ—Ç.' },
      { keywords: ['–ø–æ—á–µ–º—É', '–ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç', '—Ö–æ—Ç–∏—Ç–µ'],
        answer: '–ü—Ä–∏–≤–ª–µ–∫–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ —á—ë—Ç–∫–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.' },
      { keywords: ['–æ–ø—ã—Ç —Ä–∞–±–æ—Ç', '—Å—Ç–∞–∂'],
        answer: '–ï—Å—Ç—å –æ–ø—ã—Ç –æ—Ñ–∏—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã: –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç, —Ä–∞–±–æ—Ç–∞ —Å –æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–æ–π, MS Office, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∑–∞–¥–∞—á.' },
      { keywords: ['1—Å', '1c'],
        answer: '–î–∞, –±–∞–∑–æ–≤—ã–π –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –≤ 1–°.' },
      { keywords: ['excel', 'word', 'office', '–æ—Ñ–∏—Å'],
        answer: '–£–≤–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å MS Office: Word, Excel, Outlook.' },
      { keywords: ['–æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫', '–ø—Ä–∏–Ω—Ç–µ—Ä', '—Å–∫–∞–Ω'],
        answer: '–î–∞, —É–º–µ—é —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–æ–π.' },
      { keywords: ['–¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç', '–¥–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤'],
        answer: '–î–∞, –µ—Å—Ç—å –æ–ø—ã—Ç –≤–µ–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞ –∏ –¥–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.' },
      { keywords: ['–∑–∞—Ä–ø–ª–∞—Ç', '–æ–∫–ª–∞–¥', '–¥–æ—Ö–æ–¥', '–æ–∂–∏–¥–∞–Ω–∏'],
        answer: '–û—Ç 60 000 —Ä—É–±–ª–µ–π.' },
      { keywords: ['–∫–æ–≥–¥–∞', '–ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å', '–≤—ã–π—Ç–∏'],
        answer: '–ì–æ—Ç–æ–≤–∞ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 2 –Ω–µ–¥–µ–ª—å.' },
      { keywords: ['—Ñ–æ—Ä–º–∞—Ç', '–æ—Ñ–∏—Å', '—É–¥–∞–ª—ë–Ω–Ω'],
        answer: '–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –æ—Ñ–∏—Å–Ω—ã–π –∏–ª–∏ –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.' },
      { keywords: ['–∞–Ω–≥–ª–∏–π—Å–∫', 'english'],
        answer: '–ë–∞–∑–æ–≤—ã–π.' },
      { keywords: ['–∞–≤—Ç–æ–º–æ–±–∏–ª', '–ø—Ä–∞–≤–∞'],
        answer: '–ù–µ—Ç.' },
      { keywords: ['–æ–±—Ä–∞–∑–æ–≤–∞–Ω'],
        answer: '–í—ã—Å—à–µ–µ.' },
    ]
  },
  remote: {
    default: '–ì–æ—Ç–æ–≤–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏.',
    templates: [
      { keywords: ['–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫'],
        answer: '–ù–µ—Ç, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é —É–¥–∞–ª—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.' },
      { keywords: ['–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫', '—Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω'],
        answer: '–î–∞, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≥–æ—Ç–æ–≤–∞.' },
      { keywords: ['–≤–∞—Ö—Ç'],
        answer: '–ù–µ—Ç.' },
      { keywords: ['–ø–æ—á–µ–º—É', '–ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç', '—Ö–æ—Ç–∏—Ç–µ'],
        answer: '–ü—Ä–∏–≤–ª–µ–∫–∞–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤ IT-—Å—Ñ–µ—Ä–µ.' },
      { keywords: ['–æ–ø—ã—Ç —Ä–∞–±–æ—Ç', '—Å—Ç–∞–∂'],
        answer: '–ï—Å—Ç—å –æ–ø—ã—Ç —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –£–º–µ—é —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å.' },
      { keywords: ['–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω', '–∫–æ–º–ø—å—é—Ç–µ—Ä', '–ø–∫'],
        answer: '–î–∞, –µ—Å—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.' },
      { keywords: ['—á–∞—Å–æ–≤–æ–π –ø–æ—è—Å', '–º—Å–∫', '–º–æ—Å–∫–æ–≤'],
        answer: '–†–∞–±–æ—Ç–∞—é –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ú–°–ö+0.' },
      { keywords: ['english', '–∞–Ω–≥–ª–∏–π—Å–∫'],
        answer: 'Pre-Intermediate / –ë–∞–∑–æ–≤—ã–π.' },
      { keywords: ['python', 'java', 'sql', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω'],
        answer: '–î–∞, –µ—Å—Ç—å –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è. –ì–æ—Ç–æ–≤–∞ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è.' },
      { keywords: ['google', '—Ç–∞–±–ª–∏—Ü', 'notion', 'jira', 'confluence', 'trello'],
        answer: '–î–∞, —Ä–∞–±–æ—Ç–∞–ª–∞ —Å Google-—Å–µ—Ä–≤–∏—Å–∞–º–∏, Notion, Trello.' },
      { keywords: ['–∑–∞—Ä–ø–ª–∞—Ç', '–æ–∫–ª–∞–¥', '–¥–æ—Ö–æ–¥', '–æ–∂–∏–¥–∞–Ω–∏'],
        answer: '–û—Ç 70 000 —Ä—É–±–ª–µ–π.' },
      { keywords: ['–∫–æ–≥–¥–∞', '–ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å', '–≤—ã–π—Ç–∏'],
        answer: '–ì–æ—Ç–æ–≤–∞ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏.' },
      { keywords: ['—Ñ–æ—Ä–º–∞—Ç', '—É–¥–∞–ª—ë–Ω–Ω', '–≥–∏–±—Ä–∏–¥'],
        answer: '–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—ë–Ω–Ω—ã–π –∏–ª–∏ –≥–∏–±—Ä–∏–¥–Ω—ã–π.' },
      { keywords: ['–æ–±—É—á–µ–Ω–∏', '–∫—É—Ä—Å'],
        answer: '–î–∞, –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—É—á–µ–Ω–∏—é –∑–∞ —Å—á—ë—Ç –∫–æ–º–ø–∞–Ω–∏–∏.' },
    ]
  }
};

function qLoadPreset(name) {
  const preset = Q_PRESETS[name];
  if (!preset) return;
  if (!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ—Å–µ—Ç "${name}"? –¢–µ–∫—É—â–∏–µ —à–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`)) return;
  qRenderTemplates(preset.templates);
  const defEl = document.getElementById('q-default-answer');
  if (defEl) defEl.value = preset.default;
  const st = document.getElementById('q-status');
  st.textContent = `‚úÖ –ü—Ä–µ—Å–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω (${preset.templates.length} —à–∞–±–ª–æ–Ω–æ–≤). –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.`;
  st.style.color = 'var(--yellow)';
  setTimeout(() => { st.textContent = ''; st.style.color = ''; }, 6000);
  document.getElementById('q-templates-list')?.scrollIntoView({behavior:'smooth'});
}

function qAddTemplate() {
  const templates = qReadTemplates();
  templates.push({keywords: [], answer: ''});
  qRenderTemplates(templates);
  // Scroll to new row
  document.getElementById('q-templates-list').lastElementChild?.scrollIntoView({behavior:'smooth'});
}

function qDelTemplate(idx) {
  const templates = qReadTemplates();
  templates.splice(idx, 1);
  qRenderTemplates(templates);
}

function qReadTemplates() {
  const rows = document.querySelectorAll('#q-templates-list .q-template-row');
  const result = [];
  rows.forEach(row => {
    const kw = row.querySelector('.q-keywords-input')?.value || '';
    const ans = row.querySelector('.q-answer-input')?.value || '';
    result.push({
      keywords: kw.split(',').map(s => s.trim()).filter(Boolean),
      answer: ans
    });
  });
  return result;
}

function qSave() {
  const templates = qReadTemplates();
  const defaultAnswer = document.getElementById('q-default-answer')?.value || '';
  sendCmd({type: 'set_questionnaire', templates, default_answer: defaultAnswer});
  const st = document.getElementById('q-status');
  st.textContent = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${templates.length} —à–∞–±–ª–æ–Ω–æ–≤`;
  setTimeout(() => { st.textContent = ''; }, 3000);
}

function qSyncFromSnapshot(snap) {
  if (!snap || !snap.config) return;
  const templates = snap.config.questionnaire_templates || [];
  const defaultAns = snap.config.questionnaire_default_answer || '';
  qRenderTemplates(templates);
  const el = document.getElementById('q-default-answer');
  if (el && !el._userEdited) el.value = defaultAns;
}

// Mark as user-edited so we don't override on next snapshot
document.addEventListener('DOMContentLoaded', () => {
  const el = document.getElementById('q-default-answer');
  if (el) el.addEventListener('input', () => { el._userEdited = true; });
});

// ‚îÄ‚îÄ Dark confirm dialog ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showConfirm(msg, okLabel = null, cancelLabel = null) {
  if (okLabel === null) okLabel = t('confirm_delete');
  if (cancelLabel === null) cancelLabel = t('confirm_cancel');
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.innerHTML = `
      <div class="confirm-box">
        <p>${msg}</p>
        <div class="confirm-btns">
          <button class="confirm-cancel">${cancelLabel}</button>
          <button class="confirm-ok">${okLabel}</button>
        </div>
      </div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('.confirm-ok').onclick = () => { document.body.removeChild(overlay); resolve(true); };
    overlay.querySelector('.confirm-cancel').onclick = () => { document.body.removeChild(overlay); resolve(false); };
    overlay.onclick = (e) => { if (e.target === overlay) { document.body.removeChild(overlay); resolve(false); } };
  });
}

// ‚îÄ‚îÄ Compact card mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleCompact(idx) {
  if (State.compactCards.has(idx)) State.compactCards.delete(idx);
  else State.compactCards.add(idx);
  const card = document.getElementById('card-' + idx);
  if (!card) return;
  if (State.compactCards.has(idx)) {
    card.classList.add('compact');
    card.querySelector('.compact-btn').textContent = '‚¨ú';
    card.querySelector('.compact-btn').title = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
  } else {
    card.classList.remove('compact');
    card.querySelector('.compact-btn').textContent = '‚¨ú';
    card.querySelector('.compact-btn').title = '–°–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
  }
}

// ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV(headers, rows, filename) {
  const lines = [
    headers.map(h => '"' + h.replace(/"/g, '""') + '"').join(','),
    ...rows.map(r => r.map(v => '"' + String(v ?? '').replace(/"/g, '""') + '"').join(','))
  ];
  const blob = new Blob(['\uFEFF' + lines.join('\n')], {type: 'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 5000);
}

function exportAppliedCSV() {
  if (!AppliedState.all.length) return;
  const headers = ['–î–∞—Ç–∞', '–ê–∫–∫–∞—É–Ω—Ç', 'ID –≤–∞–∫–∞–Ω—Å–∏–∏', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–æ–º–ø–∞–Ω–∏—è', '–ó–∞—Ä–ø–ª–∞—Ç–∞ –æ—Ç', '–ó–∞—Ä–ø–ª–∞—Ç–∞ –¥–æ', '–°—Å—ã–ª–∫–∞'];
  const rows = AppliedState.all.map(i => [
    i.at ? new Date(i.at).toLocaleString('ru-RU') : '',
    i.account || '',
    i.vacancy_id || '',
    i.title || '',
    i.company || '',
    i.salary_from || '',
    i.salary_to || '',
    i.url || `https://hh.ru/vacancy/${i.vacancy_id}`,
  ]);
  exportCSV(headers, rows, `hh_applied_${new Date().toISOString().slice(0,10)}.csv`);
}

function exportDbCSV() {
  if (!DBState.all.length) return;
  const STATUS_LABELS = {sent: '–û—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å', test_passed: '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω', test_pending: '–ù–µ –ø—Ä–æ–π–¥–µ–Ω'};
  const headers = ['–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞', 'ID –≤–∞–∫–∞–Ω—Å–∏–∏', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–æ–º–ø–∞–Ω–∏—è', '–ê–∫–∫–∞—É–Ω—Ç—ã', '–°—Å—ã–ª–∫–∞'];
  const rows = DBState.all.map(i => [
    STATUS_LABELS[i.status] || i.status,
    i.at ? new Date(i.at).toLocaleString('ru-RU') : '',
    i.vacancy_id || '',
    i.title || '',
    i.company || '',
    (i.applied_by || []).join('; '),
    `https://hh.ru/vacancy/${i.vacancy_id}`,
  ]);
  exportCSV(headers, rows, `hh_db_${new Date().toISOString().slice(0,10)}.csv`);
}

// ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TAB_KEYS = {'1':'main','2':'log','3':'applied','4':'tests','5':'db','6':'hh','7':'views','8':'apply','9':'settings'};

document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (e.ctrlKey || e.metaKey || e.altKey) return;
  if (e.key in TAB_KEYS) {
    const tabEl = document.querySelector(`.tab[data-tab="${TAB_KEYS[e.key]}"]`);
    if (tabEl) tabEl.click();
    return;
  }
  if (e.key === 'p' || e.key === 'P') { sendCmd({type: 'pause_toggle'}); return; }
  if (e.key === '?' || e.key === '/') { toggleShortcutsHelp(); return; }
  if (e.key === 'Escape') { closeShortcutsHelp(); }
});

function toggleShortcutsHelp() {
  if (document.getElementById('shortcuts-overlay')) { closeShortcutsHelp(); return; }
  const el = document.createElement('div');
  el.id = 'shortcuts-overlay';
  el.className = 'shortcuts-overlay';
  el.innerHTML = `
    <div class="shortcuts-box">
      <h3>${t('shortcuts_title')}</h3>
      <table>
        <tr><td>1‚Äì9</td><td>${t('shortcuts_tabs')}</td></tr>
        <tr><td>P</td><td>${t('shortcuts_pause')}</td></tr>
        <tr><td>? / /</td><td>${t('shortcuts_help')}</td></tr>
        <tr><td>Esc</td><td>${t('shortcuts_esc')}</td></tr>
      </table>
      <div style="margin-top:14px;text-align:right">
        <button class="confirm-cancel" onclick="closeShortcutsHelp()">${t('btn_close')}</button>
      </div>
    </div>`;
  el.onclick = e => { if (e.target === el) closeShortcutsHelp(); };
  document.body.appendChild(el);
}
function closeShortcutsHelp() {
  const el = document.getElementById('shortcuts-overlay');
  if (el) el.remove();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
buildSettings();
connect();
// Set default system prompt for LLM if not yet configured
const spEl = document.getElementById('llm-system-prompt');
if (spEl && !spEl.value) spEl.value = '–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è —Ä–∞–±–æ—Ç—ã. –û—Ç–≤–µ—á–∞–π –≤–µ–∂–ª–∏–≤–æ –∏ –∫—Ä–∞—Ç–∫–æ (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç HR –∏ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π. –ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥. –°–æ–≥–ª–∞—à–∞–π—Å—è –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ —É—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏.';
document.getElementById('lang-btn').textContent = lang.toUpperCase();
// Restore last active tab from localStorage
try {
  const savedTab = localStorage.getItem('hh-tab');
  if (savedTab) {
    const tabEl = document.querySelector(`.tab[data-tab="${savedTab}"]`);
    if (tabEl) tabEl.click();
  }
} catch(e) {}
// Request browser notification permission
if ('Notification' in window && Notification.permission === 'default') {
  setTimeout(() => Notification.requestPermission(), 3000);
}

// Auto-load JSON editors on first open
document.getElementById('json-config-details').addEventListener('toggle', function() {
  if (this.open && !document.getElementById('json-config-ta').value.trim())
    jsonConfigLoad(this.querySelector('button'));
});
document.getElementById('json-accounts-details').addEventListener('toggle', function() {
  if (this.open && !document.getElementById('json-accounts-ta').value.trim())
    jsonAccountsLoad(this.querySelector('button'));
});
</script>
</body>
</html>
